This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.claude/
  settings.local.json
docs/
  abilities-api.md
  integration-guide.md
  php-api.md
  rest-api.md
includes/
  class-abilities.php
  class-context-packet-builder.php
  class-hooks.php
  class-lint-checker.php
  class-post-type.php
  class-rest-controller.php
src/
  commands/
    index.js
  components/
    blocks-panel/
      index.js
      style.scss
    controls/
      repeater-control/
        index.js
        style.scss
    guidelines-page/
      index.js
      style.scss
    guidelines-screen/
      empty-state.js
      header.js
      index.js
      preview-canvas.js
      sidebar.js
      style.scss
    history/
      index.js
      style.scss
    import-export/
      index.js
      style.scss
    library-panel/
      index.js
      style.scss
    panels/
      brand-context.js
      copy-rules.js
      images.js
      notes.js
      vocabulary.js
      voice-tone.js
    playground/
      context-preview.js
      index.js
      lint-panel.js
      style.scss
  store/
    actions.js
    index.js
    reducer.js
    resolvers.js
    selectors.js
  commands-loader.js
  index.js
  style.scss
.gitignore
blueprint.json
content-guidelines.php
package.json
README.md
webpack.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".claude/settings.local.json">
{
  "permissions": {
    "allow": [
      "Bash(pnpm install)",
      "Bash(pnpm run build:*)",
      "Bash(pnpm add:*)",
      "Bash(npx @wp-playground/cli server:*)",
      "Bash(npx @wp-now/wp-now start:*)",
      "Bash(npx @wp-playground/cli:*)",
      "Bash(pnpm dlx:*)",
      "Bash(cat:*)",
      "Bash(npx @wp-playground/cli@latest server:*)",
      "Bash(rm:*)",
      "WebSearch",
      "Bash(gh api:*)",
      "Bash(gh search code:*)",
      "Bash(npm view:*)",
      "WebFetch(domain:developer.wordpress.org)",
      "WebFetch(domain:make.wordpress.org)",
      "Bash(git init:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(gh auth status:*)",
      "Bash(gh repo create:*)",
      "Bash(git push:*)",
      "Bash(php -l:*)"
    ]
  }
}
</file>

<file path="docs/abilities-api.md">
# Abilities API Reference (WordPress 6.9+)

The Content Guidelines plugin registers abilities with the WordPress 6.9 Abilities API, enabling AI assistants and external services to discover and execute guidelines-related actions.

## Overview

The Abilities API provides a standardized way for AI systems (like ChatGPT, Claude, Gemini) to interact with WordPress through the Model Context Protocol (MCP). When paired with an MCP adapter plugin, these abilities become available to AI assistants.

## Available Abilities

All abilities are registered under the `content-guidelines` category.

### content-guidelines/get-guidelines

Retrieve the site content guidelines.

**Input:**
```json
{
  "use": "active"  // or "draft"
}
```

**Output:**
```json
{
  "active": { /* guidelines object */ },
  "draft": null,
  "has_draft": false,
  "post_id": 123,
  "updated_at": "2025-01-15T10:30:00",
  "revision_count": 5
}
```

### content-guidelines/get-context-packet

Get a task-specific context packet formatted for LLM consumption.

**Input:**
```json
{
  "task": "writing",      // writing, headline, cta, image, coach
  "post_id": 123,         // optional
  "use": "active",        // active or draft
  "max_chars": 2000       // 100-10000
}
```

**Output:**
```json
{
  "packet_text": "## SITE CONTENT GUIDELINES\n\n...",
  "packet_structured": { /* relevant sections */ },
  "guidelines_id": 123,
  "revision_id": 456,
  "updated_at": "2025-01-15T10:30:00"
}
```

### content-guidelines/update-draft

Save changes to draft guidelines without publishing.

**Input:**
```json
{
  "guidelines": {
    "brand_context": {
      "site_description": "Updated description",
      "audience": "Our target readers",
      "primary_goal": "inform"
    },
    "voice_tone": {
      "tone_traits": ["friendly", "professional"],
      "pov": "we_you",
      "readability": "general"
    }
  }
}
```

**Output:**
```json
{
  "success": true,
  "message": "Draft saved."
}
```

### content-guidelines/publish-draft

Publish the current draft guidelines.

**Input:** None required

**Output:**
```json
{
  "success": true,
  "post_id": 123,
  "message": "Guidelines published."
}
```

### content-guidelines/discard-draft

Discard all unpublished draft changes.

**Input:** None required

**Output:**
```json
{
  "success": true,
  "message": "Draft discarded."
}
```

### content-guidelines/run-test

Test guidelines against fixture content with lint checks and optional AI generation.

**Input:**
```json
{
  "task": "rewrite_intro",    // rewrite_intro, generate_headlines, write_cta
  "fixture_post_id": 789,     // required
  "use": "draft",
  "compare": false,
  "extra_instructions": ""
}
```

**Output:**
```json
{
  "lint_results": {
    "issues": [],
    "issue_count": 0
  },
  "context_packet": { /* packet data */ },
  "fixture": {
    "title": "Post Title",
    "excerpt": "Post excerpt..."
  },
  "ai_result": null,
  "ai_available": false
}
```

### content-guidelines/check-lint

Run vocabulary and copy rule lint checks against content.

**Input:**
```json
{
  "content": "Text to check against guidelines...",
  "use": "active"
}
```

**Output:**
```json
{
  "issues": [
    {
      "type": "vocabulary_avoid",
      "term": "green",
      "message": "Avoid using 'green'",
      "suggestion": "Use 'sustainable' instead"
    }
  ],
  "issue_count": 1,
  "passed": false
}
```

## Using Abilities in PHP

```php
// Check if Abilities API is available (WordPress 6.9+)
if ( function_exists( 'wp_get_ability' ) ) {

    // Get the ability
    $ability = wp_get_ability( 'content-guidelines/get-context-packet' );

    if ( $ability ) {
        // Execute the ability
        $result = $ability->execute( array(
            'task'      => 'headline',
            'max_chars' => 1500,
        ) );

        if ( ! is_wp_error( $result ) ) {
            $packet_text = $result['packet_text'];
        }
    }
}
```

## Using Abilities via REST API

All abilities are exposed via the WordPress Abilities REST API:

```bash
# List all content-guidelines abilities
curl -X GET \
  'https://example.com/wp-json/wp-abilities/v1/abilities?category=content-guidelines' \
  -H 'Authorization: Basic BASE64_ENCODED_APP_PASSWORD'

# Execute an ability
curl -X POST \
  'https://example.com/wp-json/wp-abilities/v1/abilities/content-guidelines/get-context-packet/run' \
  -H 'Authorization: Basic BASE64_ENCODED_APP_PASSWORD' \
  -H 'Content-Type: application/json' \
  -d '{"task":"writing","max_chars":2000}'
```

## MCP Integration

When using the WordPress MCP Adapter plugin, these abilities become available to AI assistants as MCP tools. The AI can:

1. **Discover** available abilities through the MCP server
2. **Execute** abilities with validated input
3. **Receive** structured output

Example AI interaction:

```
User: "What are the content guidelines for this WordPress site?"

AI: [Executes content-guidelines/get-guidelines ability]
    "Based on the site guidelines, the tone should be friendly and
    encouraging, written from a 'we' perspective speaking to 'you'..."
```

## Permissions

All abilities require the `edit_theme_options` capability, which is typically granted to Administrators.

| Ability | Permission |
|---------|------------|
| get-guidelines | edit_theme_options |
| get-context-packet | edit_theme_options |
| update-draft | edit_theme_options |
| publish-draft | edit_theme_options |
| discard-draft | edit_theme_options |
| run-test | edit_theme_options |
| check-lint | edit_theme_options |

## Backward Compatibility

The Abilities API is only available in WordPress 6.9+. The plugin gracefully degrades on older versions:

```php
// In the plugin initialization
public static function init() {
    // Only register if Abilities API is available
    if ( ! function_exists( 'wp_register_ability' ) ) {
        return;
    }

    // Register abilities...
}
```

For older WordPress versions, use the [PHP API](./php-api.md) or [REST API](./rest-api.md) directly.
</file>

<file path="docs/integration-guide.md">
# Integration Guide

This guide explains how to integrate Content Guidelines with AI providers and other WordPress features.

## For AI Provider Plugins

Content Guidelines provides the storage, UI, and APIs. AI providers supply the intelligence. Here's how to integrate:

### 1. Register as an AI Provider

Tell Content Guidelines that your plugin can handle AI tasks:

```php
add_filter( 'wp_content_guidelines_has_ai_provider', '__return_true' );
```

### 2. Handle Playground Tests

Implement the playground test filter to generate AI-powered results:

```php
add_filter( 'wp_content_guidelines_run_playground_test', function( $result, $request ) {
    // $request contains:
    // - task: 'rewrite_intro', 'generate_headlines', 'write_cta'
    // - fixture_content: The text to work with
    // - guidelines: Full guidelines array
    // - context_packet: Pre-formatted packet with packet_text
    // - extra_instructions: User's additional instructions

    $prompt = $request['context_packet']['packet_text'] . "\n\n";

    switch ( $request['task'] ) {
        case 'rewrite_intro':
            $prompt .= "Rewrite this introduction:\n\n" . $request['fixture_content'];
            break;
        case 'generate_headlines':
            $prompt .= "Generate 5 headlines for:\n\n" . $request['fixture_content'];
            break;
        case 'write_cta':
            $prompt .= "Write a call-to-action for:\n\n" . $request['fixture_content'];
            break;
    }

    if ( ! empty( $request['extra_instructions'] ) ) {
        $prompt .= "\n\nAdditional instructions: " . $request['extra_instructions'];
    }

    // Call your AI API
    $ai_response = my_ai_api_call( $prompt );

    return array(
        'output'       => $ai_response['text'],
        'alternatives' => $ai_response['alternatives'] ?? array(),
        'metadata'     => array(
            'model'  => 'gpt-4',
            'tokens' => $ai_response['usage']['total_tokens'],
        ),
    );
}, 10, 2 );
```

### 3. Handle Guidelines Generation (Optional)

Generate initial guidelines from site content:

```php
add_filter( 'wp_content_guidelines_generate_draft', function( $draft, $site_context, $args ) {
    // $site_context contains:
    // - site_title: The site name
    // - tagline: Site description/tagline
    // - source_posts: Array of recent post content

    // $args contains:
    // - goal: User's primary goal
    // - constraints: User-specified constraints

    $prompt = "Analyze this website and generate content guidelines:\n\n";
    $prompt .= "Site: {$site_context['site_title']}\n";
    $prompt .= "Tagline: {$site_context['tagline']}\n\n";
    $prompt .= "Sample content:\n" . implode( "\n\n", $site_context['source_posts'] );

    // Call your AI API
    $generated = my_ai_api_call( $prompt );

    // Return structured guidelines
    return array(
        'brand_context' => array(
            'site_description' => $generated['description'],
            'audience'         => $generated['audience'],
            'primary_goal'     => $args['goal'],
        ),
        'voice_tone' => array(
            'tone_traits'  => $generated['tone_traits'],
            'pov'          => $generated['pov'],
            'readability'  => $generated['readability'],
        ),
        'copy_rules' => array(
            'dos'   => $generated['dos'],
            'donts' => $generated['donts'],
        ),
        // ... etc
    );
}, 10, 3 );
```

## For Theme/Plugin Developers

### Using Guidelines in Your AI Features

```php
// Get the context packet for your AI prompt
$packet = wp_get_content_guidelines_packet( array(
    'task' => 'writing',
) );

// Build your prompt with guidelines context
$system_prompt = "You are a writing assistant for this website.\n\n";
$system_prompt .= $packet['packet_text'];

// Use in your AI call
$response = my_ai_call( array(
    'system' => $system_prompt,
    'user'   => $user_input,
) );
```

### Displaying "Using Guidelines" Status

Show users when guidelines are being applied:

```php
function render_guidelines_badge() {
    $guidelines = wp_get_content_guidelines();

    if ( ! empty( $guidelines ) ) {
        echo '<span class="guidelines-badge">Using: Site Guidelines</span>';
    }
}
```

### Block-Specific Guidelines

Access guidelines for specific block types:

```php
$guidelines = wp_get_content_guidelines();

// Get paragraph block guidelines
$paragraph_rules = $guidelines['blocks']['core/paragraph'] ?? array();

if ( ! empty( $paragraph_rules['copy_rules']['dos'] ) ) {
    // Apply paragraph-specific rules
}
```

## For JavaScript/Block Editor

### Reading Guidelines in the Editor

```javascript
import { useSelect } from '@wordpress/data';
import apiFetch from '@wordpress/api-fetch';

function useContentGuidelines( task = 'writing' ) {
    const [ packet, setPacket ] = useState( null );

    useEffect( () => {
        apiFetch( {
            path: `/wp/v2/content-guidelines/packet?task=${ task }`,
        } ).then( setPacket );
    }, [ task ] );

    return packet;
}

// In your component
function MyAIFeature() {
    const guidelines = useContentGuidelines( 'headline' );

    if ( ! guidelines ) {
        return <Spinner />;
    }

    return (
        <div>
            <p>Guidelines loaded: { guidelines.packet_text.length } chars</p>
            { /* Use guidelines.packet_text in your AI prompt */ }
        </div>
    );
}
```

### Registering Commands (WordPress 6.9+)

Add your own Command Palette commands:

```javascript
import { useCommand } from '@wordpress/commands';

function MyPluginCommands() {
    useCommand( {
        name: 'my-plugin/generate-with-guidelines',
        label: 'Generate Content with Guidelines',
        icon: sparkles,
        callback: async ( { close } ) => {
            const packet = await wp.apiFetch( {
                path: '/wp/v2/content-guidelines/packet?task=writing',
            } );

            // Use packet in your AI generation
            myAIGenerate( packet.packet_text );
            close();
        },
    } );

    return null;
}
```

## API Summary

| Method | Use Case |
|--------|----------|
| `wp_get_content_guidelines_packet()` | Get formatted context for AI prompts |
| `wp_get_content_guidelines()` | Get raw guidelines data |
| REST `/wp/v2/content-guidelines/packet` | JavaScript/external access to packets |
| Abilities API | AI assistant integration (WP 6.9+) |
| Filter hooks | Provide AI generation capability |

## Best Practices

1. **Always use `packet_text`** for AI prompts - it's pre-formatted and optimized
2. **Respect `max_chars`** to stay within token budgets
3. **Use task-specific packets** - they only include relevant sections
4. **Cache when appropriate** - guidelines don't change frequently
5. **Check for empty guidelines** - gracefully handle sites without guidelines
6. **Show attribution** - let users know when guidelines are being applied

## Testing Your Integration

1. Install Content Guidelines plugin
2. Create some test guidelines via Appearance > Guidelines
3. Publish the guidelines
4. Test your integration:
   - `wp_get_content_guidelines_packet()` returns data
   - Your AI features respect the guidelines
   - Playground tests work with your provider

## Example: Complete AI Provider Plugin

```php
<?php
/**
 * Plugin Name: My AI Provider for Content Guidelines
 */

// Register as provider
add_filter( 'wp_content_guidelines_has_ai_provider', '__return_true' );

// Handle playground tests
add_filter( 'wp_content_guidelines_run_playground_test', function( $result, $request ) {
    $response = wp_remote_post( 'https://api.myai.com/generate', array(
        'headers' => array(
            'Authorization' => 'Bearer ' . MY_AI_API_KEY,
            'Content-Type'  => 'application/json',
        ),
        'body' => wp_json_encode( array(
            'prompt' => $request['context_packet']['packet_text'] . "\n\n" .
                        "Task: {$request['task']}\n\n" .
                        $request['fixture_content'],
        ) ),
    ) );

    if ( is_wp_error( $response ) ) {
        return null; // Fall back to lint-only
    }

    $body = json_decode( wp_remote_retrieve_body( $response ), true );

    return array(
        'output'   => $body['text'],
        'metadata' => array( 'model' => $body['model'] ),
    );
}, 10, 2 );
```
</file>

<file path="docs/php-api.md">
# PHP API Reference

The Content Guidelines plugin provides simple PHP functions to access guidelines from anywhere in WordPress.

## Quick Start

```php
// Get the formatted context packet for AI consumption
$packet = wp_get_content_guidelines_packet();

// Use the packet text in your AI prompt
$prompt = $packet['packet_text'] . "\n\nNow write a headline for: " . $post_title;
```

## Functions

### wp_get_content_guidelines_packet()

Get a task-specific context packet formatted for LLM consumption.

```php
$packet = wp_get_content_guidelines_packet( array(
    'task'       => 'writing',       // Task type (see below)
    'post_id'    => null,            // Optional: context post ID
    'use'        => 'active',        // 'active' or 'draft'
    'max_chars'  => 2000,            // Maximum characters for packet_text
    'block_name' => 'core/button',   // Optional: include block-specific rules
) );
```

**Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `task` | string | `'writing'` | Task type: `writing`, `headline`, `cta`, `image`, `coach` |
| `post_id` | int | `null` | Post ID for context-specific overrides |
| `use` | string | `'active'` | Which guidelines version: `active` or `draft` |
| `max_chars` | int | `2000` | Maximum characters for the formatted text |
| `block_name` | string | `null` | Block name to include block-specific rules (e.g., `core/paragraph`) |

**Returns:**

```php
array(
    'packet_text'       => '## SITE CONTENT GUIDELINES\n\nAbout this site: ...',
    'packet_structured' => array(
        'brand_context' => array( ... ),
        'voice_tone'    => array( ... ),
        // ... task-relevant sections only
    ),
    'guidelines_id'     => 123,        // Post ID of guidelines
    'revision_id'       => 456,        // Current revision ID
    'updated_at'        => '2025-01-15T10:30:00+00:00',
)
```

**Task Types:**

Each task type returns only the relevant guideline sections:

| Task | Included Sections |
|------|-------------------|
| `writing` | brand_context, voice_tone, copy_rules, vocabulary, notes |
| `headline` | voice_tone, copy_rules, vocabulary |
| `cta` | brand_context, copy_rules, vocabulary |
| `image` | brand_context, image_style |
| `coach` | voice_tone, copy_rules, vocabulary |

### wp_get_content_guidelines_for_post()

**Primary API for agents working with post content.** Analyzes the blocks in a post and returns a context packet with both site-level and block-specific guidelines merged.

```php
$result = wp_get_content_guidelines_for_post( $post_id, array(
    'task' => 'writing',
    'use'  => 'active',
) );
```

**Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `post` | int\|WP_Post | required | Post ID or post object |
| `task` | string | `'writing'` | Task type for packet generation |
| `use` | string | `'active'` | Which guidelines version: `active` or `draft` |

**Returns:**

```php
array(
    'packet_text'       => '## SITE CONTENT GUIDELINES\n...\n### Block-Specific Rules\n...',
    'packet_structured' => array( ... ),
    'blocks_in_post'    => array( 'core/paragraph', 'core/heading', 'core/button' ),
    'block_guidelines'  => array(
        'core/button' => array(
            'copy_rules' => array( 'dos' => array(...), 'donts' => array(...) ),
            'notes' => 'Keep CTA text under 5 words',
        ),
    ),
    'guidelines_id'     => 123,
    'updated_at'        => '2025-01-15T10:30:00+00:00',
)
```

### wp_get_block_guidelines()

Get guidelines for specific block types. Useful when you know which blocks you're working with.

```php
// Single block
$result = wp_get_block_guidelines( 'core/button' );

// Multiple blocks
$result = wp_get_block_guidelines( array(
    'core/heading',
    'core/paragraph',
    'core/button',
) );
```

**Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `block_names` | string\|array | required | Block name(s) to get guidelines for |
| `task` | string | `'writing'` | Task type for packet generation |
| `use` | string | `'active'` | Which guidelines version: `active` or `draft` |

**Returns:**

```php
array(
    'site_rules' => array(
        'dos'   => array( 'Use active voice', ... ),
        'donts' => array( 'Avoid jargon', ... ),
    ),
    'blocks' => array(
        'core/heading'   => null,  // No custom rules
        'core/paragraph' => array( 'copy_rules' => ... ),
        'core/button'    => array( 'copy_rules' => ..., 'notes' => ... ),
    ),
    'packet_text'   => '## CONTENT GUIDELINES\n...',
    'guidelines_id' => 123,
)
```

### wp_get_content_guidelines()

Get the raw guidelines data.

```php
$guidelines = wp_get_content_guidelines( 'active' ); // or 'draft'
```

**Returns:** The full guidelines array or `null` if not set.

```php
array(
    'version' => 1,
    'brand_context' => array(
        'site_description' => 'A blog about sustainable living',
        'audience' => 'Environmentally conscious millennials',
        'primary_goal' => 'inform',
    ),
    'voice_tone' => array(
        'tone_traits' => array( 'friendly', 'encouraging' ),
        'pov' => 'we_you',
        'readability' => 'general',
    ),
    'copy_rules' => array(
        'dos' => array( 'Use active voice', 'Include actionable tips' ),
        'donts' => array( 'Avoid jargon', 'Never shame readers' ),
        'formatting' => array( 'h2s', 'bullets', 'short_paragraphs' ),
    ),
    'vocabulary' => array(
        'prefer' => array(
            array( 'term' => 'sustainable', 'note' => 'Our core value' ),
        ),
        'avoid' => array(
            array( 'term' => 'green', 'note' => 'Too vague' ),
        ),
    ),
    'image_style' => array(
        'dos' => array( 'Use natural lighting', 'Show real people' ),
        'donts' => array( 'No stock photos', 'Avoid filters' ),
        'text_policy' => 'never',
    ),
    'notes' => 'Additional context for AI...',
)
```

## Usage Examples

### Example 1: Agent Working with a Blog Post

This is the recommended pattern for AI agents that need to work with post content:

```php
/**
 * An agent improving a blog post with full guidelines context.
 */
function agent_improve_post( $post_id, $llm_client ) {
    // Get guidelines with automatic block analysis
    $result = wp_get_content_guidelines_for_post( $post_id );

    // The packet_text includes both site-level AND block-specific rules
    // for any blocks that exist in the post
    $system_prompt = <<<PROMPT
You are an editorial assistant. Follow these content guidelines strictly:

{$result['packet_text']}

This post contains these block types: {implode(', ', $result['blocks_in_post'])}
PROMPT;

    $post = get_post( $post_id );

    return $llm_client->complete( array(
        'system' => $system_prompt,
        'user'   => "Please review and improve this content:\n\n" . $post->post_content,
    ) );
}
```

### Example 2: Generate a Headline

```php
function generate_headline_with_guidelines( $post_id ) {
    $post = get_post( $post_id );

    // Get guidelines formatted for headline generation
    $packet = wp_get_content_guidelines_packet( array(
        'task'    => 'headline',
        'post_id' => $post_id,
    ) );

    // Build your AI prompt
    $prompt = $packet['packet_text'] . "\n\n";
    $prompt .= "Generate 5 headline options for this article:\n\n";
    $prompt .= $post->post_title . "\n\n";
    $prompt .= wp_trim_words( $post->post_content, 100 );

    // Send to your AI provider
    return my_ai_provider_generate( $prompt );
}
```

### Example 2: Check if Guidelines Exist

```php
function has_site_guidelines() {
    $guidelines = wp_get_content_guidelines();
    return ! empty( $guidelines );
}
```

### Example 3: Get Vocabulary for Linting

```php
function get_words_to_avoid() {
    $guidelines = wp_get_content_guidelines();

    if ( empty( $guidelines['vocabulary']['avoid'] ) ) {
        return array();
    }

    return array_map( function( $item ) {
        return $item['term'];
    }, $guidelines['vocabulary']['avoid'] );
}
```

### Example 4: Inject Guidelines into Block Editor

```php
add_action( 'enqueue_block_editor_assets', function() {
    $packet = wp_get_content_guidelines_packet( array(
        'task' => 'writing',
    ) );

    wp_add_inline_script(
        'my-ai-plugin',
        sprintf(
            'window.siteGuidelines = %s;',
            wp_json_encode( $packet )
        ),
        'before'
    );
} );
```

## Checking Availability

The functions are available after the `plugins_loaded` hook:

```php
add_action( 'plugins_loaded', function() {
    if ( function_exists( 'wp_get_content_guidelines_packet' ) ) {
        // Content Guidelines plugin is active
    }
} );
```

For WordPress 6.9+ with the Abilities API:

```php
if ( function_exists( 'wp_get_ability' ) ) {
    $ability = wp_get_ability( 'content-guidelines/get-context-packet' );
    if ( $ability ) {
        $result = $ability->execute( array( 'task' => 'writing' ) );
    }
}
```

## Performance Notes

- Guidelines are cached in the post meta and only fetched once per request
- The `packet_text` is generated on-demand but is lightweight
- For high-traffic sites, consider caching the packet output in a transient

```php
function get_cached_guidelines_packet( $task = 'writing' ) {
    $cache_key = 'cg_packet_' . $task;
    $packet = get_transient( $cache_key );

    if ( false === $packet ) {
        $packet = wp_get_content_guidelines_packet( array( 'task' => $task ) );
        set_transient( $cache_key, $packet, HOUR_IN_SECONDS );
    }

    return $packet;
}
```
</file>

<file path="docs/rest-api.md">
# REST API Reference

All endpoints require authentication and the `edit_theme_options` capability.

## Base URL

```
/wp-json/wp/v2/content-guidelines
```

## Authentication

Use any standard WordPress REST API authentication method:

- **Cookie Authentication** (for logged-in users)
- **Application Passwords** (recommended for external apps)
- **OAuth 2.0** (via plugin)

## Endpoints

### GET /content-guidelines

Get the current guidelines state including active, draft, and metadata.

**Response:**

```json
{
  "active": {
    "version": 1,
    "brand_context": {
      "site_description": "A blog about sustainable living",
      "audience": "Environmentally conscious millennials",
      "primary_goal": "inform"
    },
    "voice_tone": {
      "tone_traits": ["friendly", "encouraging"],
      "pov": "we_you",
      "readability": "general"
    },
    "copy_rules": {
      "dos": ["Use active voice"],
      "donts": ["Avoid jargon"],
      "formatting": ["h2s", "bullets"]
    },
    "vocabulary": {
      "prefer": [{"term": "sustainable", "note": "Our core value"}],
      "avoid": [{"term": "green", "note": "Too vague"}]
    },
    "image_style": {
      "dos": ["Natural lighting"],
      "donts": ["Stock photos"],
      "text_policy": "never"
    },
    "notes": ""
  },
  "draft": null,
  "has_draft": false,
  "post_id": 123,
  "updated_at": "2025-01-15T10:30:00",
  "revision_count": 5
}
```

### PUT /content-guidelines/draft

Save draft guidelines without publishing.

**Request Body:**

```json
{
  "guidelines": {
    "brand_context": {
      "site_description": "Updated description"
    }
  }
}
```

**Response:**

```json
{
  "success": true,
  "message": "Draft saved."
}
```

### POST /content-guidelines/publish

Publish the current draft, making it the active guidelines.

**Response:**

```json
{
  "success": true,
  "post_id": 123,
  "message": "Guidelines published."
}
```

### POST /content-guidelines/discard-draft

Discard all unpublished draft changes.

**Response:**

```json
{
  "success": true,
  "message": "Draft discarded."
}
```

### GET /content-guidelines/packet

Get a task-specific context packet for AI consumption.

**Query Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `task` | string | `writing` | Task type: `writing`, `headline`, `cta`, `image`, `coach` |
| `post_id` | integer | - | Optional context post ID |
| `use` | string | `active` | Guidelines version: `active` or `draft` |
| `max_chars` | integer | `2000` | Maximum characters for packet_text |
| `block_name` | string | - | Optional: include block-specific rules (e.g., `core/button`) |

**Example Request:**

```
GET /wp-json/wp/v2/content-guidelines/packet?task=cta&block_name=core/button
```

**Response:**

```json
{
  "packet_text": "## SITE CONTENT GUIDELINES\n\n### Voice & Tone\nTone: friendly, encouraging\nPoint of view: Write as \"we\" speaking to \"you\"\n...",
  "packet_structured": {
    "voice_tone": {
      "tone_traits": ["friendly", "encouraging"],
      "pov": "we_you",
      "readability": "general"
    },
    "copy_rules": {
      "dos": ["Use active voice"],
      "donts": ["Avoid jargon"]
    },
    "vocabulary": {
      "prefer": [{"term": "sustainable"}],
      "avoid": [{"term": "green"}]
    }
  },
  "guidelines_id": 123,
  "revision_id": 456,
  "updated_at": "2025-01-15T10:30:00"
}
```

### GET /content-guidelines/for-post/{post_id}

**Primary endpoint for agents working with post content.** Analyzes the blocks in a post and returns guidelines with block-specific rules merged.

**Path Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `post_id` | integer | The post ID to analyze |

**Query Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `task` | string | `writing` | Task type |
| `use` | string | `active` | Guidelines version: `active` or `draft` |

**Example Request:**

```
GET /wp-json/wp/v2/content-guidelines/for-post/123?task=writing
```

**Response:**

```json
{
  "packet_text": "## SITE CONTENT GUIDELINES\n\nAbout this site: ...\n\n### Block-Specific Rules\n\n**core/button:**\nDO:\n- Use action verbs\n...",
  "packet_structured": {
    "brand_context": { ... },
    "voice_tone": { ... }
  },
  "blocks_in_post": [
    "core/paragraph",
    "core/heading",
    "core/image",
    "core/button"
  ],
  "block_guidelines": {
    "core/button": {
      "copy_rules": {
        "dos": ["Use action verbs", "Keep under 5 words"],
        "donts": ["Don't use 'Click here'"]
      },
      "notes": "Button text should create urgency"
    }
  },
  "guidelines_id": 42,
  "updated_at": "2025-01-15T10:30:00"
}
```

### GET /content-guidelines/blocks

Get guidelines for multiple block types in a single request.

**Query Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `blocks` | array | required | Block names (array or comma-separated) |
| `task` | string | `writing` | Task type |
| `use` | string | `active` | Guidelines version: `active` or `draft` |

**Example Requests:**

```
# Array syntax
GET /wp-json/wp/v2/content-guidelines/blocks?blocks[]=core/heading&blocks[]=core/button

# Comma-separated
GET /wp-json/wp/v2/content-guidelines/blocks?blocks=core/heading,core/paragraph,core/button
```

**Response:**

```json
{
  "site_rules": {
    "dos": ["Use active voice", "Keep sentences short"],
    "donts": ["Avoid jargon", "Don't use passive voice"]
  },
  "blocks": {
    "core/heading": null,
    "core/paragraph": {
      "copy_rules": {
        "dos": ["Limit to 3-4 sentences"],
        "donts": ["Don't start with 'In this article'"]
      }
    },
    "core/button": {
      "copy_rules": {
        "dos": ["Use action verbs"],
        "donts": ["Don't use 'Click here'"]
      },
      "notes": "Keep CTA text under 5 words"
    }
  },
  "packet_text": "## CONTENT GUIDELINES\n\n### Site Rules\nDO:\n- Use active voice\n...",
  "guidelines_id": 42
}
```

### GET /content-guidelines/revisions

Get revision history.

**Response:**

```json
[
  {
    "id": 456,
    "author": {
      "id": 1,
      "name": "Admin"
    },
    "date": "2025-01-15 10:30:00",
    "date_gmt": "2025-01-15 10:30:00",
    "modified": "2025-01-15 10:30:00",
    "modified_gmt": "2025-01-15 10:30:00"
  }
]
```

### POST /content-guidelines/restore/{id}

Restore a specific revision.

**Response:**

```json
{
  "success": true,
  "post_id": 123,
  "message": "Revision restored."
}
```

### POST /content-guidelines/test

Run a playground test against fixture content.

**Request Body:**

```json
{
  "task": "rewrite_intro",
  "fixture_post_id": 789,
  "use": "draft",
  "compare": true,
  "extra_instructions": "Make it more casual"
}
```

**Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `task` | string | `rewrite_intro` | Test type: `rewrite_intro`, `generate_headlines`, `write_cta` |
| `fixture_post_id` | integer | required | Post ID to use as test content |
| `use` | string | `draft` | Guidelines version to test |
| `compare` | boolean | `false` | Also run with active guidelines for comparison |
| `extra_instructions` | string | - | Additional instructions for AI |

**Response:**

```json
{
  "lint_results": {
    "issues": [
      {
        "type": "vocabulary_avoid",
        "term": "green",
        "message": "Avoid using 'green'",
        "suggestion": "Use 'sustainable' instead"
      }
    ],
    "issue_count": 1
  },
  "context_packet": {
    "packet_text": "...",
    "packet_structured": {}
  },
  "fixture": {
    "title": "How to Live Sustainably",
    "excerpt": "This article covers..."
  },
  "ai_result": {
    "output": "Rewritten intro text...",
    "metadata": {}
  },
  "ai_available": true,
  "compare": {
    "lint_results": {},
    "context_packet": {},
    "ai_result": {}
  }
}
```

## Usage Examples

### JavaScript (wp.apiFetch)

```javascript
// Get guidelines
const guidelines = await wp.apiFetch({
  path: '/wp/v2/content-guidelines'
});

// Get context packet for AI
const packet = await wp.apiFetch({
  path: '/wp/v2/content-guidelines/packet?task=headline'
});

// Save draft
await wp.apiFetch({
  path: '/wp/v2/content-guidelines/draft',
  method: 'PUT',
  data: {
    guidelines: {
      brand_context: {
        site_description: 'New description'
      }
    }
  }
});

// Publish
await wp.apiFetch({
  path: '/wp/v2/content-guidelines/publish',
  method: 'POST'
});
```

### cURL

```bash
# Get guidelines
curl -X GET \
  'https://example.com/wp-json/wp/v2/content-guidelines' \
  -H 'Authorization: Basic BASE64_ENCODED_APP_PASSWORD'

# Get context packet
curl -X GET \
  'https://example.com/wp-json/wp/v2/content-guidelines/packet?task=writing' \
  -H 'Authorization: Basic BASE64_ENCODED_APP_PASSWORD'

# Save draft
curl -X PUT \
  'https://example.com/wp-json/wp/v2/content-guidelines/draft' \
  -H 'Authorization: Basic BASE64_ENCODED_APP_PASSWORD' \
  -H 'Content-Type: application/json' \
  -d '{"guidelines":{"brand_context":{"site_description":"New description"}}}'
```

### Python

```python
import requests
from requests.auth import HTTPBasicAuth

base_url = 'https://example.com/wp-json/wp/v2/content-guidelines'
auth = HTTPBasicAuth('username', 'application_password')

# Get context packet
response = requests.get(
    f'{base_url}/packet',
    params={'task': 'writing'},
    auth=auth
)
packet = response.json()

# Use packet_text in your AI prompt
prompt = packet['packet_text'] + '\n\nWrite a blog post about...'
```

## Error Responses

All endpoints return standard WordPress REST API errors:

```json
{
  "code": "rest_forbidden",
  "message": "Sorry, you are not allowed to do that.",
  "data": {
    "status": 403
  }
}
```

Common error codes:

| Code | HTTP Status | Description |
|------|-------------|-------------|
| `rest_forbidden` | 403 | User lacks required capability |
| `invalid_fixture` | 400 | Invalid fixture post ID |
| `no_draft` | 400 | No draft to publish |
| `invalid_revision` | 400 | Revision not found |
</file>

<file path="includes/class-abilities.php">
<?php
/**
 * WordPress 6.9 Abilities API integration.
 *
 * Registers content guidelines abilities for AI orchestration and external discovery.
 *
 * @package ContentGuidelines
 * @since 0.2.0
 */

namespace ContentGuidelines;

defined( 'ABSPATH' ) || exit;

/**
 * Abilities API integration for Content Guidelines.
 *
 * Exposes content guidelines functionality through the WordPress 6.9 Abilities API,
 * enabling AI assistants and external services to discover and execute
 * guidelines-related actions in a standardized way.
 */
class Abilities {

	/**
	 * Ability category slug.
	 */
	const CATEGORY = 'content-guidelines';

	/**
	 * Ability namespace.
	 */
	const NAMESPACE = 'content-guidelines';

	/**
	 * Initialize abilities registration.
	 */
	public static function init() {
		// Only register if the Abilities API is available (WordPress 6.9+).
		if ( ! function_exists( 'wp_register_ability' ) ) {
			return;
		}

		add_action( 'wp_abilities_api_categories_init', array( __CLASS__, 'register_category' ) );
		add_action( 'wp_abilities_api_init', array( __CLASS__, 'register_abilities' ) );
	}

	/**
	 * Register the content guidelines ability category.
	 */
	public static function register_category() {
		if ( ! function_exists( 'wp_register_ability_category' ) ) {
			return;
		}

		wp_register_ability_category(
			self::CATEGORY,
			array(
				'label'       => __( 'Content Guidelines', 'content-guidelines' ),
				'description' => __( 'Manage site-level editorial guidelines for voice, tone, vocabulary, and copy rules that AI features can consume.', 'content-guidelines' ),
				'icon'        => 'edit',
			)
		);
	}

	/**
	 * Register all content guidelines abilities.
	 */
	public static function register_abilities() {
		// Core guidelines abilities.
		self::register_get_guidelines_ability();
		self::register_get_packet_ability();
		self::register_update_draft_ability();
		self::register_publish_draft_ability();
		self::register_discard_draft_ability();

		// Block-specific abilities.
		self::register_list_blocks_ability();
		self::register_get_block_guidelines_ability();
		self::register_update_block_guidelines_ability();

		// Revision abilities.
		self::register_get_revisions_ability();
		self::register_restore_revision_ability();

		// Import/Export abilities.
		self::register_export_guidelines_ability();
		self::register_import_guidelines_ability();

		// Testing abilities.
		self::register_run_test_ability();
		self::register_check_lint_ability();
	}

	/**
	 * Register the get-guidelines ability.
	 */
	private static function register_get_guidelines_ability() {
		wp_register_ability(
			self::NAMESPACE . '/get-guidelines',
			array(
				'label'               => __( 'Get Content Guidelines', 'content-guidelines' ),
				'description'         => __( 'Retrieve the site content guidelines including brand context, voice and tone, copy rules, vocabulary, and image style preferences.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'properties' => array(
						'use' => array(
							'type'        => 'string',
							'description' => __( 'Which version to retrieve: "active" for published guidelines or "draft" for unpublished changes.', 'content-guidelines' ),
							'enum'        => array( 'active', 'draft' ),
							'default'     => 'active',
						),
					),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'active'         => array(
							'type'        => 'object',
							'description' => __( 'The currently active (published) guidelines.', 'content-guidelines' ),
						),
						'draft'          => array(
							'type'        => array( 'object', 'null' ),
							'description' => __( 'The draft guidelines if any unpublished changes exist.', 'content-guidelines' ),
						),
						'has_draft'      => array(
							'type'        => 'boolean',
							'description' => __( 'Whether there are unpublished draft changes.', 'content-guidelines' ),
						),
						'post_id'        => array(
							'type'        => array( 'integer', 'null' ),
							'description' => __( 'The post ID of the guidelines entity.', 'content-guidelines' ),
						),
						'updated_at'     => array(
							'type'        => array( 'string', 'null' ),
							'description' => __( 'ISO 8601 timestamp of the last update.', 'content-guidelines' ),
						),
						'revision_count' => array(
							'type'        => 'integer',
							'description' => __( 'Number of saved revisions.', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_get_guidelines' ),
				'permission_callback' => array( __CLASS__, 'can_view_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the get-packet ability.
	 */
	private static function register_get_packet_ability() {
		wp_register_ability(
			self::NAMESPACE . '/get-context-packet',
			array(
				'label'               => __( 'Get Context Packet', 'content-guidelines' ),
				'description'         => __( 'Get a task-specific context packet formatted for LLM consumption. The packet contains relevant guidelines sections based on the task type.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'properties' => array(
						'task'      => array(
							'type'        => 'string',
							'description' => __( 'The type of task to get guidelines for.', 'content-guidelines' ),
							'enum'        => array( 'writing', 'headline', 'cta', 'image', 'coach' ),
							'default'     => 'writing',
						),
						'post_id'   => array(
							'type'        => 'integer',
							'description' => __( 'Optional post ID for context-specific overrides.', 'content-guidelines' ),
						),
						'use'       => array(
							'type'        => 'string',
							'description' => __( 'Which guidelines version to use.', 'content-guidelines' ),
							'enum'        => array( 'active', 'draft' ),
							'default'     => 'active',
						),
						'max_chars' => array(
							'type'        => 'integer',
							'description' => __( 'Maximum characters for the packet text.', 'content-guidelines' ),
							'default'     => 2000,
							'minimum'     => 100,
							'maximum'     => 10000,
						),
					),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'packet_text'       => array(
							'type'        => 'string',
							'description' => __( 'Formatted text optimized for LLM system prompts.', 'content-guidelines' ),
						),
						'packet_structured' => array(
							'type'        => 'object',
							'description' => __( 'Structured subset of guidelines relevant to the task.', 'content-guidelines' ),
						),
						'guidelines_id'     => array(
							'type'        => array( 'integer', 'null' ),
							'description' => __( 'Post ID of the guidelines entity.', 'content-guidelines' ),
						),
						'revision_id'       => array(
							'type'        => array( 'integer', 'null' ),
							'description' => __( 'Current revision ID.', 'content-guidelines' ),
						),
						'updated_at'        => array(
							'type'        => array( 'string', 'null' ),
							'description' => __( 'ISO 8601 timestamp of last update.', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_get_packet' ),
				'permission_callback' => array( __CLASS__, 'can_view_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the update-draft ability.
	 */
	private static function register_update_draft_ability() {
		wp_register_ability(
			self::NAMESPACE . '/update-draft',
			array(
				'label'               => __( 'Update Draft Guidelines', 'content-guidelines' ),
				'description'         => __( 'Save changes to draft guidelines without publishing. Use this to incrementally update guidelines before publishing.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'required'   => array( 'guidelines' ),
					'properties' => array(
						'guidelines' => array(
							'type'        => 'object',
							'description' => __( 'The guidelines object to save as draft.', 'content-guidelines' ),
							'properties'  => array(
								'brand_context' => array(
									'type'        => 'object',
									'description' => __( 'Brand identity and audience context.', 'content-guidelines' ),
									'properties'  => array(
										'site_description' => array( 'type' => 'string' ),
										'audience'         => array( 'type' => 'string' ),
										'primary_goal'     => array(
											'type' => 'string',
											'enum' => array( 'subscribe', 'sell', 'inform', 'community', 'other' ),
										),
									),
								),
								'voice_tone'    => array(
									'type'        => 'object',
									'description' => __( 'Voice and tone preferences.', 'content-guidelines' ),
									'properties'  => array(
										'tone_traits' => array(
											'type'  => 'array',
											'items' => array( 'type' => 'string' ),
										),
										'pov'         => array(
											'type' => 'string',
											'enum' => array( 'we_you', 'i_you', 'third_person' ),
										),
										'readability' => array(
											'type' => 'string',
											'enum' => array( 'simple', 'general', 'expert' ),
										),
									),
								),
								'copy_rules'    => array(
									'type'        => 'object',
									'description' => __( 'Writing dos and donts.', 'content-guidelines' ),
									'properties'  => array(
										'dos'        => array(
											'type'  => 'array',
											'items' => array( 'type' => 'string' ),
										),
										'donts'      => array(
											'type'  => 'array',
											'items' => array( 'type' => 'string' ),
										),
										'formatting' => array(
											'type'  => 'array',
											'items' => array( 'type' => 'string' ),
										),
									),
								),
								'vocabulary'    => array(
									'type'        => 'object',
									'description' => __( 'Preferred and avoided terms.', 'content-guidelines' ),
									'properties'  => array(
										'prefer' => array(
											'type'  => 'array',
											'items' => array(
												'type'       => 'object',
												'properties' => array(
													'term' => array( 'type' => 'string' ),
													'note' => array( 'type' => 'string' ),
												),
											),
										),
										'avoid'  => array(
											'type'  => 'array',
											'items' => array(
												'type'       => 'object',
												'properties' => array(
													'term' => array( 'type' => 'string' ),
													'note' => array( 'type' => 'string' ),
												),
											),
										),
									),
								),
								'image_style'   => array(
									'type'        => 'object',
									'description' => __( 'Image style preferences and reference images.', 'content-guidelines' ),
									'properties'  => array(
										'dos'              => array(
											'type'  => 'array',
											'items' => array( 'type' => 'string' ),
										),
										'donts'            => array(
											'type'  => 'array',
											'items' => array( 'type' => 'string' ),
										),
										'text_policy'      => array(
											'type' => 'string',
											'enum' => array( 'never', 'only_if_requested', 'ok' ),
										),
										'reference_images' => array(
											'type'        => 'array',
											'description' => __( 'Reference images from media library.', 'content-guidelines' ),
											'items'       => array(
												'type'       => 'object',
												'properties' => array(
													'id'    => array( 'type' => 'integer' ),
													'url'   => array( 'type' => 'string' ),
													'alt'   => array( 'type' => 'string' ),
													'notes' => array( 'type' => 'string' ),
												),
											),
										),
									),
								),
								'heuristics'    => array(
									'type'        => 'object',
									'description' => __( 'Target metrics for content structure and readability.', 'content-guidelines' ),
									'properties'  => array(
										'words_per_sentence'      => array(
											'type'        => 'integer',
											'description' => __( 'Target average words per sentence.', 'content-guidelines' ),
										),
										'sentences_per_paragraph' => array(
											'type'        => 'integer',
											'description' => __( 'Target sentences per paragraph.', 'content-guidelines' ),
										),
										'paragraphs_per_section'  => array(
											'type'        => 'integer',
											'description' => __( 'Target paragraphs per section.', 'content-guidelines' ),
										),
										'reading_level'           => array(
											'type'        => 'string',
											'description' => __( 'Target reading level.', 'content-guidelines' ),
											'enum'        => array( '5th_grade', '8th_grade', 'high_school', 'college', 'custom' ),
										),
										'custom_reading_level'    => array(
											'type'        => 'string',
											'description' => __( 'Custom reading level description when reading_level is "custom".', 'content-guidelines' ),
										),
										'max_syllables_per_word'  => array(
											'type'        => 'integer',
											'description' => __( 'Maximum average syllables per word.', 'content-guidelines' ),
										),
									),
								),
								'references'    => array(
									'type'        => 'array',
									'description' => __( 'External content references to emulate.', 'content-guidelines' ),
									'items'       => array(
										'type'       => 'object',
										'properties' => array(
											'title' => array(
												'type'        => 'string',
												'description' => __( 'Reference title or name.', 'content-guidelines' ),
											),
											'url'   => array(
												'type'        => 'string',
												'description' => __( 'URL to the reference.', 'content-guidelines' ),
											),
											'type'  => array(
												'type'        => 'string',
												'description' => __( 'Type of reference.', 'content-guidelines' ),
												'enum'        => array( 'website', 'article', 'book', 'document', 'competitor', 'other' ),
											),
											'notes' => array(
												'type'        => 'string',
												'description' => __( 'Notes about what to emulate.', 'content-guidelines' ),
											),
										),
									),
								),
								'blocks'        => array(
									'type'                 => 'object',
									'description'          => __( 'Per-block guidelines keyed by block name.', 'content-guidelines' ),
									'additionalProperties' => array(
										'type'       => 'object',
										'properties' => array(
											'copy_rules' => array(
												'type'       => 'object',
												'properties' => array(
													'dos'   => array(
														'type'  => 'array',
														'items' => array( 'type' => 'string' ),
													),
													'donts' => array(
														'type'  => 'array',
														'items' => array( 'type' => 'string' ),
													),
												),
											),
											'notes'      => array( 'type' => 'string' ),
										),
									),
								),
								'notes'         => array(
									'type'        => 'string',
									'description' => __( 'General notes and additional context.', 'content-guidelines' ),
								),
							),
						),
					),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'success' => array(
							'type'        => 'boolean',
							'description' => __( 'Whether the draft was saved successfully.', 'content-guidelines' ),
						),
						'message' => array(
							'type'        => 'string',
							'description' => __( 'Status message.', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_update_draft' ),
				'permission_callback' => array( __CLASS__, 'can_edit_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the publish-draft ability.
	 */
	private static function register_publish_draft_ability() {
		wp_register_ability(
			self::NAMESPACE . '/publish-draft',
			array(
				'label'               => __( 'Publish Draft Guidelines', 'content-guidelines' ),
				'description'         => __( 'Publish the current draft guidelines, making them the active guidelines for the site.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'properties' => array(),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'success' => array(
							'type'        => 'boolean',
							'description' => __( 'Whether the publish was successful.', 'content-guidelines' ),
						),
						'post_id' => array(
							'type'        => 'integer',
							'description' => __( 'The post ID of the published guidelines.', 'content-guidelines' ),
						),
						'message' => array(
							'type'        => 'string',
							'description' => __( 'Status message.', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_publish_draft' ),
				'permission_callback' => array( __CLASS__, 'can_edit_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the discard-draft ability.
	 */
	private static function register_discard_draft_ability() {
		wp_register_ability(
			self::NAMESPACE . '/discard-draft',
			array(
				'label'               => __( 'Discard Draft Guidelines', 'content-guidelines' ),
				'description'         => __( 'Discard all unpublished draft changes and revert to the active guidelines.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'properties' => array(),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'success' => array(
							'type'        => 'boolean',
							'description' => __( 'Whether the discard was successful.', 'content-guidelines' ),
						),
						'message' => array(
							'type'        => 'string',
							'description' => __( 'Status message.', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_discard_draft' ),
				'permission_callback' => array( __CLASS__, 'can_edit_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the list-blocks ability.
	 */
	private static function register_list_blocks_ability() {
		wp_register_ability(
			self::NAMESPACE . '/list-blocks',
			array(
				'label'               => __( 'List Blocks', 'content-guidelines' ),
				'description'         => __( 'List all available block types and their guidelines configuration status.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'properties' => array(
						'configured_only' => array(
							'type'        => 'boolean',
							'description' => __( 'Only return blocks that have guidelines configured.', 'content-guidelines' ),
							'default'     => false,
						),
						'search'          => array(
							'type'        => 'string',
							'description' => __( 'Search blocks by name or title.', 'content-guidelines' ),
						),
					),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'blocks' => array(
							'type'        => 'array',
							'description' => __( 'Array of block types.', 'content-guidelines' ),
							'items'       => array(
								'type'       => 'object',
								'properties' => array(
									'name'           => array( 'type' => 'string' ),
									'title'          => array( 'type' => 'string' ),
									'description'    => array( 'type' => 'string' ),
									'category'       => array( 'type' => 'string' ),
									'has_guidelines' => array( 'type' => 'boolean' ),
								),
							),
						),
						'total'  => array(
							'type'        => 'integer',
							'description' => __( 'Total number of blocks returned.', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_list_blocks' ),
				'permission_callback' => array( __CLASS__, 'can_view_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the get-block-guidelines ability.
	 */
	private static function register_get_block_guidelines_ability() {
		wp_register_ability(
			self::NAMESPACE . '/get-block-guidelines',
			array(
				'label'               => __( 'Get Block Guidelines', 'content-guidelines' ),
				'description'         => __( 'Get guidelines for a specific block type.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'required'   => array( 'block_name' ),
					'properties' => array(
						'block_name' => array(
							'type'        => 'string',
							'description' => __( 'The block name (e.g., "core/paragraph").', 'content-guidelines' ),
						),
						'use'        => array(
							'type'        => 'string',
							'description' => __( 'Which version to retrieve.', 'content-guidelines' ),
							'enum'        => array( 'active', 'draft' ),
							'default'     => 'active',
						),
					),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'block_name'  => array(
							'type'        => 'string',
							'description' => __( 'The block name.', 'content-guidelines' ),
						),
						'block_title' => array(
							'type'        => 'string',
							'description' => __( 'The block display title.', 'content-guidelines' ),
						),
						'guidelines'  => array(
							'type'        => 'object',
							'description' => __( 'The block guidelines.', 'content-guidelines' ),
							'properties'  => array(
								'copy_rules' => array(
									'type'       => 'object',
									'properties' => array(
										'dos'   => array(
											'type'  => 'array',
											'items' => array( 'type' => 'string' ),
										),
										'donts' => array(
											'type'  => 'array',
											'items' => array( 'type' => 'string' ),
										),
									),
								),
								'notes'      => array( 'type' => 'string' ),
							),
						),
						'has_content' => array(
							'type'        => 'boolean',
							'description' => __( 'Whether the block has any guidelines configured.', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_get_block_guidelines' ),
				'permission_callback' => array( __CLASS__, 'can_view_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the update-block-guidelines ability.
	 */
	private static function register_update_block_guidelines_ability() {
		wp_register_ability(
			self::NAMESPACE . '/update-block-guidelines',
			array(
				'label'               => __( 'Update Block Guidelines', 'content-guidelines' ),
				'description'         => __( 'Update guidelines for a specific block type. Changes are saved to draft.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'required'   => array( 'block_name', 'guidelines' ),
					'properties' => array(
						'block_name' => array(
							'type'        => 'string',
							'description' => __( 'The block name (e.g., "core/paragraph").', 'content-guidelines' ),
						),
						'guidelines' => array(
							'type'        => 'object',
							'description' => __( 'The block guidelines to save.', 'content-guidelines' ),
							'properties'  => array(
								'copy_rules' => array(
									'type'       => 'object',
									'properties' => array(
										'dos'   => array(
											'type'  => 'array',
											'items' => array( 'type' => 'string' ),
										),
										'donts' => array(
											'type'  => 'array',
											'items' => array( 'type' => 'string' ),
										),
									),
								),
								'notes'      => array( 'type' => 'string' ),
							),
						),
					),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'success' => array(
							'type'        => 'boolean',
							'description' => __( 'Whether the update was successful.', 'content-guidelines' ),
						),
						'message' => array(
							'type'        => 'string',
							'description' => __( 'Status message.', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_update_block_guidelines' ),
				'permission_callback' => array( __CLASS__, 'can_edit_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the get-revisions ability.
	 */
	private static function register_get_revisions_ability() {
		wp_register_ability(
			self::NAMESPACE . '/get-revisions',
			array(
				'label'               => __( 'Get Revisions', 'content-guidelines' ),
				'description'         => __( 'Get the revision history for guidelines.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'properties' => array(
						'limit' => array(
							'type'        => 'integer',
							'description' => __( 'Maximum number of revisions to return.', 'content-guidelines' ),
							'default'     => 20,
							'minimum'     => 1,
							'maximum'     => 100,
						),
					),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'revisions' => array(
							'type'        => 'array',
							'description' => __( 'Array of revisions.', 'content-guidelines' ),
							'items'       => array(
								'type'       => 'object',
								'properties' => array(
									'id'         => array( 'type' => 'integer' ),
									'date'       => array( 'type' => 'string' ),
									'date_gmt'   => array( 'type' => 'string' ),
									'author'     => array( 'type' => 'integer' ),
									'author_name' => array( 'type' => 'string' ),
								),
							),
						),
						'total'     => array(
							'type'        => 'integer',
							'description' => __( 'Total number of revisions.', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_get_revisions' ),
				'permission_callback' => array( __CLASS__, 'can_view_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the restore-revision ability.
	 */
	private static function register_restore_revision_ability() {
		wp_register_ability(
			self::NAMESPACE . '/restore-revision',
			array(
				'label'               => __( 'Restore Revision', 'content-guidelines' ),
				'description'         => __( 'Restore guidelines to a previous revision. The revision becomes the new draft.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'required'   => array( 'revision_id' ),
					'properties' => array(
						'revision_id' => array(
							'type'        => 'integer',
							'description' => __( 'The revision ID to restore.', 'content-guidelines' ),
						),
					),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'success'    => array(
							'type'        => 'boolean',
							'description' => __( 'Whether the restore was successful.', 'content-guidelines' ),
						),
						'message'    => array(
							'type'        => 'string',
							'description' => __( 'Status message.', 'content-guidelines' ),
						),
						'guidelines' => array(
							'type'        => 'object',
							'description' => __( 'The restored guidelines (now in draft).', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_restore_revision' ),
				'permission_callback' => array( __CLASS__, 'can_edit_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the export-guidelines ability.
	 */
	private static function register_export_guidelines_ability() {
		wp_register_ability(
			self::NAMESPACE . '/export-guidelines',
			array(
				'label'               => __( 'Export Guidelines', 'content-guidelines' ),
				'description'         => __( 'Export guidelines as a portable JSON object.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'properties' => array(
						'use'             => array(
							'type'        => 'string',
							'description' => __( 'Which version to export.', 'content-guidelines' ),
							'enum'        => array( 'active', 'draft' ),
							'default'     => 'active',
						),
						'include_meta'    => array(
							'type'        => 'boolean',
							'description' => __( 'Include metadata like export date and version.', 'content-guidelines' ),
							'default'     => true,
						),
					),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'export' => array(
							'type'        => 'object',
							'description' => __( 'The exported guidelines object.', 'content-guidelines' ),
							'properties'  => array(
								'version'       => array( 'type' => 'string' ),
								'exported_at'   => array( 'type' => 'string' ),
								'site_url'      => array( 'type' => 'string' ),
								'guidelines'    => array( 'type' => 'object' ),
							),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_export_guidelines' ),
				'permission_callback' => array( __CLASS__, 'can_view_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the import-guidelines ability.
	 */
	private static function register_import_guidelines_ability() {
		wp_register_ability(
			self::NAMESPACE . '/import-guidelines',
			array(
				'label'               => __( 'Import Guidelines', 'content-guidelines' ),
				'description'         => __( 'Import guidelines from a JSON export. Imported guidelines become the new draft.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'required'   => array( 'import' ),
					'properties' => array(
						'import' => array(
							'type'        => 'object',
							'description' => __( 'The guidelines export object to import.', 'content-guidelines' ),
							'properties'  => array(
								'guidelines' => array(
									'type'        => 'object',
									'description' => __( 'The guidelines data.', 'content-guidelines' ),
								),
							),
						),
						'merge'  => array(
							'type'        => 'boolean',
							'description' => __( 'Merge with existing guidelines instead of replacing.', 'content-guidelines' ),
							'default'     => false,
						),
					),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'success' => array(
							'type'        => 'boolean',
							'description' => __( 'Whether the import was successful.', 'content-guidelines' ),
						),
						'message' => array(
							'type'        => 'string',
							'description' => __( 'Status message.', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_import_guidelines' ),
				'permission_callback' => array( __CLASS__, 'can_edit_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the run-test ability.
	 */
	private static function register_run_test_ability() {
		wp_register_ability(
			self::NAMESPACE . '/run-test',
			array(
				'label'               => __( 'Run Playground Test', 'content-guidelines' ),
				'description'         => __( 'Test how guidelines affect AI-generated content by running a task against a fixture post. Returns lint results, context packet, and optionally AI-generated output if a provider is available.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'required'   => array( 'fixture_post_id' ),
					'properties' => array(
						'task'               => array(
							'type'        => 'string',
							'description' => __( 'The type of test to run.', 'content-guidelines' ),
							'enum'        => array( 'rewrite_intro', 'generate_headlines', 'write_cta' ),
							'default'     => 'rewrite_intro',
						),
						'fixture_post_id'    => array(
							'type'        => 'integer',
							'description' => __( 'The post ID to use as test fixture content.', 'content-guidelines' ),
						),
						'use'                => array(
							'type'        => 'string',
							'description' => __( 'Which guidelines version to test with.', 'content-guidelines' ),
							'enum'        => array( 'active', 'draft' ),
							'default'     => 'draft',
						),
						'compare'            => array(
							'type'        => 'boolean',
							'description' => __( 'Whether to also run the test with active guidelines for comparison.', 'content-guidelines' ),
							'default'     => false,
						),
						'extra_instructions' => array(
							'type'        => 'string',
							'description' => __( 'Additional instructions to pass to the AI provider.', 'content-guidelines' ),
						),
					),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'lint_results'   => array(
							'type'        => 'object',
							'description' => __( 'Results from vocabulary and copy rule lint checks.', 'content-guidelines' ),
						),
						'context_packet' => array(
							'type'        => 'object',
							'description' => __( 'The context packet that would be sent to AI.', 'content-guidelines' ),
						),
						'fixture'        => array(
							'type'        => 'object',
							'description' => __( 'Information about the fixture post used.', 'content-guidelines' ),
						),
						'ai_result'      => array(
							'type'        => 'object',
							'description' => __( 'AI-generated result if a provider is available.', 'content-guidelines' ),
						),
						'ai_available'   => array(
							'type'        => 'boolean',
							'description' => __( 'Whether AI generation was available.', 'content-guidelines' ),
						),
						'compare'        => array(
							'type'        => 'object',
							'description' => __( 'Comparison results using active guidelines.', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_run_test' ),
				'permission_callback' => array( __CLASS__, 'can_edit_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	/**
	 * Register the check-lint ability.
	 */
	private static function register_check_lint_ability() {
		wp_register_ability(
			self::NAMESPACE . '/check-lint',
			array(
				'label'               => __( 'Check Content Lint', 'content-guidelines' ),
				'description'         => __( 'Run vocabulary and copy rule lint checks against provided content without running AI generation.', 'content-guidelines' ),
				'category'            => self::CATEGORY,
				'input_schema'        => array(
					'type'       => 'object',
					'required'   => array( 'content' ),
					'properties' => array(
						'content' => array(
							'type'        => 'string',
							'description' => __( 'The content to check against guidelines.', 'content-guidelines' ),
						),
						'use'     => array(
							'type'        => 'string',
							'description' => __( 'Which guidelines version to check against.', 'content-guidelines' ),
							'enum'        => array( 'active', 'draft' ),
							'default'     => 'active',
						),
					),
				),
				'output_schema'       => array(
					'type'       => 'object',
					'properties' => array(
						'issues'       => array(
							'type'        => 'array',
							'description' => __( 'Array of lint issues found.', 'content-guidelines' ),
							'items'       => array(
								'type'       => 'object',
								'properties' => array(
									'type'       => array( 'type' => 'string' ),
									'term'       => array( 'type' => 'string' ),
									'message'    => array( 'type' => 'string' ),
									'suggestion' => array( 'type' => 'string' ),
								),
							),
						),
						'issue_count'  => array(
							'type'        => 'integer',
							'description' => __( 'Total number of issues found.', 'content-guidelines' ),
						),
						'passed'       => array(
							'type'        => 'boolean',
							'description' => __( 'Whether the content passed all lint checks.', 'content-guidelines' ),
						),
					),
				),
				'execute_callback'    => array( __CLASS__, 'execute_check_lint' ),
				'permission_callback' => array( __CLASS__, 'can_view_guidelines' ),
				'meta'                => array(
					'show_in_rest' => true,
				),
			)
		);
	}

	// -------------------------------------------------------------------------
	// Permission callbacks
	// -------------------------------------------------------------------------

	/**
	 * Check if user can view guidelines.
	 *
	 * @return bool True if can view.
	 */
	public static function can_view_guidelines() {
		return current_user_can( 'edit_theme_options' );
	}

	/**
	 * Check if user can edit guidelines.
	 *
	 * @return bool True if can edit.
	 */
	public static function can_edit_guidelines() {
		return current_user_can( 'edit_theme_options' );
	}

	// -------------------------------------------------------------------------
	// Execute callbacks
	// -------------------------------------------------------------------------

	/**
	 * Execute get-guidelines ability.
	 *
	 * @param array $input The input parameters.
	 * @return array|WP_Error The guidelines data.
	 */
	public static function execute_get_guidelines( $input ) {
		$post   = Post_Type::get_guidelines_post();
		$active = Post_Type::get_active_guidelines();
		$draft  = Post_Type::get_draft_guidelines();

		return array(
			'active'         => $active ? $active : Post_Type::get_default_guidelines(),
			'draft'          => $draft,
			'has_draft'      => ! empty( $draft ),
			'post_id'        => $post ? $post->ID : null,
			'updated_at'     => $post ? $post->post_modified_gmt : null,
			'revision_count' => $post ? count( wp_get_post_revisions( $post->ID, array( 'check_enabled' => false ) ) ) : 0,
		);
	}

	/**
	 * Execute get-context-packet ability.
	 *
	 * @param array $input The input parameters.
	 * @return array The context packet.
	 */
	public static function execute_get_packet( $input ) {
		return Context_Packet_Builder::get_packet(
			array(
				'task'      => isset( $input['task'] ) ? $input['task'] : 'writing',
				'post_id'   => isset( $input['post_id'] ) ? $input['post_id'] : null,
				'use'       => isset( $input['use'] ) ? $input['use'] : 'active',
				'max_chars' => isset( $input['max_chars'] ) ? $input['max_chars'] : 2000,
			)
		);
	}

	/**
	 * Execute update-draft ability.
	 *
	 * @param array $input The input parameters.
	 * @return array|WP_Error Result.
	 */
	public static function execute_update_draft( $input ) {
		if ( ! isset( $input['guidelines'] ) ) {
			return new \WP_Error(
				'missing_guidelines',
				__( 'Guidelines data is required.', 'content-guidelines' )
			);
		}

		$sanitized = Post_Type::sanitize_guidelines( $input['guidelines'] );
		$result    = Post_Type::save_draft( $sanitized );

		if ( is_wp_error( $result ) ) {
			return $result;
		}

		return array(
			'success' => true,
			'message' => __( 'Draft saved.', 'content-guidelines' ),
		);
	}

	/**
	 * Execute publish-draft ability.
	 *
	 * @param array $input The input parameters.
	 * @return array|WP_Error Result.
	 */
	public static function execute_publish_draft( $input ) {
		$result = Post_Type::publish_draft();

		if ( is_wp_error( $result ) ) {
			return $result;
		}

		return array(
			'success' => true,
			'post_id' => $result,
			'message' => __( 'Guidelines published.', 'content-guidelines' ),
		);
	}

	/**
	 * Execute discard-draft ability.
	 *
	 * @param array $input The input parameters.
	 * @return array Result.
	 */
	public static function execute_discard_draft( $input ) {
		Post_Type::discard_draft();

		return array(
			'success' => true,
			'message' => __( 'Draft discarded.', 'content-guidelines' ),
		);
	}

	/**
	 * Execute run-test ability.
	 *
	 * @param array $input The input parameters.
	 * @return array|WP_Error Result.
	 */
	public static function execute_run_test( $input ) {
		if ( ! isset( $input['fixture_post_id'] ) ) {
			return new \WP_Error(
				'missing_fixture',
				__( 'Fixture post ID is required.', 'content-guidelines' )
			);
		}

		$fixture_post = get_post( $input['fixture_post_id'] );

		if ( ! $fixture_post ) {
			return new \WP_Error(
				'invalid_fixture',
				__( 'Invalid fixture post.', 'content-guidelines' )
			);
		}

		$task               = isset( $input['task'] ) ? $input['task'] : 'rewrite_intro';
		$use                = isset( $input['use'] ) ? $input['use'] : 'draft';
		$compare            = isset( $input['compare'] ) ? $input['compare'] : false;
		$extra_instructions = isset( $input['extra_instructions'] ) ? $input['extra_instructions'] : '';

		// Get guidelines.
		$guidelines = 'draft' === $use
			? Post_Type::get_draft_guidelines()
			: Post_Type::get_active_guidelines();

		if ( ! $guidelines ) {
			$guidelines = Post_Type::get_default_guidelines();
		}

		// Extract fixture content.
		$fixture_content = self::extract_fixture_content( $fixture_post, $task );

		// Run lint checks.
		$lint_results = Lint_Checker::check( $fixture_content, $guidelines );

		// Build context packet.
		$context_packet = Context_Packet_Builder::get_packet(
			array(
				'task'    => self::map_task_type( $task ),
				'post_id' => $input['fixture_post_id'],
				'use'     => $use,
			)
		);

		$result = array(
			'lint_results'   => $lint_results,
			'context_packet' => $context_packet,
			'fixture'        => array(
				'title'   => $fixture_post->post_title,
				'excerpt' => wp_trim_words( $fixture_content, 100 ),
			),
		);

		// Try AI provider.
		$ai_request = array(
			'task'               => $task,
			'fixture_content'    => $fixture_content,
			'guidelines'         => $guidelines,
			'context_packet'     => $context_packet,
			'extra_instructions' => $extra_instructions,
		);

		$ai_result = apply_filters( 'wp_content_guidelines_run_playground_test', null, $ai_request );

		if ( null !== $ai_result ) {
			$result['ai_result'] = $ai_result;
		} else {
			$result['ai_available'] = false;
		}

		// Comparison mode.
		if ( $compare && 'draft' === $use ) {
			$active_guidelines = Post_Type::get_active_guidelines();

			if ( $active_guidelines ) {
				$active_lint   = Lint_Checker::check( $fixture_content, $active_guidelines );
				$active_packet = Context_Packet_Builder::get_packet(
					array(
						'task'    => self::map_task_type( $task ),
						'post_id' => $input['fixture_post_id'],
						'use'     => 'active',
					)
				);

				$result['compare'] = array(
					'lint_results'   => $active_lint,
					'context_packet' => $active_packet,
				);
			}
		}

		return $result;
	}

	/**
	 * Execute check-lint ability.
	 *
	 * @param array $input The input parameters.
	 * @return array|WP_Error Result.
	 */
	public static function execute_check_lint( $input ) {
		if ( ! isset( $input['content'] ) || empty( $input['content'] ) ) {
			return new \WP_Error(
				'missing_content',
				__( 'Content is required.', 'content-guidelines' )
			);
		}

		$use        = isset( $input['use'] ) ? $input['use'] : 'active';
		$guidelines = 'draft' === $use
			? Post_Type::get_draft_guidelines()
			: Post_Type::get_active_guidelines();

		if ( ! $guidelines ) {
			$guidelines = Post_Type::get_default_guidelines();
		}

		$lint_results = Lint_Checker::check( $input['content'], $guidelines );

		return array(
			'issues'      => isset( $lint_results['issues'] ) ? $lint_results['issues'] : array(),
			'issue_count' => isset( $lint_results['issue_count'] ) ? $lint_results['issue_count'] : 0,
			'passed'      => empty( $lint_results['issues'] ),
		);
	}

	/**
	 * Execute list-blocks ability.
	 *
	 * @param array $input The input parameters.
	 * @return array The blocks list.
	 */
	public static function execute_list_blocks( $input ) {
		$configured_only = isset( $input['configured_only'] ) ? $input['configured_only'] : false;
		$search          = isset( $input['search'] ) ? $input['search'] : '';

		// Get block types from registry.
		$block_types = \WP_Block_Type_Registry::get_instance()->get_all_registered();

		// Get current block guidelines.
		$guidelines       = Post_Type::get_active_guidelines();
		$block_guidelines = isset( $guidelines['blocks'] ) ? $guidelines['blocks'] : array();

		$blocks = array();

		foreach ( $block_types as $name => $block_type ) {
			// Skip legacy widgets.
			if ( strpos( $name, 'core/legacy-' ) === 0 ) {
				continue;
			}

			$has_guidelines = isset( $block_guidelines[ $name ] ) && self::block_has_content( $block_guidelines[ $name ] );

			// Filter by configured_only.
			if ( $configured_only && ! $has_guidelines ) {
				continue;
			}

			// Filter by search.
			if ( $search ) {
				$search_lower = strtolower( $search );
				$title        = isset( $block_type->title ) ? strtolower( $block_type->title ) : '';
				$name_lower   = strtolower( $name );

				if ( strpos( $title, $search_lower ) === false && strpos( $name_lower, $search_lower ) === false ) {
					continue;
				}
			}

			$blocks[] = array(
				'name'           => $name,
				'title'          => isset( $block_type->title ) ? $block_type->title : $name,
				'description'    => isset( $block_type->description ) ? $block_type->description : '',
				'category'       => isset( $block_type->category ) ? $block_type->category : '',
				'has_guidelines' => $has_guidelines,
			);
		}

		// Sort alphabetically by title.
		usort( $blocks, function( $a, $b ) {
			return strcasecmp( $a['title'], $b['title'] );
		} );

		return array(
			'blocks' => $blocks,
			'total'  => count( $blocks ),
		);
	}

	/**
	 * Execute get-block-guidelines ability.
	 *
	 * @param array $input The input parameters.
	 * @return array|WP_Error The block guidelines.
	 */
	public static function execute_get_block_guidelines( $input ) {
		if ( ! isset( $input['block_name'] ) ) {
			return new \WP_Error(
				'missing_block_name',
				__( 'Block name is required.', 'content-guidelines' )
			);
		}

		$block_name = $input['block_name'];
		$use        = isset( $input['use'] ) ? $input['use'] : 'active';

		// Get block type info.
		$block_type = \WP_Block_Type_Registry::get_instance()->get_registered( $block_name );

		// Get guidelines.
		$guidelines = 'draft' === $use
			? Post_Type::get_draft_guidelines()
			: Post_Type::get_active_guidelines();

		if ( ! $guidelines ) {
			$guidelines = Post_Type::get_default_guidelines();
		}

		$block_guidelines = isset( $guidelines['blocks'][ $block_name ] )
			? $guidelines['blocks'][ $block_name ]
			: array();

		return array(
			'block_name'  => $block_name,
			'block_title' => $block_type ? $block_type->title : $block_name,
			'guidelines'  => $block_guidelines,
			'has_content' => self::block_has_content( $block_guidelines ),
		);
	}

	/**
	 * Execute update-block-guidelines ability.
	 *
	 * @param array $input The input parameters.
	 * @return array|WP_Error Result.
	 */
	public static function execute_update_block_guidelines( $input ) {
		if ( ! isset( $input['block_name'] ) || ! isset( $input['guidelines'] ) ) {
			return new \WP_Error(
				'missing_params',
				__( 'Block name and guidelines are required.', 'content-guidelines' )
			);
		}

		$block_name       = $input['block_name'];
		$block_guidelines = $input['guidelines'];

		// Get current draft or create from active.
		$draft = Post_Type::get_draft_guidelines();

		if ( ! $draft ) {
			$draft = Post_Type::get_active_guidelines();
		}

		if ( ! $draft ) {
			$draft = Post_Type::get_default_guidelines();
		}

		// Ensure blocks array exists.
		if ( ! isset( $draft['blocks'] ) ) {
			$draft['blocks'] = array();
		}

		// Update this block's guidelines.
		$draft['blocks'][ $block_name ] = $block_guidelines;

		// Save draft.
		$result = Post_Type::save_draft( $draft );

		if ( is_wp_error( $result ) ) {
			return $result;
		}

		return array(
			'success' => true,
			'message' => sprintf(
				/* translators: %s: block name */
				__( 'Guidelines for %s updated.', 'content-guidelines' ),
				$block_name
			),
		);
	}

	/**
	 * Execute get-revisions ability.
	 *
	 * @param array $input The input parameters.
	 * @return array The revisions.
	 */
	public static function execute_get_revisions( $input ) {
		$limit = isset( $input['limit'] ) ? min( (int) $input['limit'], 100 ) : 20;
		$post  = Post_Type::get_guidelines_post();

		if ( ! $post ) {
			return array(
				'revisions' => array(),
				'total'     => 0,
			);
		}

		$revisions = wp_get_post_revisions(
			$post->ID,
			array(
				'check_enabled' => false,
				'numberposts'   => $limit,
			)
		);

		$result = array();

		foreach ( $revisions as $revision ) {
			$author      = get_user_by( 'id', $revision->post_author );
			$author_name = $author ? $author->display_name : __( 'Unknown', 'content-guidelines' );

			$result[] = array(
				'id'          => $revision->ID,
				'date'        => $revision->post_date,
				'date_gmt'    => $revision->post_modified_gmt,
				'author'      => (int) $revision->post_author,
				'author_name' => $author_name,
			);
		}

		return array(
			'revisions' => $result,
			'total'     => count( $result ),
		);
	}

	/**
	 * Execute restore-revision ability.
	 *
	 * @param array $input The input parameters.
	 * @return array|WP_Error Result.
	 */
	public static function execute_restore_revision( $input ) {
		if ( ! isset( $input['revision_id'] ) ) {
			return new \WP_Error(
				'missing_revision_id',
				__( 'Revision ID is required.', 'content-guidelines' )
			);
		}

		$revision_id = (int) $input['revision_id'];
		$revision    = wp_get_post_revision( $revision_id );

		if ( ! $revision ) {
			return new \WP_Error(
				'invalid_revision',
				__( 'Invalid revision ID.', 'content-guidelines' )
			);
		}

		// Get the guidelines from the revision.
		$revision_content = $revision->post_content;
		$guidelines       = json_decode( $revision_content, true );

		if ( json_last_error() !== JSON_ERROR_NONE || ! is_array( $guidelines ) ) {
			return new \WP_Error(
				'invalid_revision_content',
				__( 'Revision content is not valid guidelines data.', 'content-guidelines' )
			);
		}

		// Save as draft.
		$result = Post_Type::save_draft( $guidelines );

		if ( is_wp_error( $result ) ) {
			return $result;
		}

		return array(
			'success'    => true,
			'message'    => __( 'Revision restored as draft.', 'content-guidelines' ),
			'guidelines' => $guidelines,
		);
	}

	/**
	 * Execute export-guidelines ability.
	 *
	 * @param array $input The input parameters.
	 * @return array The export data.
	 */
	public static function execute_export_guidelines( $input ) {
		$use          = isset( $input['use'] ) ? $input['use'] : 'active';
		$include_meta = isset( $input['include_meta'] ) ? $input['include_meta'] : true;

		$guidelines = 'draft' === $use
			? Post_Type::get_draft_guidelines()
			: Post_Type::get_active_guidelines();

		if ( ! $guidelines ) {
			$guidelines = Post_Type::get_default_guidelines();
		}

		$export = array(
			'guidelines' => $guidelines,
		);

		if ( $include_meta ) {
			$export['version']     = '1.0';
			$export['exported_at'] = gmdate( 'c' );
			$export['site_url']    = get_site_url();
		}

		return array(
			'export' => $export,
		);
	}

	/**
	 * Execute import-guidelines ability.
	 *
	 * @param array $input The input parameters.
	 * @return array|WP_Error Result.
	 */
	public static function execute_import_guidelines( $input ) {
		if ( ! isset( $input['import'] ) ) {
			return new \WP_Error(
				'missing_import',
				__( 'Import data is required.', 'content-guidelines' )
			);
		}

		$import = $input['import'];
		$merge  = isset( $input['merge'] ) ? $input['merge'] : false;

		// Extract guidelines from import.
		$guidelines = isset( $import['guidelines'] ) ? $import['guidelines'] : $import;

		if ( ! is_array( $guidelines ) ) {
			return new \WP_Error(
				'invalid_import',
				__( 'Invalid import data format.', 'content-guidelines' )
			);
		}

		// Merge with existing if requested.
		if ( $merge ) {
			$existing = Post_Type::get_draft_guidelines();

			if ( ! $existing ) {
				$existing = Post_Type::get_active_guidelines();
			}

			if ( ! $existing ) {
				$existing = Post_Type::get_default_guidelines();
			}

			$guidelines = self::merge_guidelines( $existing, $guidelines );
		}

		// Sanitize and save.
		$sanitized = Post_Type::sanitize_guidelines( $guidelines );
		$result    = Post_Type::save_draft( $sanitized );

		if ( is_wp_error( $result ) ) {
			return $result;
		}

		return array(
			'success' => true,
			'message' => $merge
				? __( 'Guidelines merged and saved as draft.', 'content-guidelines' )
				: __( 'Guidelines imported and saved as draft.', 'content-guidelines' ),
		);
	}

	// -------------------------------------------------------------------------
	// Helper methods
	// -------------------------------------------------------------------------

	/**
	 * Check if block guidelines have any content.
	 *
	 * @param array $guidelines The block guidelines.
	 * @return bool True if has content.
	 */
	private static function block_has_content( $guidelines ) {
		if ( empty( $guidelines ) ) {
			return false;
		}

		// Check copy rules.
		if ( isset( $guidelines['copy_rules'] ) ) {
			if ( ! empty( $guidelines['copy_rules']['dos'] ) || ! empty( $guidelines['copy_rules']['donts'] ) ) {
				return true;
			}
		}

		// Check notes.
		if ( ! empty( $guidelines['notes'] ) ) {
			return true;
		}

		return false;
	}

	/**
	 * Merge two guidelines objects.
	 *
	 * @param array $existing The existing guidelines.
	 * @param array $new      The new guidelines to merge.
	 * @return array The merged guidelines.
	 */
	private static function merge_guidelines( $existing, $new ) {
		$merged = $existing;

		foreach ( $new as $key => $value ) {
			if ( is_array( $value ) && isset( $merged[ $key ] ) && is_array( $merged[ $key ] ) ) {
				// For arrays with numeric keys (like dos/donts), append.
				if ( isset( $value[0] ) ) {
					$merged[ $key ] = array_merge( $merged[ $key ], $value );
				} else {
					// For associative arrays, recursively merge.
					$merged[ $key ] = self::merge_guidelines( $merged[ $key ], $value );
				}
			} else {
				$merged[ $key ] = $value;
			}
		}

		return $merged;
	}

	/**
	 * Extract content from fixture post for a specific task.
	 *
	 * @param \WP_Post $post The post object.
	 * @param string   $task The task type.
	 * @return string The extracted content.
	 */
	private static function extract_fixture_content( $post, $task ) {
		$content = $post->post_content;
		$content = wp_strip_all_tags( do_blocks( $content ) );

		switch ( $task ) {
			case 'rewrite_intro':
				return mb_substr( $content, 0, 500 );

			case 'generate_headlines':
				return $post->post_title . "\n\n" . wp_trim_words( $content, 150 );

			case 'write_cta':
				return wp_trim_words( $content, 300 );

			default:
				return wp_trim_words( $content, 200 );
		}
	}

	/**
	 * Map playground task to context packet task type.
	 *
	 * @param string $task The playground task.
	 * @return string The context packet task.
	 */
	private static function map_task_type( $task ) {
		$map = array(
			'rewrite_intro'      => 'writing',
			'generate_headlines' => 'headline',
			'write_cta'          => 'cta',
		);

		return isset( $map[ $task ] ) ? $map[ $task ] : 'writing';
	}
}
</file>

<file path="includes/class-context-packet-builder.php">
<?php
/**
 * Context Packet Builder for AI consumption.
 *
 * @package ContentGuidelines
 */

namespace ContentGuidelines;

defined( 'ABSPATH' ) || exit;

/**
 * Builds task-specific context packets from guidelines.
 */
class Context_Packet_Builder {

	/**
	 * Get guidelines data.
	 *
	 * @param string $use Which version: 'active' or 'draft'.
	 * @return array|null Guidelines data.
	 */
	public static function get_guidelines( $use = 'active' ) {
		if ( 'draft' === $use ) {
			$draft = Post_Type::get_draft_guidelines();
			if ( $draft ) {
				return $draft;
			}
		}

		return Post_Type::get_active_guidelines();
	}

	/**
	 * Get context packet for AI consumption.
	 *
	 * @param array $args {
	 *     Arguments for building the packet.
	 *
	 *     @type string $task       Task type. Default 'writing'.
	 *     @type int    $post_id    Optional context post ID.
	 *     @type string $use        Which version: 'active' or 'draft'. Default 'active'.
	 *     @type int    $max_chars  Maximum characters. Default 2000.
	 *     @type string $locale     Optional locale.
	 *     @type string $block_name Optional block name for block-specific guidelines.
	 * }
	 * @return array The context packet.
	 */
	public static function get_packet( $args = array() ) {
		$defaults = array(
			'task'       => 'writing',
			'post_id'    => null,
			'use'        => 'active',
			'max_chars'  => 2000,
			'locale'     => get_locale(),
			'block_name' => null,
		);

		$args       = wp_parse_args( $args, $defaults );
		$guidelines = self::get_guidelines( $args['use'] );
		$post       = Post_Type::get_guidelines_post();

		if ( ! $guidelines ) {
			return array(
				'packet_text'       => '',
				'packet_structured' => array(),
				'guidelines_id'     => null,
				'revision_id'       => null,
				'updated_at'        => null,
			);
		}

		// Get task-relevant subset of guidelines.
		$relevant = self::get_task_relevant_sections( $guidelines, $args['task'] );

		// Merge block-specific guidelines if a block name is provided.
		if ( ! empty( $args['block_name'] ) ) {
			$relevant = self::merge_block_guidelines( $relevant, $guidelines, $args['block_name'] );
		}

		// Build text packet.
		$packet_text = self::build_text_packet( $relevant, $args['task'], $args['max_chars'], $args['block_name'] );

		// Get revision info.
		$revision_id = null;
		if ( $post ) {
			$revisions = wp_get_post_revisions( $post->ID, array( 'posts_per_page' => 1, 'check_enabled' => false ) );
			if ( ! empty( $revisions ) ) {
				$revision_id = current( $revisions )->ID;
			}
		}

		return array(
			'packet_text'       => $packet_text,
			'packet_structured' => $relevant,
			'guidelines_id'     => $post ? $post->ID : null,
			'revision_id'       => $revision_id,
			'updated_at'        => $post ? $post->post_modified_gmt : null,
		);
	}

	/**
	 * Get sections relevant to a specific task.
	 *
	 * @param array  $guidelines Full guidelines data.
	 * @param string $task       The task type.
	 * @return array Relevant subset.
	 */
	private static function get_task_relevant_sections( $guidelines, $task ) {
		$relevant = array();

		// Task-specific section mapping.
		$task_sections = array(
			'writing'  => array( 'brand_context', 'voice_tone', 'copy_rules', 'vocabulary', 'notes' ),
			'headline' => array( 'voice_tone', 'copy_rules', 'vocabulary' ),
			'cta'      => array( 'brand_context', 'copy_rules', 'vocabulary' ),
			'image'    => array( 'brand_context', 'image_style' ),
			'coach'    => array( 'voice_tone', 'copy_rules', 'vocabulary' ),
		);

		$sections = isset( $task_sections[ $task ] ) ? $task_sections[ $task ] : $task_sections['writing'];

		foreach ( $sections as $section ) {
			if ( isset( $guidelines[ $section ] ) && ! empty( $guidelines[ $section ] ) ) {
				$relevant[ $section ] = $guidelines[ $section ];
			}
		}

		return $relevant;
	}

	/**
	 * Merge block-specific guidelines into the relevant sections.
	 *
	 * Block-specific copy rules are appended to site-level copy rules.
	 * Block-specific notes are added as a separate section.
	 *
	 * @param array  $relevant   The task-relevant sections.
	 * @param array  $guidelines Full guidelines data.
	 * @param string $block_name The block name (e.g., 'core/paragraph').
	 * @return array Merged sections with block-specific guidelines.
	 */
	private static function merge_block_guidelines( $relevant, $guidelines, $block_name ) {
		if ( empty( $guidelines['blocks'][ $block_name ] ) ) {
			return $relevant;
		}

		$block_guidelines = $guidelines['blocks'][ $block_name ];

		// Merge block-specific copy rules with site-level rules.
		if ( ! empty( $block_guidelines['copy_rules'] ) ) {
			if ( ! isset( $relevant['copy_rules'] ) ) {
				$relevant['copy_rules'] = array();
			}

			// Append block-specific dos.
			if ( ! empty( $block_guidelines['copy_rules']['dos'] ) ) {
				$existing_dos = isset( $relevant['copy_rules']['dos'] ) ? $relevant['copy_rules']['dos'] : array();
				$relevant['copy_rules']['dos'] = array_merge( $existing_dos, $block_guidelines['copy_rules']['dos'] );
			}

			// Append block-specific donts.
			if ( ! empty( $block_guidelines['copy_rules']['donts'] ) ) {
				$existing_donts = isset( $relevant['copy_rules']['donts'] ) ? $relevant['copy_rules']['donts'] : array();
				$relevant['copy_rules']['donts'] = array_merge( $existing_donts, $block_guidelines['copy_rules']['donts'] );
			}
		}

		// Add block-specific notes.
		if ( ! empty( $block_guidelines['notes'] ) ) {
			$relevant['block_notes'] = $block_guidelines['notes'];
		}

		// Store block name for text packet generation.
		$relevant['_block_name'] = $block_name;

		return $relevant;
	}

	/**
	 * Build a text-based packet for LLM consumption.
	 *
	 * @param array       $relevant   Relevant guidelines sections.
	 * @param string      $task       The task type.
	 * @param int         $max_chars  Maximum characters.
	 * @param string|null $block_name Optional block name for context.
	 * @return string The formatted packet text.
	 */
	private static function build_text_packet( $relevant, $task, $max_chars, $block_name = null ) {
		$lines = array();
		$lines[] = '## SITE CONTENT GUIDELINES';

		// Add block context if provided.
		if ( $block_name ) {
			$lines[] = sprintf( '(Context: %s block)', $block_name );
		}

		$lines[] = '';

		// Brand context.
		if ( ! empty( $relevant['brand_context'] ) ) {
			$bc = $relevant['brand_context'];

			if ( ! empty( $bc['site_description'] ) ) {
				$lines[] = 'About this site: ' . $bc['site_description'];
			}

			if ( ! empty( $bc['audience'] ) ) {
				$lines[] = 'Target audience: ' . $bc['audience'];
			}

			if ( ! empty( $bc['primary_goal'] ) ) {
				$goal_labels = array(
					'subscribe' => 'Get email subscribers',
					'sell'      => 'Sell products/services',
					'inform'    => 'Inform and educate',
					'community' => 'Build community',
					'other'     => 'Other',
				);
				$goal_text   = isset( $goal_labels[ $bc['primary_goal'] ] )
					? $goal_labels[ $bc['primary_goal'] ]
					: $bc['primary_goal'];
				$lines[]     = 'Primary goal: ' . $goal_text;
			}

			$lines[] = '';
		}

		// Voice & tone.
		if ( ! empty( $relevant['voice_tone'] ) ) {
			$vt      = $relevant['voice_tone'];
			$lines[] = '### Voice & Tone';

			if ( ! empty( $vt['tone_traits'] ) ) {
				$lines[] = 'Tone: ' . implode( ', ', $vt['tone_traits'] );
			}

			if ( ! empty( $vt['pov'] ) ) {
				$pov_labels = array(
					'we_you'       => 'Write as "we" speaking to "you"',
					'i_you'        => 'Write as "I" speaking to "you"',
					'third_person' => 'Write in third person',
				);
				$pov_text   = isset( $pov_labels[ $vt['pov'] ] ) ? $pov_labels[ $vt['pov'] ] : $vt['pov'];
				$lines[]    = 'Point of view: ' . $pov_text;
			}

			if ( ! empty( $vt['readability'] ) ) {
				$read_labels = array(
					'simple'  => 'Simple (elementary level)',
					'general' => 'General audience',
					'expert'  => 'Expert/technical',
				);
				$read_text   = isset( $read_labels[ $vt['readability'] ] )
					? $read_labels[ $vt['readability'] ]
					: $vt['readability'];
				$lines[]     = 'Readability: ' . $read_text;
			}

			$lines[] = '';
		}

		// Copy rules.
		if ( ! empty( $relevant['copy_rules'] ) ) {
			$cr      = $relevant['copy_rules'];
			$lines[] = '### Copy Rules';

			if ( ! empty( $cr['dos'] ) ) {
				$lines[] = 'DO:';
				foreach ( $cr['dos'] as $rule ) {
					$lines[] = '- ' . $rule;
				}
			}

			if ( ! empty( $cr['donts'] ) ) {
				$lines[] = 'DON\'T:';
				foreach ( $cr['donts'] as $rule ) {
					$lines[] = '- ' . $rule;
				}
			}

			if ( ! empty( $cr['formatting'] ) ) {
				$format_labels = array(
					'h2s'              => 'Use H2 headings',
					'bullets'          => 'Use bullet points',
					'short_paragraphs' => 'Keep paragraphs short',
					'single_cta'       => 'Single CTA at end',
				);
				$format_items  = array();
				foreach ( $cr['formatting'] as $fmt ) {
					$format_items[] = isset( $format_labels[ $fmt ] ) ? $format_labels[ $fmt ] : $fmt;
				}
				$lines[] = 'Formatting: ' . implode( ', ', $format_items );
			}

			$lines[] = '';
		}

		// Vocabulary.
		if ( ! empty( $relevant['vocabulary'] ) ) {
			$vocab   = $relevant['vocabulary'];
			$lines[] = '### Vocabulary';

			if ( ! empty( $vocab['prefer'] ) ) {
				$lines[] = 'PREFER these terms:';
				foreach ( $vocab['prefer'] as $item ) {
					$term = is_array( $item ) ? $item['term'] : $item;
					$note = is_array( $item ) && ! empty( $item['note'] ) ? ' (' . $item['note'] . ')' : '';
					$lines[] = '- "' . $term . '"' . $note;
				}
			}

			if ( ! empty( $vocab['avoid'] ) ) {
				$lines[] = 'AVOID these terms:';
				foreach ( $vocab['avoid'] as $item ) {
					$term = is_array( $item ) ? $item['term'] : $item;
					$note = is_array( $item ) && ! empty( $item['note'] ) ? ' (' . $item['note'] . ')' : '';
					$lines[] = '- "' . $term . '"' . $note;
				}
			}

			$lines[] = '';
		}

		// Image style.
		if ( ! empty( $relevant['image_style'] ) ) {
			$img     = $relevant['image_style'];
			$lines[] = '### Image Style';

			if ( ! empty( $img['dos'] ) ) {
				$lines[] = 'Image style:';
				foreach ( $img['dos'] as $style ) {
					$lines[] = '- ' . $style;
				}
			}

			if ( ! empty( $img['donts'] ) ) {
				$lines[] = 'Avoid in images:';
				foreach ( $img['donts'] as $avoid ) {
					$lines[] = '- ' . $avoid;
				}
			}

			if ( ! empty( $img['text_policy'] ) ) {
				$text_labels = array(
					'never'             => 'Never include text in images',
					'only_if_requested' => 'Only include text if explicitly requested',
					'ok'                => 'Text in images is acceptable',
				);
				$text_text   = isset( $text_labels[ $img['text_policy'] ] )
					? $text_labels[ $img['text_policy'] ]
					: $img['text_policy'];
				$lines[]     = 'Text in images: ' . $text_text;
			}

			$lines[] = '';
		}

		// Notes.
		if ( ! empty( $relevant['notes'] ) ) {
			$lines[] = '### Additional Notes';
			$lines[] = $relevant['notes'];
			$lines[] = '';
		}

		// Block-specific notes.
		if ( ! empty( $relevant['block_notes'] ) ) {
			$block_label = isset( $relevant['_block_name'] ) ? $relevant['_block_name'] : 'Block';
			$lines[]     = sprintf( '### %s Notes', $block_label );
			$lines[]     = $relevant['block_notes'];
			$lines[]     = '';
		}

		$packet = implode( "\n", $lines );

		// Truncate if needed.
		if ( strlen( $packet ) > $max_chars ) {
			$packet = mb_substr( $packet, 0, $max_chars - 3 ) . '...';
		}

		return $packet;
	}
}
</file>

<file path="includes/class-hooks.php">
<?php
/**
 * Provider hooks for AI integration.
 *
 * @package ContentGuidelines
 */

namespace ContentGuidelines;

defined( 'ABSPATH' ) || exit;

/**
 * Manages provider hooks for AI features.
 */
class Hooks {

	/**
	 * Initialize hooks.
	 */
	public static function init() {
		// Register hook documentation for providers.
		add_action( 'init', array( __CLASS__, 'register_provider_hooks' ) );
	}

	/**
	 * Register provider hooks.
	 *
	 * This method documents the available hooks for AI providers.
	 * Providers should hook into these to supply AI functionality.
	 */
	public static function register_provider_hooks() {
		/**
		 * Filter: wp_content_guidelines_run_playground_test
		 *
		 * Allows AI providers to handle playground test tasks.
		 *
		 * @param array|null $result      The AI result. Return null if not handling.
		 * @param array      $request {
		 *     The request data.
		 *
		 *     @type string $task               The task: 'rewrite_intro', 'generate_headlines', 'write_cta'.
		 *     @type string $fixture_content    The content to work with.
		 *     @type array  $guidelines         The guidelines data.
		 *     @type array  $context_packet     The formatted context packet.
		 *     @type string $extra_instructions Optional extra instructions from user.
		 * }
		 * @return array|null {
		 *     The result if handled.
		 *
		 *     @type string $output       The generated output.
		 *     @type array  $alternatives Optional alternative outputs.
		 *     @type array  $metadata     Optional provider metadata (model, tokens, etc).
		 * }
		 */

		/**
		 * Filter: wp_content_guidelines_generate_draft
		 *
		 * Allows AI providers to generate guidelines from site content.
		 *
		 * @param array|null $draft       The generated draft. Return null if not handling.
		 * @param array      $site_context {
		 *     The site context data.
		 *
		 *     @type string $site_title   The site title.
		 *     @type string $tagline      The site tagline.
		 *     @type array  $source_posts Array of source post content.
		 * }
		 * @param array      $args {
		 *     Additional arguments.
		 *
		 *     @type string $goal        The primary goal.
		 *     @type string $constraints User-specified constraints.
		 * }
		 * @return array|null The generated guidelines draft in schema format.
		 */

		/**
		 * Filter: wp_content_guidelines_has_ai_provider
		 *
		 * Check if an AI provider is available.
		 *
		 * @param bool $has_provider Whether a provider is available.
		 * @return bool True if a provider can handle AI tasks.
		 */
		add_filter( 'wp_content_guidelines_has_ai_provider', '__return_false' );
	}

	/**
	 * Check if an AI provider is available.
	 *
	 * @return bool True if a provider is registered.
	 */
	public static function has_ai_provider() {
		/**
		 * Filter to check if an AI provider is available.
		 *
		 * @param bool $has_provider Default false.
		 */
		return apply_filters( 'wp_content_guidelines_has_ai_provider', false );
	}

	/**
	 * Generate guidelines draft using AI.
	 *
	 * @param array $site_context Site context data.
	 * @param array $args         Additional arguments.
	 * @return array|null Generated draft or null.
	 */
	public static function generate_guidelines_draft( $site_context, $args = array() ) {
		/**
		 * Filter to generate guidelines using AI.
		 *
		 * @param array|null $draft        The draft to generate.
		 * @param array      $site_context Site context.
		 * @param array      $args         Arguments.
		 */
		return apply_filters( 'wp_content_guidelines_generate_draft', null, $site_context, $args );
	}

	/**
	 * Run a playground test using AI.
	 *
	 * @param array $request The test request.
	 * @return array|null AI result or null.
	 */
	public static function run_playground_test( $request ) {
		/**
		 * Filter to run playground tests using AI.
		 *
		 * @param array|null $result  The result.
		 * @param array      $request The request.
		 */
		return apply_filters( 'wp_content_guidelines_run_playground_test', null, $request );
	}
}
</file>

<file path="includes/class-lint-checker.php">
<?php
/**
 * Lint Checker for content validation against guidelines.
 *
 * @package ContentGuidelines
 */

namespace ContentGuidelines;

defined( 'ABSPATH' ) || exit;

/**
 * Checks content against guidelines and returns validation results.
 */
class Lint_Checker {

	/**
	 * Check content against guidelines.
	 *
	 * @param string $content    The content to check.
	 * @param array  $guidelines The guidelines to check against.
	 * @return array Lint check results.
	 */
	public static function check( $content, $guidelines ) {
		$results = array(
			'issues'      => array(),
			'suggestions' => array(),
			'stats'       => array(),
		);

		if ( empty( $content ) || empty( $guidelines ) ) {
			return $results;
		}

		// Normalize content for checking.
		$content_lower = strtolower( $content );

		// Check vocabulary.
		$results = self::check_vocabulary( $content, $content_lower, $guidelines, $results );

		// Check readability.
		$results = self::check_readability( $content, $guidelines, $results );

		// Check copy rules.
		$results = self::check_copy_rules( $content, $content_lower, $guidelines, $results );

		return $results;
	}

	/**
	 * Check vocabulary usage.
	 *
	 * @param string $content       Original content.
	 * @param string $content_lower Lowercase content.
	 * @param array  $guidelines    Guidelines.
	 * @param array  $results       Current results.
	 * @return array Updated results.
	 */
	private static function check_vocabulary( $content, $content_lower, $guidelines, $results ) {
		$vocabulary = isset( $guidelines['vocabulary'] ) ? $guidelines['vocabulary'] : array();

		// Check for "avoid" terms.
		if ( ! empty( $vocabulary['avoid'] ) ) {
			foreach ( $vocabulary['avoid'] as $item ) {
				$term = is_array( $item ) ? strtolower( $item['term'] ) : strtolower( $item );
				$note = is_array( $item ) && ! empty( $item['note'] ) ? $item['note'] : '';

				if ( empty( $term ) ) {
					continue;
				}

				// Use word boundary matching.
				$pattern = '/\b' . preg_quote( $term, '/' ) . '\b/i';
				$count   = preg_match_all( $pattern, $content, $matches );

				if ( $count > 0 ) {
					$message = sprintf(
						/* translators: 1: term found, 2: count */
						_n(
							'Found "%1$s" (%2$d occurrence)',
							'Found "%1$s" (%2$d occurrences)',
							$count,
							'content-guidelines'
						),
						$term,
						$count
					);

					$results['issues'][] = array(
						'type'    => 'vocabulary_avoid',
						'term'    => $term,
						'count'   => $count,
						'message' => $message,
						'note'    => $note,
					);
				}
			}
		}

		// Check for "prefer" terms and suggest when alternatives might be used.
		if ( ! empty( $vocabulary['prefer'] ) ) {
			foreach ( $vocabulary['prefer'] as $item ) {
				$term = is_array( $item ) ? strtolower( $item['term'] ) : strtolower( $item );
				$note = is_array( $item ) && ! empty( $item['note'] ) ? $item['note'] : '';

				if ( empty( $term ) ) {
					continue;
				}

				// Check if the preferred term is present.
				$pattern = '/\b' . preg_quote( $term, '/' ) . '\b/i';
				$found   = preg_match( $pattern, $content );

				if ( ! $found && ! empty( $note ) ) {
					// The note might contain the alternative to avoid.
					$results['suggestions'][] = array(
						'type'    => 'vocabulary_prefer',
						'term'    => $term,
						'message' => sprintf(
							/* translators: %s: preferred term */
							__( 'Consider using "%s"', 'content-guidelines' ),
							$term
						),
						'note'    => $note,
					);
				}
			}
		}

		return $results;
	}

	/**
	 * Check readability.
	 *
	 * @param string $content    Original content.
	 * @param array  $guidelines Guidelines.
	 * @param array  $results    Current results.
	 * @return array Updated results.
	 */
	private static function check_readability( $content, $guidelines, $results ) {
		$voice_tone = isset( $guidelines['voice_tone'] ) ? $guidelines['voice_tone'] : array();

		// Get target readability.
		$target = isset( $voice_tone['readability'] ) ? $voice_tone['readability'] : 'general';

		// Calculate basic readability metrics.
		$sentences    = self::count_sentences( $content );
		$words        = str_word_count( $content );
		$avg_sentence = $sentences > 0 ? round( $words / $sentences, 1 ) : 0;

		$results['stats']['word_count']             = $words;
		$results['stats']['sentence_count']         = $sentences;
		$results['stats']['avg_words_per_sentence'] = $avg_sentence;

		// Check against target readability.
		$thresholds = array(
			'simple'  => 12, // Target ~12 words per sentence.
			'general' => 20, // Target ~20 words per sentence.
			'expert'  => 30, // Allow longer sentences.
		);

		$max_avg = isset( $thresholds[ $target ] ) ? $thresholds[ $target ] : 20;

		if ( $avg_sentence > $max_avg ) {
			$results['issues'][] = array(
				'type'    => 'readability',
				'message' => sprintf(
					/* translators: 1: actual average, 2: target average */
					__( 'Average sentence length is %1$s words. Target for "%2$s" readability is around %3$s words.', 'content-guidelines' ),
					$avg_sentence,
					$target,
					$max_avg
				),
				'actual'  => $avg_sentence,
				'target'  => $max_avg,
			);
		}

		// Check for very long sentences.
		$long_threshold = $max_avg * 2;
		$long_sentences = self::find_long_sentences( $content, $long_threshold );

		if ( ! empty( $long_sentences ) ) {
			$results['suggestions'][] = array(
				'type'    => 'long_sentences',
				'message' => sprintf(
					/* translators: %d: number of long sentences */
					_n(
						'%d sentence is very long and may be hard to read.',
						'%d sentences are very long and may be hard to read.',
						count( $long_sentences ),
						'content-guidelines'
					),
					count( $long_sentences )
				),
				'count'   => count( $long_sentences ),
			);
		}

		return $results;
	}

	/**
	 * Check copy rules.
	 *
	 * @param string $content       Original content.
	 * @param string $content_lower Lowercase content.
	 * @param array  $guidelines    Guidelines.
	 * @param array  $results       Current results.
	 * @return array Updated results.
	 */
	private static function check_copy_rules( $content, $content_lower, $guidelines, $results ) {
		$copy_rules = isset( $guidelines['copy_rules'] ) ? $guidelines['copy_rules'] : array();

		// Check for common "don't" patterns.
		if ( ! empty( $copy_rules['donts'] ) ) {
			// Common urgency/pressure phrases to detect.
			$urgency_patterns = array(
				'act now',
				'limited time',
				'don\'t miss',
				'hurry',
				'last chance',
				'expires soon',
				'urgent',
			);

			// Check if any donts mention urgency.
			$check_urgency = false;
			foreach ( $copy_rules['donts'] as $rule ) {
				if ( stripos( $rule, 'urgency' ) !== false || stripos( $rule, 'pressure' ) !== false ) {
					$check_urgency = true;
					break;
				}
			}

			if ( $check_urgency ) {
				foreach ( $urgency_patterns as $pattern ) {
					if ( strpos( $content_lower, $pattern ) !== false ) {
						$results['issues'][] = array(
							'type'    => 'copy_rule',
							'rule'    => 'no_urgency',
							'message' => sprintf(
								/* translators: %s: phrase found */
								__( 'Found urgency phrase: "%s"', 'content-guidelines' ),
								$pattern
							),
							'pattern' => $pattern,
						);
					}
				}
			}

			// Check for superlatives if mentioned in donts.
			$check_superlatives = false;
			foreach ( $copy_rules['donts'] as $rule ) {
				if ( stripos( $rule, 'best' ) !== false ||
					stripos( $rule, '#1' ) !== false ||
					stripos( $rule, 'superlative' ) !== false ) {
					$check_superlatives = true;
					break;
				}
			}

			if ( $check_superlatives ) {
				$superlative_patterns = array(
					'/\bbest\b/i',
					'/\b#1\b/',
					'/\bnumber one\b/i',
					'/\btop-rated\b/i',
					'/\bunbeatable\b/i',
				);

				foreach ( $superlative_patterns as $pattern ) {
					if ( preg_match( $pattern, $content, $matches ) ) {
						$results['issues'][] = array(
							'type'    => 'copy_rule',
							'rule'    => 'no_superlatives',
							'message' => sprintf(
								/* translators: %s: word found */
								__( 'Found superlative claim: "%s"', 'content-guidelines' ),
								$matches[0]
							),
							'pattern' => $matches[0],
						);
					}
				}
			}
		}

		return $results;
	}

	/**
	 * Count sentences in content.
	 *
	 * @param string $content The content.
	 * @return int Sentence count.
	 */
	private static function count_sentences( $content ) {
		// Simple sentence detection based on punctuation.
		$content   = strip_tags( $content );
		$sentences = preg_split( '/[.!?]+(?:\s|$)/', $content, -1, PREG_SPLIT_NO_EMPTY );

		return count( $sentences );
	}

	/**
	 * Find sentences longer than threshold.
	 *
	 * @param string $content   The content.
	 * @param int    $threshold Word count threshold.
	 * @return array Long sentences.
	 */
	private static function find_long_sentences( $content, $threshold ) {
		$content   = strip_tags( $content );
		$sentences = preg_split( '/([.!?]+(?:\s|$))/', $content, -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY );

		$long = array();

		foreach ( $sentences as $sentence ) {
			$word_count = str_word_count( $sentence );
			if ( $word_count > $threshold ) {
				$long[] = array(
					'sentence'   => wp_trim_words( $sentence, 15, '...' ),
					'word_count' => $word_count,
				);
			}
		}

		return $long;
	}
}
</file>

<file path="includes/class-post-type.php">
<?php
/**
 * Content Guidelines Post Type registration.
 *
 * @package ContentGuidelines
 */

namespace ContentGuidelines;

defined( 'ABSPATH' ) || exit;

/**
 * Handles the wp_content_guidelines custom post type.
 */
class Post_Type {

	/**
	 * Post type name.
	 */
	const POST_TYPE = 'wp_content_guidelines';

	/**
	 * Meta key for draft guidelines.
	 */
	const DRAFT_META_KEY = '_wp_content_guidelines_draft';

	/**
	 * Meta key for generation sources.
	 */
	const SOURCES_META_KEY = '_wp_content_guidelines_sources';

	/**
	 * Initialize the post type.
	 */
	public static function init() {
		add_action( 'init', array( __CLASS__, 'register_post_type' ) );
		add_action( 'init', array( __CLASS__, 'register_post_meta' ) );

		// Ensure revisions are always enabled for our post type, regardless of WP_POST_REVISIONS.
		add_filter( 'wp_' . self::POST_TYPE . '_revisions_to_keep', array( __CLASS__, 'enable_revisions' ) );
	}

	/**
	 * Force revisions to be enabled for this post type.
	 *
	 * This ensures revisions work even if WP_POST_REVISIONS is disabled globally.
	 *
	 * @param int $num Number of revisions to keep.
	 * @return int Number of revisions to keep (-1 for unlimited).
	 */
	public static function enable_revisions( $num ) {
		// If revisions are disabled (0), enable unlimited revisions for our post type.
		// Otherwise respect the site's setting.
		return 0 === $num ? -1 : $num;
	}

	/**
	 * Register the custom post type.
	 */
	public static function register_post_type() {
		$labels = array(
			'name'          => _x( 'Content Guidelines', 'post type general name', 'content-guidelines' ),
			'singular_name' => _x( 'Content Guidelines', 'post type singular name', 'content-guidelines' ),
		);

		$args = array(
			'labels'              => $labels,
			'public'              => false,
			'publicly_queryable'  => false,
			'show_ui'             => false,
			'show_in_menu'        => false,
			'query_var'           => false,
			'capability_type'     => 'post',
			'capabilities'        => array(
				'read'                   => 'edit_theme_options',
				'create_posts'           => 'edit_theme_options',
				'edit_posts'             => 'edit_theme_options',
				'edit_published_posts'   => 'edit_theme_options',
				'delete_posts'           => 'edit_theme_options',
				'delete_published_posts' => 'edit_theme_options',
				'edit_others_posts'      => 'edit_theme_options',
				'delete_others_posts'    => 'edit_theme_options',
				'publish_posts'          => 'edit_theme_options',
			),
			'map_meta_cap'        => true,
			'hierarchical'        => false,
			'supports'            => array( 'revisions', 'custom-fields' ),
			'has_archive'         => false,
			'rewrite'             => false,
			'show_in_rest'        => true,
			'rest_base'           => 'content-guidelines',
		);

		register_post_type( self::POST_TYPE, $args );
	}

	/**
	 * Register post meta fields.
	 */
	public static function register_post_meta() {
		register_post_meta(
			self::POST_TYPE,
			self::DRAFT_META_KEY,
			array(
				'type'              => 'object',
				'single'            => true,
				'show_in_rest'      => array(
					'schema' => self::get_guidelines_schema(),
				),
				'auth_callback'     => function () {
					return current_user_can( 'edit_theme_options' );
				},
				'sanitize_callback' => array( __CLASS__, 'sanitize_guidelines' ),
			)
		);

		register_post_meta(
			self::POST_TYPE,
			self::SOURCES_META_KEY,
			array(
				'type'          => 'array',
				'single'        => true,
				'show_in_rest'  => array(
					'schema' => array(
						'type'  => 'array',
						'items' => array(
							'type' => 'integer',
						),
					),
				),
				'auth_callback' => function () {
					return current_user_can( 'edit_theme_options' );
				},
			)
		);
	}

	/**
	 * Get the JSON schema for guidelines.
	 *
	 * @return array The schema definition.
	 */
	public static function get_guidelines_schema() {
		return array(
			'type'                 => 'object',
			'additionalProperties' => true,
			'properties'           => array(
				'version'       => array(
					'type'    => 'integer',
					'default' => 1,
				),
				'brand_context' => array(
					'type'       => 'object',
					'properties' => array(
						'site_description' => array( 'type' => 'string' ),
						'audience'         => array( 'type' => 'string' ),
						'primary_goal'     => array(
							'type' => 'string',
							'enum' => array( 'subscribe', 'sell', 'inform', 'community', 'other', '' ),
						),
						'topics'           => array(
							'type'  => 'array',
							'items' => array( 'type' => 'string' ),
						),
					),
				),
				'voice_tone'    => array(
					'type'       => 'object',
					'properties' => array(
						'tone_traits'   => array(
							'type'  => 'array',
							'items' => array( 'type' => 'string' ),
						),
						'pov'           => array(
							'type' => 'string',
							'enum' => array( 'we_you', 'i_you', 'third_person', '' ),
						),
						'readability'   => array(
							'type' => 'string',
							'enum' => array( 'simple', 'general', 'expert', '' ),
						),
						'example_good'  => array( 'type' => 'string' ),
						'example_avoid' => array( 'type' => 'string' ),
					),
				),
				'copy_rules'    => array(
					'type'       => 'object',
					'properties' => array(
						'dos'        => array(
							'type'  => 'array',
							'items' => array( 'type' => 'string' ),
						),
						'donts'      => array(
							'type'  => 'array',
							'items' => array( 'type' => 'string' ),
						),
						'formatting' => array(
							'type'  => 'array',
							'items' => array( 'type' => 'string' ),
						),
					),
				),
				'vocabulary'    => array(
					'type'       => 'object',
					'properties' => array(
						'prefer' => array(
							'type'  => 'array',
							'items' => array(
								'type'       => 'object',
								'properties' => array(
									'term' => array( 'type' => 'string' ),
									'note' => array( 'type' => 'string' ),
								),
							),
						),
						'avoid'  => array(
							'type'  => 'array',
							'items' => array(
								'type'       => 'object',
								'properties' => array(
									'term' => array( 'type' => 'string' ),
									'note' => array( 'type' => 'string' ),
								),
							),
						),
					),
				),
				'image_style'   => array(
					'type'       => 'object',
					'properties' => array(
						'dos'         => array(
							'type'  => 'array',
							'items' => array( 'type' => 'string' ),
						),
						'donts'       => array(
							'type'  => 'array',
							'items' => array( 'type' => 'string' ),
						),
						'text_policy' => array(
							'type' => 'string',
							'enum' => array( 'never', 'only_if_requested', 'ok', '' ),
						),
					),
				),
				'notes'         => array(
					'type' => 'string',
				),
				'blocks'        => array(
					'type'                 => 'object',
					'additionalProperties' => array(
						'type'       => 'object',
						'properties' => array(
							'copy_rules' => array(
								'type'       => 'object',
								'properties' => array(
									'dos'   => array(
										'type'  => 'array',
										'items' => array( 'type' => 'string' ),
									),
									'donts' => array(
										'type'  => 'array',
										'items' => array( 'type' => 'string' ),
									),
								),
							),
							'notes'      => array( 'type' => 'string' ),
						),
					),
				),
			),
		);
	}

	/**
	 * Sanitize guidelines data.
	 *
	 * @param mixed $value The value to sanitize.
	 * @return array Sanitized guidelines.
	 */
	public static function sanitize_guidelines( $value ) {
		if ( ! is_array( $value ) ) {
			return array();
		}

		// Deep sanitize string values.
		return self::deep_sanitize( $value );
	}

	/**
	 * Recursively sanitize an array.
	 *
	 * @param array $data The data to sanitize.
	 * @return array Sanitized data.
	 */
	private static function deep_sanitize( $data ) {
		$sanitized = array();

		foreach ( $data as $key => $value ) {
			$key = sanitize_key( $key );

			if ( is_array( $value ) ) {
				$sanitized[ $key ] = self::deep_sanitize( $value );
			} elseif ( is_string( $value ) ) {
				$sanitized[ $key ] = sanitize_text_field( $value );
			} elseif ( is_int( $value ) ) {
				$sanitized[ $key ] = intval( $value );
			} elseif ( is_bool( $value ) ) {
				$sanitized[ $key ] = (bool) $value;
			}
		}

		return $sanitized;
	}

	/**
	 * Get or create the guidelines post for the current site.
	 *
	 * @return \WP_Post|null The guidelines post or null on failure.
	 */
	public static function get_guidelines_post() {
		$posts = get_posts(
			array(
				'post_type'      => self::POST_TYPE,
				'posts_per_page' => 1,
				'post_status'    => array( 'publish', 'draft' ),
				'orderby'        => 'date',
				'order'          => 'DESC',
			)
		);

		if ( ! empty( $posts ) ) {
			return $posts[0];
		}

		return null;
	}

	/**
	 * Create a new guidelines post.
	 *
	 * @param array $data Optional initial guidelines data.
	 * @return int|\WP_Error The post ID or error.
	 */
	public static function create_guidelines_post( $data = array() ) {
		$post_id = wp_insert_post(
			array(
				'post_type'    => self::POST_TYPE,
				'post_status'  => 'publish',
				'post_title'   => __( 'Content Guidelines', 'content-guidelines' ),
				'post_content' => wp_json_encode( self::get_default_guidelines( $data ) ),
			),
			true
		);

		return $post_id;
	}

	/**
	 * Get default guidelines structure.
	 *
	 * @param array $overrides Optional values to merge.
	 * @return array Default guidelines.
	 */
	public static function get_default_guidelines( $overrides = array() ) {
		$defaults = array(
			'version'       => 1,
			'brand_context' => array(
				'site_description' => '',
				'audience'         => '',
				'primary_goal'     => '',
				'topics'           => array(),
			),
			'voice_tone'    => array(
				'tone_traits'   => array(),
				'pov'           => '',
				'readability'   => 'general',
				'example_good'  => '',
				'example_avoid' => '',
			),
			'copy_rules'    => array(
				'dos'        => array(),
				'donts'      => array(),
				'formatting' => array(),
			),
			'vocabulary'    => array(
				'prefer' => array(),
				'avoid'  => array(),
			),
			'image_style'   => array(
				'dos'         => array(),
				'donts'       => array(),
				'text_policy' => '',
			),
			'notes'         => '',
			'blocks'        => array(),
		);

		return array_replace_recursive( $defaults, $overrides );
	}

	/**
	 * Get active guidelines data.
	 *
	 * @return array|null Guidelines data or null.
	 */
	public static function get_active_guidelines() {
		$post = self::get_guidelines_post();

		if ( ! $post ) {
			return null;
		}

		$content = json_decode( $post->post_content, true );

		if ( json_last_error() !== JSON_ERROR_NONE || ! is_array( $content ) ) {
			return self::get_default_guidelines();
		}

		return $content;
	}

	/**
	 * Get draft guidelines data.
	 *
	 * @return array|null Draft guidelines or null.
	 */
	public static function get_draft_guidelines() {
		$post = self::get_guidelines_post();

		if ( ! $post ) {
			return null;
		}

		$draft = get_post_meta( $post->ID, self::DRAFT_META_KEY, true );

		if ( empty( $draft ) || ! is_array( $draft ) ) {
			return null;
		}

		return $draft;
	}

	/**
	 * Save draft guidelines.
	 *
	 * @param array $data The draft data.
	 * @return bool|int|\WP_Error True/post ID on success, WP_Error on failure.
	 */
	public static function save_draft( $data ) {
		$post = self::get_guidelines_post();

		// Create post if it doesn't exist.
		if ( ! $post ) {
			$post_id = self::create_guidelines_post();
			if ( is_wp_error( $post_id ) ) {
				return $post_id;
			}
			$post = get_post( $post_id );
		}

		$sanitized = self::sanitize_guidelines( $data );

		return update_post_meta( $post->ID, self::DRAFT_META_KEY, $sanitized );
	}

	/**
	 * Publish draft guidelines (promote to active).
	 *
	 * @return int|\WP_Error Post ID on success, WP_Error on failure.
	 */
	public static function publish_draft() {
		$post = self::get_guidelines_post();

		if ( ! $post ) {
			return new \WP_Error(
				'no_guidelines',
				__( 'No guidelines exist to publish.', 'content-guidelines' )
			);
		}

		$draft = self::get_draft_guidelines();

		if ( ! $draft ) {
			return new \WP_Error(
				'no_draft',
				__( 'No draft changes to publish.', 'content-guidelines' )
			);
		}

		// Update post content with draft (creates a revision).
		$result = wp_update_post(
			array(
				'ID'           => $post->ID,
				'post_content' => wp_json_encode( $draft ),
			),
			true
		);

		if ( is_wp_error( $result ) ) {
			return $result;
		}

		// Clear the draft.
		delete_post_meta( $post->ID, self::DRAFT_META_KEY );

		return $result;
	}

	/**
	 * Discard draft guidelines.
	 *
	 * @return bool True on success.
	 */
	public static function discard_draft() {
		$post = self::get_guidelines_post();

		if ( ! $post ) {
			return true;
		}

		return delete_post_meta( $post->ID, self::DRAFT_META_KEY );
	}

	/**
	 * Restore a revision as active.
	 *
	 * @param int $revision_id The revision ID to restore.
	 * @return int|\WP_Error Post ID on success, WP_Error on failure.
	 */
	public static function restore_revision( $revision_id ) {
		$revision = wp_get_post_revision( $revision_id );

		if ( ! $revision ) {
			return new \WP_Error(
				'invalid_revision',
				__( 'Invalid revision ID.', 'content-guidelines' )
			);
		}

		$post = self::get_guidelines_post();

		if ( ! $post || $revision->post_parent !== $post->ID ) {
			return new \WP_Error(
				'revision_mismatch',
				__( 'Revision does not belong to guidelines.', 'content-guidelines' )
			);
		}

		// Restore creates a new revision.
		return wp_update_post(
			array(
				'ID'           => $post->ID,
				'post_content' => $revision->post_content,
			),
			true
		);
	}
}
</file>

<file path="includes/class-rest-controller.php">
<?php
/**
 * Content Guidelines REST API Controller.
 *
 * @package ContentGuidelines
 */

namespace ContentGuidelines;

defined( 'ABSPATH' ) || exit;

/**
 * REST API controller for content guidelines.
 */
class REST_Controller {

	/**
	 * Namespace for the REST API.
	 */
	const REST_NAMESPACE = 'wp/v2';

	/**
	 * Base route.
	 */
	const REST_BASE = 'content-guidelines';

	/**
	 * Initialize the REST routes.
	 */
	public static function init() {
		add_action( 'rest_api_init', array( __CLASS__, 'register_routes' ) );
	}

	/**
	 * Register REST API routes.
	 */
	public static function register_routes() {
		// Get guidelines (active + draft + metadata).
		register_rest_route(
			self::REST_NAMESPACE,
			'/' . self::REST_BASE,
			array(
				array(
					'methods'             => \WP_REST_Server::READABLE,
					'callback'            => array( __CLASS__, 'get_guidelines' ),
					'permission_callback' => array( __CLASS__, 'can_view' ),
				),
			)
		);

		// Update draft.
		register_rest_route(
			self::REST_NAMESPACE,
			'/' . self::REST_BASE . '/draft',
			array(
				array(
					'methods'             => \WP_REST_Server::EDITABLE,
					'callback'            => array( __CLASS__, 'update_draft' ),
					'permission_callback' => array( __CLASS__, 'can_edit' ),
					'args'                => array(
						'guidelines' => array(
							'required'          => true,
							'type'              => 'object',
							'sanitize_callback' => array( Post_Type::class, 'sanitize_guidelines' ),
						),
					),
				),
			)
		);

		// Publish draft.
		register_rest_route(
			self::REST_NAMESPACE,
			'/' . self::REST_BASE . '/publish',
			array(
				array(
					'methods'             => \WP_REST_Server::CREATABLE,
					'callback'            => array( __CLASS__, 'publish_draft' ),
					'permission_callback' => array( __CLASS__, 'can_edit' ),
				),
			)
		);

		// Discard draft.
		register_rest_route(
			self::REST_NAMESPACE,
			'/' . self::REST_BASE . '/discard-draft',
			array(
				array(
					'methods'             => \WP_REST_Server::CREATABLE,
					'callback'            => array( __CLASS__, 'discard_draft' ),
					'permission_callback' => array( __CLASS__, 'can_edit' ),
				),
			)
		);

		// Get revisions.
		register_rest_route(
			self::REST_NAMESPACE,
			'/' . self::REST_BASE . '/revisions',
			array(
				array(
					'methods'             => \WP_REST_Server::READABLE,
					'callback'            => array( __CLASS__, 'get_revisions' ),
					'permission_callback' => array( __CLASS__, 'can_view' ),
				),
			)
		);

		// Restore revision.
		register_rest_route(
			self::REST_NAMESPACE,
			'/' . self::REST_BASE . '/restore/(?P<id>[\d]+)',
			array(
				array(
					'methods'             => \WP_REST_Server::CREATABLE,
					'callback'            => array( __CLASS__, 'restore_revision' ),
					'permission_callback' => array( __CLASS__, 'can_edit' ),
					'args'                => array(
						'id' => array(
							'required'          => true,
							'type'              => 'integer',
							'sanitize_callback' => 'absint',
						),
					),
				),
			)
		);

		// Get context packet.
		register_rest_route(
			self::REST_NAMESPACE,
			'/' . self::REST_BASE . '/packet',
			array(
				array(
					'methods'             => \WP_REST_Server::READABLE,
					'callback'            => array( __CLASS__, 'get_packet' ),
					'permission_callback' => array( __CLASS__, 'can_view' ),
					'args'                => array(
						'task'       => array(
							'type'    => 'string',
							'default' => 'writing',
							'enum'    => array( 'writing', 'headline', 'cta', 'image', 'coach' ),
						),
						'post_id'    => array(
							'type'              => 'integer',
							'sanitize_callback' => 'absint',
						),
						'use'        => array(
							'type'    => 'string',
							'default' => 'active',
							'enum'    => array( 'active', 'draft' ),
						),
						'max_chars'  => array(
							'type'    => 'integer',
							'default' => 2000,
						),
						'block_name' => array(
							'type'              => 'string',
							'sanitize_callback' => 'sanitize_text_field',
							'description'       => 'Block name for block-specific guidelines (e.g., core/paragraph).',
						),
					),
				),
			)
		);

		// Run playground test (lint checks, optionally AI).
		register_rest_route(
			self::REST_NAMESPACE,
			'/' . self::REST_BASE . '/test',
			array(
				array(
					'methods'             => \WP_REST_Server::CREATABLE,
					'callback'            => array( __CLASS__, 'run_test' ),
					'permission_callback' => array( __CLASS__, 'can_edit' ),
					'args'                => array(
						'task'               => array(
							'type'    => 'string',
							'default' => 'rewrite_intro',
							'enum'    => array( 'rewrite_intro', 'generate_headlines', 'write_cta' ),
						),
						'fixture_post_id'    => array(
							'type'              => 'integer',
							'required'          => true,
							'sanitize_callback' => 'absint',
						),
						'use'                => array(
							'type'    => 'string',
							'default' => 'draft',
							'enum'    => array( 'active', 'draft' ),
						),
						'compare'            => array(
							'type'    => 'boolean',
							'default' => false,
						),
						'extra_instructions' => array(
							'type'              => 'string',
							'sanitize_callback' => 'sanitize_textarea_field',
						),
					),
				),
			)
		);

		// Get guidelines for a specific post (with block analysis).
		register_rest_route(
			self::REST_NAMESPACE,
			'/' . self::REST_BASE . '/for-post/(?P<post_id>[\d]+)',
			array(
				array(
					'methods'             => \WP_REST_Server::READABLE,
					'callback'            => array( __CLASS__, 'get_post_guidelines' ),
					'permission_callback' => array( __CLASS__, 'can_view' ),
					'args'                => array(
						'post_id' => array(
							'required'          => true,
							'type'              => 'integer',
							'sanitize_callback' => 'absint',
							'description'       => 'The post ID to get guidelines for.',
						),
						'task'    => array(
							'type'    => 'string',
							'default' => 'writing',
							'enum'    => array( 'writing', 'headline', 'cta', 'image', 'coach' ),
						),
						'use'     => array(
							'type'    => 'string',
							'default' => 'active',
							'enum'    => array( 'active', 'draft' ),
						),
					),
				),
			)
		);

		// Get guidelines for multiple blocks (batch endpoint).
		register_rest_route(
			self::REST_NAMESPACE,
			'/' . self::REST_BASE . '/blocks',
			array(
				array(
					'methods'             => \WP_REST_Server::READABLE,
					'callback'            => array( __CLASS__, 'get_blocks_guidelines' ),
					'permission_callback' => array( __CLASS__, 'can_view' ),
					'args'                => array(
						'blocks' => array(
							'required'          => true,
							'type'              => 'array',
							'items'             => array( 'type' => 'string' ),
							'description'       => 'Array of block names to get guidelines for.',
							'sanitize_callback' => function ( $value ) {
								if ( is_string( $value ) ) {
									$value = explode( ',', $value );
								}
								return array_map( 'sanitize_text_field', (array) $value );
							},
						),
						'task'   => array(
							'type'    => 'string',
							'default' => 'writing',
							'enum'    => array( 'writing', 'headline', 'cta', 'image', 'coach' ),
						),
						'use'    => array(
							'type'    => 'string',
							'default' => 'active',
							'enum'    => array( 'active', 'draft' ),
						),
					),
				),
			)
		);
	}

	/**
	 * Check if user can view guidelines.
	 *
	 * @return bool True if can view.
	 */
	public static function can_view() {
		return current_user_can( 'edit_theme_options' );
	}

	/**
	 * Check if user can edit guidelines.
	 *
	 * @return bool True if can edit.
	 */
	public static function can_edit() {
		return current_user_can( 'edit_theme_options' );
	}

	/**
	 * Get guidelines (active + draft + metadata).
	 *
	 * @param \WP_REST_Request $request The request object.
	 * @return \WP_REST_Response|\WP_Error Response or error.
	 */
	public static function get_guidelines( $request ) {
		$post   = Post_Type::get_guidelines_post();
		$active = Post_Type::get_active_guidelines();
		$draft  = Post_Type::get_draft_guidelines();

		$response = array(
			'active'         => $active ? $active : Post_Type::get_default_guidelines(),
			'draft'          => $draft,
			'has_draft'      => ! empty( $draft ),
			'post_id'        => $post ? $post->ID : null,
			'updated_at'     => $post ? $post->post_modified_gmt : null,
			'revision_count' => $post ? count( wp_get_post_revisions( $post->ID, array( 'check_enabled' => false ) ) ) : 0,
		);

		return rest_ensure_response( $response );
	}

	/**
	 * Update draft guidelines.
	 *
	 * @param \WP_REST_Request $request The request object.
	 * @return \WP_REST_Response|\WP_Error Response or error.
	 */
	public static function update_draft( $request ) {
		$guidelines = $request->get_param( 'guidelines' );
		$result     = Post_Type::save_draft( $guidelines );

		if ( is_wp_error( $result ) ) {
			return $result;
		}

		return rest_ensure_response(
			array(
				'success' => true,
				'message' => __( 'Draft saved.', 'content-guidelines' ),
			)
		);
	}

	/**
	 * Publish draft guidelines.
	 *
	 * @param \WP_REST_Request $request The request object.
	 * @return \WP_REST_Response|\WP_Error Response or error.
	 */
	public static function publish_draft( $request ) {
		$result = Post_Type::publish_draft();

		if ( is_wp_error( $result ) ) {
			return $result;
		}

		return rest_ensure_response(
			array(
				'success' => true,
				'post_id' => $result,
				'message' => __( 'Guidelines published.', 'content-guidelines' ),
			)
		);
	}

	/**
	 * Discard draft guidelines.
	 *
	 * @param \WP_REST_Request $request The request object.
	 * @return \WP_REST_Response|\WP_Error Response or error.
	 */
	public static function discard_draft( $request ) {
		Post_Type::discard_draft();

		return rest_ensure_response(
			array(
				'success' => true,
				'message' => __( 'Draft discarded.', 'content-guidelines' ),
			)
		);
	}

	/**
	 * Get revision history.
	 *
	 * @param \WP_REST_Request $request The request object.
	 * @return \WP_REST_Response|\WP_Error Response or error.
	 */
	public static function get_revisions( $request ) {
		$post = Post_Type::get_guidelines_post();

		if ( ! $post ) {
			return rest_ensure_response( array() );
		}

		$revisions = wp_get_post_revisions(
			$post->ID,
			array(
				'order'         => 'DESC',
				'orderby'       => 'date',
				'check_enabled' => false, // Bypass WP_POST_REVISIONS check - we support revisions via post_type_supports.
			)
		);

		$items = array();

		foreach ( $revisions as $revision ) {
			$author = get_userdata( $revision->post_author );

			$items[] = array(
				'id'          => $revision->ID,
				'author'      => array(
					'id'   => $revision->post_author,
					'name' => $author ? $author->display_name : __( 'Unknown', 'content-guidelines' ),
				),
				'date'        => $revision->post_date,
				'date_gmt'    => $revision->post_date_gmt,
				'modified'    => $revision->post_modified,
				'modified_gmt' => $revision->post_modified_gmt,
			);
		}

		return rest_ensure_response( $items );
	}

	/**
	 * Restore a revision.
	 *
	 * @param \WP_REST_Request $request The request object.
	 * @return \WP_REST_Response|\WP_Error Response or error.
	 */
	public static function restore_revision( $request ) {
		$revision_id = $request->get_param( 'id' );
		$result      = Post_Type::restore_revision( $revision_id );

		if ( is_wp_error( $result ) ) {
			return $result;
		}

		return rest_ensure_response(
			array(
				'success' => true,
				'post_id' => $result,
				'message' => __( 'Revision restored.', 'content-guidelines' ),
			)
		);
	}

	/**
	 * Get context packet for AI consumption.
	 *
	 * @param \WP_REST_Request $request The request object.
	 * @return \WP_REST_Response Response.
	 */
	public static function get_packet( $request ) {
		$packet = Context_Packet_Builder::get_packet(
			array(
				'task'       => $request->get_param( 'task' ),
				'post_id'    => $request->get_param( 'post_id' ),
				'use'        => $request->get_param( 'use' ),
				'max_chars'  => $request->get_param( 'max_chars' ),
				'block_name' => $request->get_param( 'block_name' ),
			)
		);

		return rest_ensure_response( $packet );
	}

	/**
	 * Run playground test.
	 *
	 * @param \WP_REST_Request $request The request object.
	 * @return \WP_REST_Response|\WP_Error Response or error.
	 */
	public static function run_test( $request ) {
		$task               = $request->get_param( 'task' );
		$fixture_post_id    = $request->get_param( 'fixture_post_id' );
		$use                = $request->get_param( 'use' );
		$compare            = $request->get_param( 'compare' );
		$extra_instructions = $request->get_param( 'extra_instructions' );

		$fixture_post = get_post( $fixture_post_id );

		if ( ! $fixture_post ) {
			return new \WP_Error(
				'invalid_fixture',
				__( 'Invalid fixture post.', 'content-guidelines' )
			);
		}

		// Get guidelines.
		$guidelines = 'draft' === $use
			? Post_Type::get_draft_guidelines()
			: Post_Type::get_active_guidelines();

		if ( ! $guidelines ) {
			$guidelines = Post_Type::get_default_guidelines();
		}

		// Extract fixture content.
		$fixture_content = self::extract_fixture_content( $fixture_post, $task );

		// Run local lint checks (always available).
		$lint_results = Lint_Checker::check( $fixture_content, $guidelines );

		// Build context packet.
		$context_packet = Context_Packet_Builder::get_packet(
			array(
				'task'    => self::map_playground_task( $task ),
				'post_id' => $fixture_post_id,
				'use'     => $use,
			)
		);

		// Prepare the result.
		$result = array(
			'lint_results'   => $lint_results,
			'context_packet' => $context_packet,
			'fixture'        => array(
				'title'   => $fixture_post->post_title,
				'excerpt' => wp_trim_words( $fixture_content, 100 ),
			),
		);

		// Try to run AI-powered test if a provider is available.
		$ai_request = array(
			'task'               => $task,
			'fixture_content'    => $fixture_content,
			'guidelines'         => $guidelines,
			'context_packet'     => $context_packet,
			'extra_instructions' => $extra_instructions,
		);

		/**
		 * Filter to run AI-powered playground tests.
		 *
		 * Providers should hook into this to supply AI-generated results.
		 *
		 * @param array|null $ai_result The AI result (null if no provider).
		 * @param array      $ai_request The request data.
		 */
		$ai_result = apply_filters( 'wp_content_guidelines_run_playground_test', null, $ai_request );

		if ( null !== $ai_result ) {
			$result['ai_result'] = $ai_result;
		} else {
			$result['ai_available'] = false;
			$result['ai_message']   = __( 'No AI provider connected. Showing lint checks and context preview only.', 'content-guidelines' );
		}

		// If compare mode, also get active guidelines results.
		if ( $compare && 'draft' === $use ) {
			$active_guidelines = Post_Type::get_active_guidelines();

			if ( $active_guidelines ) {
				$active_lint = Lint_Checker::check( $fixture_content, $active_guidelines );
				$active_packet = Context_Packet_Builder::get_packet(
					array(
						'task'    => self::map_playground_task( $task ),
						'post_id' => $fixture_post_id,
						'use'     => 'active',
					)
				);

				$result['compare'] = array(
					'lint_results'   => $active_lint,
					'context_packet' => $active_packet,
				);

				// Also run AI compare if available.
				$active_ai_request = array(
					'task'               => $task,
					'fixture_content'    => $fixture_content,
					'guidelines'         => $active_guidelines,
					'context_packet'     => $active_packet,
					'extra_instructions' => $extra_instructions,
				);

				$active_ai_result = apply_filters( 'wp_content_guidelines_run_playground_test', null, $active_ai_request );

				if ( null !== $active_ai_result ) {
					$result['compare']['ai_result'] = $active_ai_result;
				}
			}
		}

		return rest_ensure_response( $result );
	}

	/**
	 * Extract content from fixture post for a specific task.
	 *
	 * @param \WP_Post $post The post object.
	 * @param string   $task The task type.
	 * @return string The extracted content.
	 */
	private static function extract_fixture_content( $post, $task ) {
		$content = $post->post_content;

		// Strip blocks and get plain text.
		$content = wp_strip_all_tags( do_blocks( $content ) );

		switch ( $task ) {
			case 'rewrite_intro':
				// Get first ~500 characters.
				return mb_substr( $content, 0, 500 );

			case 'generate_headlines':
				// Get title + excerpt for context.
				return $post->post_title . "\n\n" . wp_trim_words( $content, 150 );

			case 'write_cta':
				// Get full content (limited).
				return wp_trim_words( $content, 300 );

			default:
				return wp_trim_words( $content, 200 );
		}
	}

	/**
	 * Map playground task to context packet task type.
	 *
	 * @param string $playground_task The playground task.
	 * @return string The context packet task.
	 */
	private static function map_playground_task( $playground_task ) {
		$map = array(
			'rewrite_intro'      => 'writing',
			'generate_headlines' => 'headline',
			'write_cta'          => 'cta',
		);

		return isset( $map[ $playground_task ] ) ? $map[ $playground_task ] : 'writing';
	}

	/**
	 * Get guidelines for a specific post with block analysis.
	 *
	 * Analyzes the blocks in a post and returns a context packet with
	 * both site-level and block-specific guidelines merged.
	 *
	 * @param \WP_REST_Request $request The request object.
	 * @return \WP_REST_Response|\WP_Error Response or error.
	 */
	public static function get_post_guidelines( $request ) {
		$post_id = $request->get_param( 'post_id' );
		$post    = get_post( $post_id );

		if ( ! $post ) {
			return new \WP_Error(
				'invalid_post',
				__( 'Post not found.', 'content-guidelines' ),
				array( 'status' => 404 )
			);
		}

		$result = \ContentGuidelines\get_content_guidelines_for_post(
			$post,
			array(
				'task' => $request->get_param( 'task' ),
				'use'  => $request->get_param( 'use' ),
			)
		);

		return rest_ensure_response( $result );
	}

	/**
	 * Get guidelines for multiple blocks (batch endpoint).
	 *
	 * Returns site-level and block-specific guidelines for the requested
	 * block types. Useful for agents working with specific blocks.
	 *
	 * @param \WP_REST_Request $request The request object.
	 * @return \WP_REST_Response Response.
	 */
	public static function get_blocks_guidelines( $request ) {
		$block_names = $request->get_param( 'blocks' );

		$result = \ContentGuidelines\get_block_guidelines(
			$block_names,
			array(
				'task' => $request->get_param( 'task' ),
				'use'  => $request->get_param( 'use' ),
			)
		);

		return rest_ensure_response( $result );
	}
}
</file>

<file path="src/commands/index.js">
/**
 * WordPress 6.9 Command Palette integration.
 *
 * Registers commands for the admin-wide Command Palette (Ctrl/Cmd + K).
 * These commands allow quick access to Content Guidelines functionality
 * from anywhere in the WordPress admin.
 *
 * @package ContentGuidelines
 * @since 0.2.0
 */

/**
 * WordPress dependencies
 */
import { useCommand, useCommandLoader } from '@wordpress/commands';
import { __ } from '@wordpress/i18n';
import { useSelect } from '@wordpress/data';
import { store as noticesStore } from '@wordpress/notices';
import { useDispatch } from '@wordpress/data';
import {
	edit,
	backup,
	check,
	settings,
	page,
	pencil,
	seen,
	external,
} from '@wordpress/icons';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../store';

/**
 * Hook to register static Content Guidelines commands.
 *
 * These commands are always available in the Command Palette
 * when Content Guidelines is active.
 */
export function useContentGuidelinesCommands() {
	// Navigation commands
	useCommand( {
		name: 'content-guidelines/open-guidelines',
		label: __( 'Open Content Guidelines', 'content-guidelines' ),
		icon: edit,
		callback: ( { close } ) => {
			window.location.href = 'themes.php?page=content-guidelines-wp-admin';
			close();
		},
		context: 'site-editor',
	} );

	useCommand( {
		name: 'content-guidelines/open-guidelines-history',
		label: __( 'View Guidelines History', 'content-guidelines' ),
		icon: backup,
		callback: ( { close } ) => {
			window.location.href =
				'themes.php?page=content-guidelines-wp-admin#/history';
			close();
		},
	} );

	useCommand( {
		name: 'content-guidelines/open-playground',
		label: __( 'Open Guidelines Playground', 'content-guidelines' ),
		icon: seen,
		callback: ( { close } ) => {
			window.location.href =
				'themes.php?page=content-guidelines-wp-admin#/playground';
			close();
		},
	} );
}

/**
 * Hook to register dynamic commands based on guidelines state.
 *
 * Uses useCommandLoader to provide commands that depend on current state,
 * such as publish/discard draft commands that only appear when a draft exists.
 */
export function useContentGuidelinesDynamicCommands() {
	const { hasDraftValue, isLoading } = useSelect( ( select ) => {
		const store = select( STORE_NAME );
		return {
			hasDraftValue: store?.hasDraft?.() ?? false,
			isLoading: store?.isResolving?.( 'getGuidelines' ) ?? false,
		};
	}, [] );

	// Register draft-related commands dynamically
	useCommandLoader( {
		name: 'content-guidelines/draft-commands',
		hook: useContentGuidelinesDraftCommands,
		context: 'site-editor',
	} );
}

/**
 * Command loader hook for draft-related commands.
 *
 * @return {Object} Commands configuration for the loader.
 */
function useContentGuidelinesDraftCommands() {
	const { hasDraftValue } = useSelect( ( select ) => {
		const store = select( STORE_NAME );
		return {
			hasDraftValue: store?.hasDraft?.() ?? false,
		};
	}, [] );

	const { createSuccessNotice, createErrorNotice } =
		useDispatch( noticesStore );

	const commands = [];

	if ( hasDraftValue ) {
		commands.push( {
			name: 'content-guidelines/publish-draft',
			label: __( 'Publish Guidelines Draft', 'content-guidelines' ),
			icon: check,
			callback: async ( { close } ) => {
				try {
					const response = await wp.apiFetch( {
						path: '/wp/v2/content-guidelines/publish',
						method: 'POST',
					} );

					if ( response.success ) {
						createSuccessNotice(
							__( 'Guidelines published.', 'content-guidelines' ),
							{ type: 'snackbar' }
						);
					}
				} catch ( error ) {
					createErrorNotice(
						__(
							'Failed to publish guidelines.',
							'content-guidelines'
						),
						{ type: 'snackbar' }
					);
				}
				close();
			},
		} );

		commands.push( {
			name: 'content-guidelines/discard-draft',
			label: __( 'Discard Guidelines Draft', 'content-guidelines' ),
			icon: page,
			callback: async ( { close } ) => {
				try {
					const response = await wp.apiFetch( {
						path: '/wp/v2/content-guidelines/discard-draft',
						method: 'POST',
					} );

					if ( response.success ) {
						createSuccessNotice(
							__( 'Draft discarded.', 'content-guidelines' ),
							{ type: 'snackbar' }
						);
					}
				} catch ( error ) {
					createErrorNotice(
						__( 'Failed to discard draft.', 'content-guidelines' ),
						{ type: 'snackbar' }
					);
				}
				close();
			},
		} );
	}

	return {
		commands,
		isLoading: false,
	};
}

/**
 * Hook to register post-context commands.
 *
 * These commands appear when editing a post and allow
 * running guidelines checks on the current content.
 */
export function useContentGuidelinesPostCommands() {
	useCommandLoader( {
		name: 'content-guidelines/post-commands',
		hook: usePostContextCommands,
		context: 'post-editor',
	} );
}

/**
 * Command loader hook for post editing context.
 *
 * @return {Object} Commands configuration.
 */
function usePostContextCommands() {
	const { currentPostId, currentPostType } = useSelect( ( select ) => {
		const editor = select( 'core/editor' );
		return {
			currentPostId: editor?.getCurrentPostId?.() ?? null,
			currentPostType: editor?.getCurrentPostType?.() ?? null,
		};
	}, [] );

	const { createSuccessNotice, createErrorNotice } =
		useDispatch( noticesStore );

	const commands = [];

	if ( currentPostId && currentPostType === 'post' ) {
		commands.push( {
			name: 'content-guidelines/check-post-guidelines',
			label: __( 'Check Post Against Guidelines', 'content-guidelines' ),
			icon: pencil,
			callback: async ( { close } ) => {
				try {
					const response = await wp.apiFetch( {
						path: '/wp/v2/content-guidelines/test',
						method: 'POST',
						data: {
							task: 'rewrite_intro',
							fixture_post_id: currentPostId,
							use: 'active',
						},
					} );

					const issueCount = response.lint_results?.issue_count ?? 0;

					if ( issueCount === 0 ) {
						createSuccessNotice(
							__(
								'Content passes all guidelines checks!',
								'content-guidelines'
							),
							{ type: 'snackbar' }
						);
					} else {
						createErrorNotice(
							`${ issueCount } ${ __(
								'guideline issues found. Open Content Guidelines to review.',
								'content-guidelines'
							) }`,
							{
								type: 'snackbar',
								actions: [
									{
										label: __( 'View', 'content-guidelines' ),
										url: 'themes.php?page=content-guidelines-wp-admin#/playground',
									},
								],
							}
						);
					}
				} catch ( error ) {
					createErrorNotice(
						__(
							'Failed to check guidelines.',
							'content-guidelines'
						),
						{ type: 'snackbar' }
					);
				}
				close();
			},
		} );

		commands.push( {
			name: 'content-guidelines/test-post-in-playground',
			label: __(
				'Test Current Post in Guidelines Playground',
				'content-guidelines'
			),
			icon: external,
			callback: ( { close } ) => {
				window.location.href = `themes.php?page=content-guidelines-wp-admin#/playground?post=${ currentPostId }`;
				close();
			},
		} );
	}

	return {
		commands,
		isLoading: false,
	};
}

/**
 * Register all Content Guidelines commands.
 *
 * This component should be rendered once to register all commands.
 * It uses React hooks internally to register with the Command Palette.
 */
export default function ContentGuidelinesCommands() {
	useContentGuidelinesCommands();
	useContentGuidelinesDynamicCommands();
	useContentGuidelinesPostCommands();

	// This component doesn't render anything
	return null;
}
</file>

<file path="src/components/controls/repeater-control/index.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useState } from '@wordpress/element';
import {
	Button,
	TextControl,
	__experimentalVStack as VStack,
	__experimentalHStack as HStack,
	__experimentalText as Text,
} from '@wordpress/components';
import { plus, closeSmall } from '@wordpress/icons';

/**
 * Internal dependencies
 */
import './style.scss';

/**
 * Repeater control for managing a list of text items.
 *
 * @param {Object}   props             Component props.
 * @param {string}   props.label       Field label.
 * @param {Array}    props.items       Array of string items.
 * @param {Function} props.onChange    Change handler.
 * @param {string}   props.placeholder Placeholder text for new items.
 * @return {JSX.Element} Repeater control.
 */
export default function RepeaterControl( {
	label,
	items = [],
	onChange,
	placeholder = '',
} ) {
	const [ newItem, setNewItem ] = useState( '' );

	const addItem = () => {
		if ( newItem.trim() ) {
			onChange( [ ...items, newItem.trim() ] );
			setNewItem( '' );
		}
	};

	const removeItem = ( index ) => {
		const newItems = [ ...items ];
		newItems.splice( index, 1 );
		onChange( newItems );
	};

	const updateItem = ( index, value ) => {
		const newItems = [ ...items ];
		newItems[ index ] = value;
		onChange( newItems );
	};

	const handleKeyDown = ( event ) => {
		if ( event.key === 'Enter' ) {
			event.preventDefault();
			addItem();
		}
	};

	return (
		<div className="repeater-control">
			{ label && (
				<Text className="repeater-control__label">{ label }</Text>
			) }
			<VStack spacing={ 2 }>
				{ items.map( ( item, index ) => (
					<HStack key={ index } spacing={ 2 } alignment="center">
						<TextControl
							__nextHasNoMarginBottom
							className="repeater-control__input"
							value={ item }
							onChange={ ( value ) => updateItem( index, value ) }
						/>
						<Button
							icon={ closeSmall }
							label={ __( 'Remove', 'content-guidelines' ) }
							onClick={ () => removeItem( index ) }
							size="small"
							className="repeater-control__remove"
						/>
					</HStack>
				) ) }
				<HStack spacing={ 2 } alignment="center">
					<TextControl
						__nextHasNoMarginBottom
						className="repeater-control__input"
						value={ newItem }
						onChange={ setNewItem }
						placeholder={ placeholder }
						onKeyDown={ handleKeyDown }
					/>
					<Button
						icon={ plus }
						label={ __( 'Add', 'content-guidelines' ) }
						onClick={ addItem }
						size="small"
						className="repeater-control__add"
						disabled={ ! newItem.trim() }
					/>
				</HStack>
			</VStack>
		</div>
	);
}
</file>

<file path="src/components/controls/repeater-control/style.scss">
// Repeater control styles

.repeater-control {
	width: 100%;
}

.repeater-control__label {
	display: block;
	font-size: 11px;
	font-weight: 500;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	color: #757575;
	margin-bottom: 8px;
}

.repeater-control__input {
	flex-grow: 1;

	.components-text-control__input {
		font-size: 13px;
	}
}

.repeater-control__remove,
.repeater-control__add {
	flex-shrink: 0;

	&:hover {
		color: var(--wp-admin-theme-color, #3858e9);
	}
}

.repeater-control__remove {
	&:hover {
		color: #cc1818;
	}
}
</file>

<file path="src/components/guidelines-screen/empty-state.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { Button } from '@wordpress/components';
import { useDispatch } from '@wordpress/data';
import { pencil } from '@wordpress/icons';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';

/**
 * Default empty guidelines structure.
 */
const DEFAULT_GUIDELINES = {
	version: 1,
	brand_context: {
		site_description: '',
		audience: '',
		primary_goal: '',
		topics: [],
	},
	voice_tone: {
		tone_traits: [],
		pov: '',
		readability: 'general',
		example_good: '',
		example_avoid: '',
	},
	copy_rules: {
		dos: [],
		donts: [],
		formatting: [],
	},
	vocabulary: {
		prefer: [],
		avoid: [],
	},
	image_style: {
		dos: [],
		donts: [],
		text_policy: '',
	},
	notes: '',
};

/**
 * Empty state component shown when no guidelines exist.
 *
 * @return {JSX.Element} Empty state component.
 */
export default function EmptyState() {
	const { setDraft } = useDispatch( STORE_NAME );

	const handleStartWriting = () => {
		setDraft( { ...DEFAULT_GUIDELINES } );
	};

	return (
		<div className="content-guidelines-empty-state">
			<div className="content-guidelines-empty-state__icon">
				<span role="img" aria-label="pencil">
					
				</span>
			</div>

			<h2 className="content-guidelines-empty-state__title">
				{ __( 'Set Content Guidelines', 'content-guidelines' ) }
			</h2>

			<p className="content-guidelines-empty-state__description">
				{ __(
					'Guidelines keep AI outputs consistent with your site\'s voice and brand. Define your tone, rules, and vocabulary once, and AI features will use them automatically.',
					'content-guidelines'
				) }
			</p>

			<div className="content-guidelines-empty-state__actions">
				<Button
					variant="primary"
					icon={ pencil }
					onClick={ handleStartWriting }
				>
					{ __( 'Start writing', 'content-guidelines' ) }
				</Button>
			</div>

			<p className="content-guidelines-empty-state__note">
				{ __(
					'AI-powered generation requires an AI provider plugin.',
					'content-guidelines'
				) }
			</p>
		</div>
	);
}
</file>

<file path="src/components/guidelines-screen/header.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useDispatch, useSelect } from '@wordpress/data';
import {
	Button,
	DropdownMenu,
	MenuGroup,
	MenuItem,
	Modal,
} from '@wordpress/components';
import { moreVertical, backup, download, upload } from '@wordpress/icons';
import { useState } from '@wordpress/element';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';

/**
 * Header component with actions.
 *
 * @param {Object}   props               Component props.
 * @param {boolean}  props.hasDraft      Whether draft exists.
 * @param {boolean}  props.isSaving      Whether saving.
 * @param {boolean}  props.isPublishing  Whether publishing.
 * @param {Function} props.onShowHistory Callback to show history.
 * @return {JSX.Element} Header component.
 */
export default function Header( {
	hasDraft,
	isSaving,
	isPublishing,
	onShowHistory,
} ) {
	const [ showPublishConfirm, setShowPublishConfirm ] = useState( false );
	const [ showDiscardConfirm, setShowDiscardConfirm ] = useState( false );

	const { draftHasChanges } = useSelect( ( select ) => {
		return {
			draftHasChanges: select( STORE_NAME ).draftHasChanges(),
		};
	}, [] );

	const { saveDraft, publishDraft, discardDraft } = useDispatch( STORE_NAME );

	const handleSaveDraft = () => {
		saveDraft();
	};

	const handlePublish = () => {
		setShowPublishConfirm( true );
	};

	const confirmPublish = () => {
		publishDraft();
		setShowPublishConfirm( false );
	};

	const handleDiscard = () => {
		setShowDiscardConfirm( true );
	};

	const confirmDiscard = () => {
		discardDraft();
		setShowDiscardConfirm( false );
	};

	return (
		<div className="content-guidelines-header">
			<div className="content-guidelines-header__left">
				<h1 className="content-guidelines-header__title">
					{ __( 'Content Guidelines', 'content-guidelines' ) }
				</h1>

				{ hasDraft && draftHasChanges && (
					<span className="content-guidelines-header__status content-guidelines-header__status--draft">
						{ __( 'Draft changes', 'content-guidelines' ) }
					</span>
				) }

				{ ! hasDraft && (
					<span className="content-guidelines-header__status content-guidelines-header__status--active">
						{ __( 'Active', 'content-guidelines' ) }
					</span>
				) }
			</div>

			<div className="content-guidelines-header__actions">
				{ draftHasChanges && (
					<Button
						variant="tertiary"
						onClick={ handleDiscard }
						disabled={ isSaving || isPublishing }
					>
						{ __( 'Discard', 'content-guidelines' ) }
					</Button>
				) }

				<Button
					variant="secondary"
					onClick={ handleSaveDraft }
					isBusy={ isSaving }
					disabled={ isSaving || isPublishing || ! draftHasChanges }
				>
					{ isSaving
						? __( 'Saving...', 'content-guidelines' )
						: __( 'Save draft', 'content-guidelines' ) }
				</Button>

				<Button
					variant="primary"
					onClick={ handlePublish }
					isBusy={ isPublishing }
					disabled={ isSaving || isPublishing || ! draftHasChanges }
				>
					{ isPublishing
						? __( 'Publishing...', 'content-guidelines' )
						: __( 'Publish', 'content-guidelines' ) }
				</Button>

				<DropdownMenu
					icon={ moreVertical }
					label={ __( 'More options', 'content-guidelines' ) }
				>
					{ ( { onClose } ) => (
						<MenuGroup>
							<MenuItem
								icon={ backup }
								onClick={ () => {
									onShowHistory();
									onClose();
								} }
							>
								{ __( 'History', 'content-guidelines' ) }
							</MenuItem>
							<MenuItem
								icon={ download }
								onClick={ () => {
									// Export functionality.
									onClose();
								} }
							>
								{ __( 'Export', 'content-guidelines' ) }
							</MenuItem>
							<MenuItem
								icon={ upload }
								onClick={ () => {
									// Import functionality.
									onClose();
								} }
							>
								{ __( 'Import', 'content-guidelines' ) }
							</MenuItem>
						</MenuGroup>
					) }
				</DropdownMenu>
			</div>

			{ showPublishConfirm && (
				<Modal
					title={ __( 'Publish guidelines?', 'content-guidelines' ) }
					onRequestClose={ () => setShowPublishConfirm( false ) }
					size="small"
				>
					<p>
						{ __(
							'This will make your draft changes the active guidelines for all AI features.',
							'content-guidelines'
						) }
					</p>
					<div className="content-guidelines-modal__actions">
						<Button
							variant="tertiary"
							onClick={ () => setShowPublishConfirm( false ) }
						>
							{ __( 'Cancel', 'content-guidelines' ) }
						</Button>
						<Button variant="primary" onClick={ confirmPublish }>
							{ __( 'Publish', 'content-guidelines' ) }
						</Button>
					</div>
				</Modal>
			) }

			{ showDiscardConfirm && (
				<Modal
					title={ __( 'Discard draft?', 'content-guidelines' ) }
					onRequestClose={ () => setShowDiscardConfirm( false ) }
					size="small"
				>
					<p>
						{ __(
							'This will discard all unsaved changes. This action cannot be undone.',
							'content-guidelines'
						) }
					</p>
					<div className="content-guidelines-modal__actions">
						<Button
							variant="tertiary"
							onClick={ () => setShowDiscardConfirm( false ) }
						>
							{ __( 'Cancel', 'content-guidelines' ) }
						</Button>
						<Button isDestructive onClick={ confirmDiscard }>
							{ __( 'Discard', 'content-guidelines' ) }
						</Button>
					</div>
				</Modal>
			) }
		</div>
	);
}
</file>

<file path="src/components/guidelines-screen/index.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import { useEffect, useState } from '@wordpress/element';
import {
	TabPanel,
	Spinner,
	Notice,
} from '@wordpress/components';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';
import Header from './header';
import Sidebar from './sidebar';
import PreviewCanvas from './preview-canvas';
import HistoryPanel from '../history';
import './style.scss';

/**
 * Main guidelines screen component.
 *
 * @return {JSX.Element} The guidelines screen.
 */
export default function GuidelinesScreen() {
	const [ showHistory, setShowHistory ] = useState( false );
	const [ fixturePostId, setFixturePostId ] = useState( null );

	const {
		active,
		draft,
		hasDraft,
		hasGuidelines,
		isSaving,
		isPublishing,
		error,
	} = useSelect( ( select ) => {
		const store = select( STORE_NAME );
		return {
			active: store.getActive(),
			draft: store.getDraft(),
			hasDraft: store.hasDraft(),
			hasGuidelines: store.hasGuidelines(),
			isSaving: store.isSaving(),
			isPublishing: store.isPublishing(),
			error: store.getError(),
		};
	}, [] );

	const { initializeEditor, setError: clearError } = useDispatch( STORE_NAME );

	// Initialize editor when guidelines load.
	useEffect( () => {
		if ( active && ! draft ) {
			initializeEditor();
		}
	}, [ active, draft, initializeEditor ] );

	// Loading state.
	const isLoading = active === undefined;

	if ( isLoading ) {
		return (
			<div className="content-guidelines-screen content-guidelines-screen--loading">
				<Spinner />
				<p>{ __( 'Loading guidelines...', 'content-guidelines' ) }</p>
			</div>
		);
	}

	return (
		<div className="content-guidelines-screen">
			<Header
				hasDraft={ hasDraft }
				isSaving={ isSaving }
				isPublishing={ isPublishing }
				onShowHistory={ () => setShowHistory( true ) }
			/>

			{ error && (
				<Notice
					status="error"
					isDismissible
					onDismiss={ () => clearError( null ) }
				>
					{ error }
				</Notice>
			) }

			<div className="content-guidelines-screen__content">
				<div className="content-guidelines-screen__preview">
					<PreviewCanvas
						postId={ fixturePostId }
						onPostSelect={ setFixturePostId }
					/>
				</div>

				<div className="content-guidelines-screen__sidebar">
					<Sidebar
						fixturePostId={ fixturePostId }
						hasGuidelines={ hasGuidelines }
					/>
				</div>
			</div>

			{ showHistory && (
				<HistoryPanel onClose={ () => setShowHistory( false ) } />
			) }
		</div>
	);
}
</file>

<file path="src/components/guidelines-screen/preview-canvas.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect } from '@wordpress/data';
import { useState, useEffect } from '@wordpress/element';
import { ComboboxControl, Spinner } from '@wordpress/components';
import { store as coreStore } from '@wordpress/core-data';

/**
 * Preview canvas with fixture selector.
 *
 * @param {Object}   props              Component props.
 * @param {number}   props.postId       Selected post ID.
 * @param {Function} props.onPostSelect Callback when post is selected.
 * @return {JSX.Element} Preview canvas component.
 */
export default function PreviewCanvas( { postId, onPostSelect } ) {
	const [ searchInput, setSearchInput ] = useState( '' );

	// Fetch posts for the selector.
	const { posts, isLoading } = useSelect(
		( select ) => {
			const { getEntityRecords, isResolving } = select( coreStore );

			const query = {
				per_page: 20,
				status: 'publish',
				orderby: 'date',
				order: 'desc',
			};

			if ( searchInput ) {
				query.search = searchInput;
			}

			return {
				posts: getEntityRecords( 'postType', 'post', query ) || [],
				isLoading: isResolving( 'getEntityRecords', [
					'postType',
					'post',
					query,
				] ),
			};
		},
		[ searchInput ]
	);

	// Fetch selected post content.
	const selectedPost = useSelect(
		( select ) => {
			if ( ! postId ) {
				return null;
			}

			return select( coreStore ).getEntityRecord(
				'postType',
				'post',
				postId
			);
		},
		[ postId ]
	);

	// Auto-select first post if none selected.
	useEffect( () => {
		if ( ! postId && posts.length > 0 ) {
			onPostSelect( posts[ 0 ].id );
		}
	}, [ postId, posts, onPostSelect ] );

	// Build options for combobox.
	const options = posts.map( ( post ) => ( {
		value: post.id,
		label: post.title.rendered || __( '(No title)', 'content-guidelines' ),
	} ) );

	// Get plain text content for preview.
	const getPlainContent = ( html ) => {
		const div = document.createElement( 'div' );
		div.innerHTML = html;
		return div.textContent || div.innerText || '';
	};

	return (
		<div className="content-guidelines-preview">
			<div className="content-guidelines-preview__selector">
				<label className="content-guidelines-preview__label">
					{ __( 'Preview content:', 'content-guidelines' ) }
				</label>
				<ComboboxControl
					value={ postId }
					onChange={ onPostSelect }
					options={ options }
					onFilterValueChange={ setSearchInput }
					__experimentalRenderItem={ ( { item } ) => (
						<span>{ item.label }</span>
					) }
				/>
			</div>

			<div className="content-guidelines-preview__content">
				{ isLoading && (
					<div className="content-guidelines-preview__loading">
						<Spinner />
					</div>
				) }

				{ ! isLoading && selectedPost && (
					<article className="content-guidelines-preview__article">
						<h2 className="content-guidelines-preview__title">
							{ selectedPost.title.rendered ||
								__( '(No title)', 'content-guidelines' ) }
						</h2>
						<div className="content-guidelines-preview__body">
							{ getPlainContent(
								selectedPost.content.rendered
							).substring( 0, 2000 ) }
						</div>
					</article>
				) }

				{ ! isLoading && ! selectedPost && posts.length === 0 && (
					<div className="content-guidelines-preview__empty">
						<p>
							{ __(
								'No posts found. Create a post to use as a test fixture.',
								'content-guidelines'
							) }
						</p>
					</div>
				) }
			</div>
		</div>
	);
}
</file>

<file path="src/components/guidelines-screen/sidebar.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { TabPanel } from '@wordpress/components';

/**
 * Internal dependencies
 */
import BrandContextPanel from '../panels/brand-context';
import VoiceTonePanel from '../panels/voice-tone';
import CopyRulesPanel from '../panels/copy-rules';
import VocabularyPanel from '../panels/vocabulary';
import ImagesPanel from '../panels/images';
import NotesPanel from '../panels/notes';
import Playground from '../playground';
import EmptyState from './empty-state';

/**
 * Sidebar component with tabs.
 *
 * @param {Object}  props              Component props.
 * @param {number}  props.fixturePostId Selected fixture post ID.
 * @param {boolean} props.hasGuidelines Whether guidelines exist.
 * @return {JSX.Element} Sidebar component.
 */
export default function Sidebar( { fixturePostId, hasGuidelines } ) {
	const tabs = [
		{
			name: 'guidelines',
			title: __( 'Guidelines', 'content-guidelines' ),
		},
		{
			name: 'playground',
			title: __( 'Playground', 'content-guidelines' ),
		},
	];

	return (
		<div className="content-guidelines-sidebar">
			<TabPanel tabs={ tabs }>
				{ ( tab ) => {
					if ( tab.name === 'guidelines' ) {
						if ( ! hasGuidelines ) {
							return <EmptyState />;
						}

						return (
							<div className="content-guidelines-sidebar__panels">
								<BrandContextPanel />
								<VoiceTonePanel />
								<CopyRulesPanel />
								<VocabularyPanel />
								<ImagesPanel />
								<NotesPanel />
							</div>
						);
					}

					if ( tab.name === 'playground' ) {
						return <Playground fixturePostId={ fixturePostId } />;
					}

					return null;
				} }
			</TabPanel>
		</div>
	);
}
</file>

<file path="src/components/guidelines-screen/style.scss">
/**
 * Guidelines Screen Styles
 */

.content-guidelines-screen {
	display: flex;
	flex-direction: column;
	height: 100vh;
	background: #fff;

	&--loading {
		align-items: center;
		justify-content: center;

		p {
			margin-top: 16px;
			color: #757575;
		}
	}
}

.content-guidelines-screen__content {
	display: flex;
	flex: 1;
	overflow: hidden;
}

.content-guidelines-screen__preview {
	flex: 1;
	overflow: auto;
	border-right: 1px solid #e0e0e0;
}

.content-guidelines-screen__sidebar {
	width: 400px;
	overflow: auto;
	background: #f6f7f7;
}

// Header
.content-guidelines-header {
	display: flex;
	align-items: center;
	justify-content: space-between;
	padding: 12px 24px;
	border-bottom: 1px solid #e0e0e0;
	background: #fff;
}

.content-guidelines-header__left {
	display: flex;
	align-items: center;
	gap: 12px;
}

.content-guidelines-header__title {
	margin: 0;
	font-size: 16px;
	font-weight: 600;
}

.content-guidelines-header__status {
	padding: 2px 8px;
	font-size: 12px;
	border-radius: 4px;

	&--active {
		background: #d7f0df;
		color: #1e4620;
	}

	&--draft {
		background: #fff3cd;
		color: #856404;
	}
}

.content-guidelines-header__actions {
	display: flex;
	align-items: center;
	gap: 8px;
}

// Sidebar
.content-guidelines-sidebar {
	padding: 16px;

	.components-tab-panel__tabs {
		margin-bottom: 16px;
	}
}

.content-guidelines-sidebar__panels {
	display: flex;
	flex-direction: column;
	gap: 8px;

	.components-notice {
		margin: 0 0 16px;
	}
}

// Preview Canvas
.content-guidelines-preview {
	padding: 24px;
	height: 100%;
	display: flex;
	flex-direction: column;
}

.content-guidelines-preview__selector {
	margin-bottom: 24px;

	.components-combobox-control {
		max-width: 400px;
	}
}

.content-guidelines-preview__label {
	display: block;
	margin-bottom: 8px;
	font-weight: 500;
	font-size: 12px;
	text-transform: uppercase;
	color: #757575;
}

.content-guidelines-preview__content {
	flex: 1;
	overflow: auto;
}

.content-guidelines-preview__loading {
	display: flex;
	align-items: center;
	justify-content: center;
	height: 200px;
}

.content-guidelines-preview__article {
	max-width: 700px;
}

.content-guidelines-preview__title {
	margin: 0 0 16px;
	font-size: 28px;
	line-height: 1.3;
}

.content-guidelines-preview__body {
	font-size: 16px;
	line-height: 1.7;
	color: #3c434a;
	white-space: pre-wrap;
}

.content-guidelines-preview__empty {
	padding: 48px;
	text-align: center;
	color: #757575;
}

// Empty State
.content-guidelines-empty-state {
	padding: 48px 24px;
	text-align: center;
}

.content-guidelines-empty-state__icon {
	font-size: 48px;
	margin-bottom: 16px;
}

.content-guidelines-empty-state__title {
	margin: 0 0 12px;
	font-size: 20px;
	font-weight: 600;
}

.content-guidelines-empty-state__description {
	margin: 0 0 24px;
	color: #757575;
	max-width: 360px;
	margin-left: auto;
	margin-right: auto;
}

.content-guidelines-empty-state__actions {
	margin-bottom: 16px;
}

.content-guidelines-empty-state__note {
	font-size: 12px;
	color: #a0a0a0;
}

// Modal actions
.content-guidelines-modal__actions {
	display: flex;
	justify-content: flex-end;
	gap: 8px;
	margin-top: 24px;
}
</file>

<file path="src/components/history/index.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import { useEffect, useState } from '@wordpress/element';
import {
	Modal,
	Button,
	Spinner,
	__experimentalConfirmDialog as ConfirmDialog,
} from '@wordpress/components';
import { backup } from '@wordpress/icons';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';
import './style.scss';

/**
 * Format date for display.
 *
 * @param {string} dateString ISO date string.
 * @return {string} Formatted date.
 */
function formatDate( dateString ) {
	const date = new Date( dateString );
	return date.toLocaleString( undefined, {
		year: 'numeric',
		month: 'short',
		day: 'numeric',
		hour: '2-digit',
		minute: '2-digit',
	} );
}

/**
 * History panel component.
 *
 * @param {Object}   props         Component props.
 * @param {Function} props.onClose Callback to close panel.
 * @return {JSX.Element} History panel.
 */
export default function HistoryPanel( { onClose } ) {
	const [ confirmRestore, setConfirmRestore ] = useState( null );

	const { revisions, isRestoring } = useSelect( ( select ) => {
		return {
			revisions: select( STORE_NAME ).getRevisions(),
			isRestoring: select( STORE_NAME ).isRestoring(),
		};
	}, [] );

	const { fetchRevisions, restoreRevision } = useDispatch( STORE_NAME );

	// Fetch revisions on mount.
	useEffect( () => {
		fetchRevisions();
	}, [ fetchRevisions ] );

	const handleRestore = ( revisionId ) => {
		setConfirmRestore( revisionId );
	};

	const confirmRestoreAction = () => {
		if ( confirmRestore ) {
			restoreRevision( confirmRestore );
			setConfirmRestore( null );
		}
	};

	const isLoading = revisions === undefined;

	return (
		<Modal
			title={ __( 'Guidelines History', 'content-guidelines' ) }
			onRequestClose={ onClose }
			className="content-guidelines-history-modal"
			size="medium"
		>
			<div className="content-guidelines-history">
				{ isLoading && (
					<div className="content-guidelines-history__loading">
						<Spinner />
						<p>{ __( 'Loading history...', 'content-guidelines' ) }</p>
					</div>
				) }

				{ ! isLoading && revisions.length === 0 && (
					<div className="content-guidelines-history__empty">
						<p>
							{ __(
								'No revision history yet. History is created when you publish changes.',
								'content-guidelines'
							) }
						</p>
					</div>
				) }

				{ ! isLoading && revisions.length > 0 && (
					<ul className="content-guidelines-history__list">
						{ revisions.map( ( revision, index ) => (
							<li
								key={ revision.id }
								className="content-guidelines-history__item"
							>
								<div className="content-guidelines-history__item-icon">
									<backup />
								</div>
								<div className="content-guidelines-history__item-content">
									<div className="content-guidelines-history__item-date">
										{ formatDate( revision.date ) }
										{ index === 0 && (
											<span className="content-guidelines-history__current-badge">
												{ __( 'Current', 'content-guidelines' ) }
											</span>
										) }
									</div>
									<div className="content-guidelines-history__item-author">
										{ revision.author?.name ||
											__( 'Unknown', 'content-guidelines' ) }
									</div>
								</div>
								<div className="content-guidelines-history__item-actions">
									{ index > 0 && (
										<Button
											variant="secondary"
											size="small"
											onClick={ () =>
												handleRestore( revision.id )
											}
											disabled={ isRestoring }
										>
											{ __( 'Restore', 'content-guidelines' ) }
										</Button>
									) }
								</div>
							</li>
						) ) }
					</ul>
				) }

				{ isRestoring && (
					<div className="content-guidelines-history__restoring">
						<Spinner />
						<p>{ __( 'Restoring...', 'content-guidelines' ) }</p>
					</div>
				) }
			</div>

			{ confirmRestore && (
				<ConfirmDialog
					onConfirm={ confirmRestoreAction }
					onCancel={ () => setConfirmRestore( null ) }
				>
					{ __(
						'Restore this version? This will become the new active guidelines.',
						'content-guidelines'
					) }
				</ConfirmDialog>
			) }
		</Modal>
	);
}
</file>

<file path="src/components/history/style.scss">
/**
 * History Panel Styles
 */

.content-guidelines-history-modal {
	.components-modal__content {
		padding: 0;
	}
}

.content-guidelines-history {
	padding: 16px;
	min-height: 200px;
}

.content-guidelines-history__loading,
.content-guidelines-history__empty,
.content-guidelines-history__restoring {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	padding: 48px;
	text-align: center;
	color: #757575;

	.components-spinner {
		margin-bottom: 16px;
	}
}

.content-guidelines-history__list {
	list-style: none;
	margin: 0;
	padding: 0;
}

.content-guidelines-history__item {
	display: flex;
	align-items: center;
	gap: 12px;
	padding: 12px;
	border-bottom: 1px solid #e0e0e0;

	&:last-child {
		border-bottom: none;
	}

	&:hover {
		background: #f6f7f7;
	}
}

.content-guidelines-history__item-icon {
	width: 32px;
	height: 32px;
	display: flex;
	align-items: center;
	justify-content: center;
	background: #f0f0f0;
	border-radius: 50%;
	color: #757575;

	svg {
		width: 18px;
		height: 18px;
	}
}

.content-guidelines-history__item-content {
	flex: 1;
}

.content-guidelines-history__item-date {
	font-weight: 500;
	display: flex;
	align-items: center;
	gap: 8px;
}

.content-guidelines-history__current-badge {
	font-size: 11px;
	font-weight: 500;
	padding: 2px 6px;
	background: #d7f0df;
	color: #1e4620;
	border-radius: 3px;
}

.content-guidelines-history__item-author {
	font-size: 13px;
	color: #757575;
}

.content-guidelines-history__item-actions {
	display: flex;
	gap: 8px;
}
</file>

<file path="src/components/import-export/index.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import { useState, useRef } from '@wordpress/element';
import {
	Button,
	Notice,
	__experimentalVStack as VStack,
	__experimentalText as Text,
	__experimentalHeading as Heading,
	__experimentalSpacer as Spacer,
} from '@wordpress/components';
import { download, upload } from '@wordpress/icons';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';
import './style.scss';

/**
 * Import/Export panel component.
 *
 * @return {JSX.Element} Import/Export panel.
 */
export default function ImportExportPanel() {
	const [ importError, setImportError ] = useState( null );
	const [ importSuccess, setImportSuccess ] = useState( false );
	const fileInputRef = useRef( null );

	const { active, draft } = useSelect( ( select ) => {
		const store = select( STORE_NAME );
		return {
			active: store.getActive(),
			draft: store.getDraft(),
		};
	}, [] );

	const { setDraft } = useDispatch( STORE_NAME );

	/**
	 * Export guidelines as JSON file.
	 */
	const handleExport = () => {
		const guidelines = draft || active;

		if ( ! guidelines ) {
			return;
		}

		const exportData = {
			version: 1,
			exported_at: new Date().toISOString(),
			guidelines,
		};

		const blob = new Blob(
			[ JSON.stringify( exportData, null, 2 ) ],
			{ type: 'application/json' }
		);

		const url = URL.createObjectURL( blob );
		const link = document.createElement( 'a' );
		link.href = url;
		link.download = `content-guidelines-${ new Date().toISOString().split( 'T' )[ 0 ] }.json`;
		document.body.appendChild( link );
		link.click();
		document.body.removeChild( link );
		URL.revokeObjectURL( url );
	};

	/**
	 * Handle file selection for import.
	 *
	 * @param {Event} event The file input change event.
	 */
	const handleFileSelect = ( event ) => {
		const file = event.target.files?.[ 0 ];

		if ( ! file ) {
			return;
		}

		setImportError( null );
		setImportSuccess( false );

		const reader = new FileReader();

		reader.onload = ( e ) => {
			try {
				const data = JSON.parse( e.target.result );

				// Validate the import data
				if ( ! data.guidelines ) {
					throw new Error( __( 'Invalid file: missing guidelines data.', 'content-guidelines' ) );
				}

				// Basic schema validation
				const guidelines = data.guidelines;
				if ( typeof guidelines !== 'object' ) {
					throw new Error( __( 'Invalid file: guidelines must be an object.', 'content-guidelines' ) );
				}

				// Import as draft
				setDraft( guidelines );
				setImportSuccess( true );
			} catch ( err ) {
				setImportError( err.message || __( 'Failed to parse JSON file.', 'content-guidelines' ) );
			}
		};

		reader.onerror = () => {
			setImportError( __( 'Failed to read file.', 'content-guidelines' ) );
		};

		reader.readAsText( file );

		// Reset the input so the same file can be selected again
		event.target.value = '';
	};

	/**
	 * Trigger file input click.
	 */
	const handleImportClick = () => {
		fileInputRef.current?.click();
	};

	const hasGuidelines = active || draft;

	return (
		<div className="import-export-panel">
			<VStack spacing={ 6 }>
				<div>
					<Heading level={ 2 } className="import-export-panel__title">
						{ __( 'Import / Export', 'content-guidelines' ) }
					</Heading>
					<Spacer margin={ 2 } />
					<Text variant="muted">
						{ __( 'Transfer guidelines between sites or create backups.', 'content-guidelines' ) }
					</Text>
				</div>

				{ importError && (
					<Notice
						status="error"
						isDismissible
						onDismiss={ () => setImportError( null ) }
					>
						{ importError }
					</Notice>
				) }

				{ importSuccess && (
					<Notice
						status="success"
						isDismissible
						onDismiss={ () => setImportSuccess( false ) }
					>
						{ __( 'Guidelines imported as draft. Review and publish when ready.', 'content-guidelines' ) }
					</Notice>
				) }

				<VStack spacing={ 4 }>
					<div className="import-export-panel__section">
						<Heading level={ 3 } className="import-export-panel__section-title">
							{ __( 'Export', 'content-guidelines' ) }
						</Heading>
						<Text variant="muted" className="import-export-panel__section-desc">
							{ __( 'Download your current guidelines as a JSON file.', 'content-guidelines' ) }
						</Text>
						<Spacer margin={ 3 } />
						<Button
							variant="secondary"
							icon={ download }
							onClick={ handleExport }
							disabled={ ! hasGuidelines }
						>
							{ __( 'Export JSON', 'content-guidelines' ) }
						</Button>
					</div>

					<div className="import-export-panel__section">
						<Heading level={ 3 } className="import-export-panel__section-title">
							{ __( 'Import', 'content-guidelines' ) }
						</Heading>
						<Text variant="muted" className="import-export-panel__section-desc">
							{ __( 'Load guidelines from a JSON file. Imported data will be saved as a draft.', 'content-guidelines' ) }
						</Text>
						<Spacer margin={ 3 } />
						<input
							ref={ fileInputRef }
							type="file"
							accept=".json,application/json"
							onChange={ handleFileSelect }
							style={ { display: 'none' } }
						/>
						<Button
							variant="secondary"
							icon={ upload }
							onClick={ handleImportClick }
						>
							{ __( 'Import JSON', 'content-guidelines' ) }
						</Button>
					</div>
				</VStack>
			</VStack>
		</div>
	);
}
</file>

<file path="src/components/import-export/style.scss">
.import-export-panel {
	max-width: 480px;
	margin: 0 auto;
	padding: 24px;

	&__title {
		font-size: 20px;
		font-weight: 500;
	}

	&__section {
		padding: 20px;
		background: #f9f9f9;
		border-radius: 4px;
	}

	&__section-title {
		font-size: 14px;
		font-weight: 500;
		margin-bottom: 4px;
	}

	&__section-desc {
		font-size: 13px;
	}
}
</file>

<file path="src/components/panels/brand-context.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import {
	PanelBody,
	TextareaControl,
	TextControl,
	SelectControl,
	FormTokenField,
} from '@wordpress/components';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';

/**
 * Goal options.
 */
const GOAL_OPTIONS = [
	{ value: '', label: __( 'Select a goal...', 'content-guidelines' ) },
	{ value: 'subscribe', label: __( 'Get email subscribers', 'content-guidelines' ) },
	{ value: 'sell', label: __( 'Sell products/services', 'content-guidelines' ) },
	{ value: 'inform', label: __( 'Inform and educate', 'content-guidelines' ) },
	{ value: 'community', label: __( 'Build community', 'content-guidelines' ) },
	{ value: 'other', label: __( 'Other', 'content-guidelines' ) },
];

/**
 * Brand & Site Context panel.
 *
 * @return {JSX.Element} Panel component.
 */
export default function BrandContextPanel() {
	const brandContext = useSelect(
		( select ) => select( STORE_NAME ).getBrandContext() || {},
		[]
	);

	const { updateDraftSection } = useDispatch( STORE_NAME );

	const handleChange = ( field, value ) => {
		updateDraftSection( 'brand_context', { [ field ]: value } );
	};

	return (
		<PanelBody
			title={ __( 'Brand & site context', 'content-guidelines' ) }
			initialOpen={ true }
		>
			<TextareaControl
				label={ __( 'What is this site about?', 'content-guidelines' ) }
				help={ __(
					'A brief description of your site, business, or publication.',
					'content-guidelines'
				) }
				value={ brandContext.site_description || '' }
				onChange={ ( value ) => handleChange( 'site_description', value ) }
				rows={ 3 }
			/>

			<TextControl
				label={ __( 'Target audience', 'content-guidelines' ) }
				help={ __(
					'Who are you writing for?',
					'content-guidelines'
				) }
				value={ brandContext.audience || '' }
				onChange={ ( value ) => handleChange( 'audience', value ) }
			/>

			<SelectControl
				label={ __( 'Primary goal', 'content-guidelines' ) }
				help={ __(
					'What do you want visitors to do?',
					'content-guidelines'
				) }
				value={ brandContext.primary_goal || '' }
				options={ GOAL_OPTIONS }
				onChange={ ( value ) => handleChange( 'primary_goal', value ) }
			/>

			<FormTokenField
				label={ __( 'Topics / coverage areas', 'content-guidelines' ) }
				value={ brandContext.topics || [] }
				onChange={ ( value ) => handleChange( 'topics', value ) }
				__experimentalExpandOnFocus
				__experimentalShowHowTo={ false }
			/>
		</PanelBody>
	);
}
</file>

<file path="src/components/panels/copy-rules.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import {
	PanelBody,
	Button,
	TextControl,
	CheckboxControl,
	Flex,
	FlexItem,
	FlexBlock,
} from '@wordpress/components';
import { plus, trash } from '@wordpress/icons';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';

/**
 * Formatting options.
 */
const FORMATTING_OPTIONS = [
	{ value: 'h2s', label: __( 'Use H2 headings', 'content-guidelines' ) },
	{ value: 'bullets', label: __( 'Use bullet points', 'content-guidelines' ) },
	{
		value: 'short_paragraphs',
		label: __( 'Keep paragraphs short', 'content-guidelines' ),
	},
	{
		value: 'single_cta',
		label: __( 'Single CTA at end', 'content-guidelines' ),
	},
];

/**
 * Repeater list component.
 *
 * @param {Object}   props          Component props.
 * @param {Array}    props.items    List items.
 * @param {Function} props.onChange Change handler.
 * @param {string}   props.label    Add button label.
 * @return {JSX.Element} Repeater component.
 */
function RepeaterList( { items = [], onChange, label } ) {
	const handleAdd = () => {
		onChange( [ ...items, '' ] );
	};

	const handleRemove = ( index ) => {
		const newItems = items.filter( ( _, i ) => i !== index );
		onChange( newItems );
	};

	const handleChange = ( index, value ) => {
		const newItems = [ ...items ];
		newItems[ index ] = value;
		onChange( newItems );
	};

	return (
		<div className="content-guidelines-repeater">
			{ items.map( ( item, index ) => (
				<Flex key={ index } gap={ 2 } align="flex-start">
					<FlexBlock>
						<TextControl
							value={ item }
							onChange={ ( value ) => handleChange( index, value ) }
							placeholder={ __( 'Enter rule...', 'content-guidelines' ) }
						/>
					</FlexBlock>
					<FlexItem>
						<Button
							icon={ trash }
							isDestructive
							onClick={ () => handleRemove( index ) }
							label={ __( 'Remove', 'content-guidelines' ) }
						/>
					</FlexItem>
				</Flex>
			) ) }

			<Button
				variant="secondary"
				icon={ plus }
				onClick={ handleAdd }
				size="small"
			>
				{ label }
			</Button>
		</div>
	);
}

/**
 * Copy Rules panel.
 *
 * @return {JSX.Element} Panel component.
 */
export default function CopyRulesPanel() {
	const copyRules = useSelect(
		( select ) => select( STORE_NAME ).getCopyRules() || {},
		[]
	);

	const { updateDraftSection } = useDispatch( STORE_NAME );

	const handleChange = ( field, value ) => {
		updateDraftSection( 'copy_rules', { [ field ]: value } );
	};

	const handleFormattingChange = ( option, checked ) => {
		const current = copyRules.formatting || [];
		let newFormatting;

		if ( checked ) {
			newFormatting = [ ...current, option ];
		} else {
			newFormatting = current.filter( ( f ) => f !== option );
		}

		handleChange( 'formatting', newFormatting );
	};

	return (
		<PanelBody
			title={ __( 'Copy rules', 'content-guidelines' ) }
			initialOpen={ false }
		>
			<div className="content-guidelines-panel-section">
				<h4 className="content-guidelines-panel-section__title">
					{ __( 'Do', 'content-guidelines' ) }
				</h4>
				<RepeaterList
					items={ copyRules.dos || [] }
					onChange={ ( value ) => handleChange( 'dos', value ) }
					label={ __( 'Add rule', 'content-guidelines' ) }
				/>
			</div>

			<div className="content-guidelines-panel-section">
				<h4 className="content-guidelines-panel-section__title">
					{ __( "Don't", 'content-guidelines' ) }
				</h4>
				<RepeaterList
					items={ copyRules.donts || [] }
					onChange={ ( value ) => handleChange( 'donts', value ) }
					label={ __( 'Add rule', 'content-guidelines' ) }
				/>
			</div>

			<div className="content-guidelines-panel-section">
				<h4 className="content-guidelines-panel-section__title">
					{ __( 'Formatting defaults', 'content-guidelines' ) }
				</h4>
				{ FORMATTING_OPTIONS.map( ( option ) => (
					<CheckboxControl
						key={ option.value }
						label={ option.label }
						checked={ ( copyRules.formatting || [] ).includes(
							option.value
						) }
						onChange={ ( checked ) =>
							handleFormattingChange( option.value, checked )
						}
					/>
				) ) }
			</div>
		</PanelBody>
	);
}
</file>

<file path="src/components/panels/images.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import {
	PanelBody,
	Button,
	TextControl,
	SelectControl,
	Flex,
	FlexItem,
	FlexBlock,
} from '@wordpress/components';
import { plus, trash } from '@wordpress/icons';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';

/**
 * Text in image policy options.
 */
const TEXT_POLICY_OPTIONS = [
	{ value: '', label: __( 'Select...', 'content-guidelines' ) },
	{
		value: 'never',
		label: __( 'Never include text', 'content-guidelines' ),
	},
	{
		value: 'only_if_requested',
		label: __( 'Only if explicitly requested', 'content-guidelines' ),
	},
	{
		value: 'ok',
		label: __( 'Text is acceptable', 'content-guidelines' ),
	},
];

/**
 * Simple repeater list.
 *
 * @param {Object}   props          Component props.
 * @param {Array}    props.items    List items.
 * @param {Function} props.onChange Change handler.
 * @param {string}   props.label    Add button label.
 * @param {string}   props.placeholder Placeholder text.
 * @return {JSX.Element} Repeater component.
 */
function SimpleRepeater( { items = [], onChange, label, placeholder } ) {
	const handleAdd = () => {
		onChange( [ ...items, '' ] );
	};

	const handleRemove = ( index ) => {
		const newItems = items.filter( ( _, i ) => i !== index );
		onChange( newItems );
	};

	const handleChange = ( index, value ) => {
		const newItems = [ ...items ];
		newItems[ index ] = value;
		onChange( newItems );
	};

	return (
		<div className="content-guidelines-repeater">
			{ items.map( ( item, index ) => (
				<Flex key={ index } gap={ 2 } align="flex-start">
					<FlexBlock>
						<TextControl
							value={ item }
							onChange={ ( value ) => handleChange( index, value ) }
							placeholder={ placeholder }
						/>
					</FlexBlock>
					<FlexItem>
						<Button
							icon={ trash }
							isDestructive
							onClick={ () => handleRemove( index ) }
							label={ __( 'Remove', 'content-guidelines' ) }
						/>
					</FlexItem>
				</Flex>
			) ) }

			<Button
				variant="secondary"
				icon={ plus }
				onClick={ handleAdd }
				size="small"
			>
				{ label }
			</Button>
		</div>
	);
}

/**
 * Images panel.
 *
 * @return {JSX.Element} Panel component.
 */
export default function ImagesPanel() {
	const imageStyle = useSelect(
		( select ) => select( STORE_NAME ).getImageStyle() || {},
		[]
	);

	const { updateDraftSection } = useDispatch( STORE_NAME );

	const handleChange = ( field, value ) => {
		updateDraftSection( 'image_style', { [ field ]: value } );
	};

	return (
		<PanelBody
			title={ __( 'Images', 'content-guidelines' ) }
			initialOpen={ false }
		>
			<div className="content-guidelines-panel-section">
				<h4 className="content-guidelines-panel-section__title">
					{ __( 'Preferred style', 'content-guidelines' ) }
				</h4>
				<p className="content-guidelines-panel-section__description">
					{ __(
						'Describe your ideal image aesthetic.',
						'content-guidelines'
					) }
				</p>
				<SimpleRepeater
					items={ imageStyle.dos || [] }
					onChange={ ( value ) => handleChange( 'dos', value ) }
					label={ __( 'Add style', 'content-guidelines' ) }
					placeholder={ __(
						'e.g., "Clean, minimal, editorial"',
						'content-guidelines'
					) }
				/>
			</div>

			<div className="content-guidelines-panel-section">
				<h4 className="content-guidelines-panel-section__title">
					{ __( 'Avoid in images', 'content-guidelines' ) }
				</h4>
				<SimpleRepeater
					items={ imageStyle.donts || [] }
					onChange={ ( value ) => handleChange( 'donts', value ) }
					label={ __( 'Add rule', 'content-guidelines' ) }
					placeholder={ __(
						'e.g., "No stock photo vibes"',
						'content-guidelines'
					) }
				/>
			</div>

			<SelectControl
				label={ __( 'Text in images', 'content-guidelines' ) }
				help={ __(
					'Should generated images include text?',
					'content-guidelines'
				) }
				value={ imageStyle.text_policy || '' }
				options={ TEXT_POLICY_OPTIONS }
				onChange={ ( value ) => handleChange( 'text_policy', value ) }
			/>
		</PanelBody>
	);
}
</file>

<file path="src/components/panels/notes.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import { PanelBody, TextareaControl } from '@wordpress/components';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';

/**
 * Notes panel.
 *
 * @return {JSX.Element} Panel component.
 */
export default function NotesPanel() {
	const notes = useSelect(
		( select ) => select( STORE_NAME ).getNotes() || '',
		[]
	);

	const { updateDraft } = useDispatch( STORE_NAME );

	const handleChange = ( value ) => {
		updateDraft( { notes: value } );
	};

	return (
		<PanelBody
			title={ __( 'Notes', 'content-guidelines' ) }
			initialOpen={ false }
		>
			<TextareaControl
				label={ __( 'Anything else AI should know', 'content-guidelines' ) }
				help={ __(
					'Free-form notes, context, or reminders that don\'t fit elsewhere.',
					'content-guidelines'
				) }
				value={ notes }
				onChange={ handleChange }
				rows={ 5 }
				placeholder={ __(
					'e.g., "We\'re rebranding in Q2, so avoid old product names..."',
					'content-guidelines'
				) }
			/>
		</PanelBody>
	);
}
</file>

<file path="src/components/panels/vocabulary.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import {
	PanelBody,
	Button,
	TextControl,
	Flex,
	FlexItem,
	FlexBlock,
} from '@wordpress/components';
import { plus, trash } from '@wordpress/icons';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';

/**
 * Term repeater with optional note.
 *
 * @param {Object}   props          Component props.
 * @param {Array}    props.items    List items.
 * @param {Function} props.onChange Change handler.
 * @param {string}   props.label    Add button label.
 * @return {JSX.Element} Term repeater component.
 */
function TermRepeater( { items = [], onChange, label } ) {
	const handleAdd = () => {
		onChange( [ ...items, { term: '', note: '' } ] );
	};

	const handleRemove = ( index ) => {
		const newItems = items.filter( ( _, i ) => i !== index );
		onChange( newItems );
	};

	const handleChange = ( index, field, value ) => {
		const newItems = [ ...items ];
		newItems[ index ] = {
			...newItems[ index ],
			[ field ]: value,
		};
		onChange( newItems );
	};

	return (
		<div className="content-guidelines-term-repeater">
			{ items.map( ( item, index ) => (
				<div key={ index } className="content-guidelines-term-repeater__item">
					<Flex gap={ 2 } align="flex-start">
						<FlexBlock>
							<TextControl
								label={ __( 'Term', 'content-guidelines' ) }
								value={ item.term || '' }
								onChange={ ( value ) =>
									handleChange( index, 'term', value )
								}
								placeholder={ __(
									'e.g., "readers"',
									'content-guidelines'
								) }
							/>
						</FlexBlock>
						<FlexBlock>
							<TextControl
								label={ __( 'Note (optional)', 'content-guidelines' ) }
								value={ item.note || '' }
								onChange={ ( value ) =>
									handleChange( index, 'note', value )
								}
								placeholder={ __(
									'e.g., "instead of users"',
									'content-guidelines'
								) }
							/>
						</FlexBlock>
						<FlexItem>
							<div style={ { marginTop: '24px' } }>
								<Button
									icon={ trash }
									isDestructive
									onClick={ () => handleRemove( index ) }
									label={ __( 'Remove', 'content-guidelines' ) }
								/>
							</div>
						</FlexItem>
					</Flex>
				</div>
			) ) }

			<Button
				variant="secondary"
				icon={ plus }
				onClick={ handleAdd }
				size="small"
			>
				{ label }
			</Button>
		</div>
	);
}

/**
 * Vocabulary panel.
 *
 * @return {JSX.Element} Panel component.
 */
export default function VocabularyPanel() {
	const vocabulary = useSelect(
		( select ) => select( STORE_NAME ).getVocabulary() || {},
		[]
	);

	const { updateDraftSection } = useDispatch( STORE_NAME );

	const handleChange = ( field, value ) => {
		updateDraftSection( 'vocabulary', { [ field ]: value } );
	};

	return (
		<PanelBody
			title={ __( 'Vocabulary', 'content-guidelines' ) }
			initialOpen={ false }
		>
			<div className="content-guidelines-panel-section">
				<h4 className="content-guidelines-panel-section__title">
					{ __( 'Prefer these terms', 'content-guidelines' ) }
				</h4>
				<p className="content-guidelines-panel-section__description">
					{ __(
						'Terms AI should use. Add a note to explain when or why.',
						'content-guidelines'
					) }
				</p>
				<TermRepeater
					items={ vocabulary.prefer || [] }
					onChange={ ( value ) => handleChange( 'prefer', value ) }
					label={ __( 'Add term', 'content-guidelines' ) }
				/>
			</div>

			<div className="content-guidelines-panel-section">
				<h4 className="content-guidelines-panel-section__title">
					{ __( 'Avoid these terms', 'content-guidelines' ) }
				</h4>
				<p className="content-guidelines-panel-section__description">
					{ __(
						'Terms AI should not use.',
						'content-guidelines'
					) }
				</p>
				<TermRepeater
					items={ vocabulary.avoid || [] }
					onChange={ ( value ) => handleChange( 'avoid', value ) }
					label={ __( 'Add term', 'content-guidelines' ) }
				/>
			</div>
		</PanelBody>
	);
}
</file>

<file path="src/components/panels/voice-tone.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import {
	PanelBody,
	SelectControl,
	FormTokenField,
	TextareaControl,
} from '@wordpress/components';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';

/**
 * Point of view options.
 */
const POV_OPTIONS = [
	{ value: '', label: __( 'Select...', 'content-guidelines' ) },
	{
		value: 'we_you',
		label: __( 'We  You ("We help you...")', 'content-guidelines' ),
	},
	{
		value: 'i_you',
		label: __( 'I  You ("I\'ll show you...")', 'content-guidelines' ),
	},
	{
		value: 'third_person',
		label: __( 'Third person ("The company...")', 'content-guidelines' ),
	},
];

/**
 * Readability options.
 */
const READABILITY_OPTIONS = [
	{
		value: 'simple',
		label: __( 'Simple (elementary level)', 'content-guidelines' ),
	},
	{
		value: 'general',
		label: __( 'General audience', 'content-guidelines' ),
	},
	{
		value: 'expert',
		label: __( 'Expert / technical', 'content-guidelines' ),
	},
];

/**
 * Common tone trait suggestions.
 */
const TONE_SUGGESTIONS = [
	'warm',
	'confident',
	'plain English',
	'friendly',
	'professional',
	'authoritative',
	'casual',
	'direct',
	'empathetic',
	'enthusiastic',
];

/**
 * Voice & Tone panel.
 *
 * @return {JSX.Element} Panel component.
 */
export default function VoiceTonePanel() {
	const voiceTone = useSelect(
		( select ) => select( STORE_NAME ).getVoiceTone() || {},
		[]
	);

	const { updateDraftSection } = useDispatch( STORE_NAME );

	const handleChange = ( field, value ) => {
		updateDraftSection( 'voice_tone', { [ field ]: value } );
	};

	return (
		<PanelBody
			title={ __( 'Voice & tone', 'content-guidelines' ) }
			initialOpen={ false }
		>
			<FormTokenField
				label={ __( 'Tone traits', 'content-guidelines' ) }
				value={ voiceTone.tone_traits || [] }
				suggestions={ TONE_SUGGESTIONS }
				onChange={ ( value ) => handleChange( 'tone_traits', value ) }
				__experimentalExpandOnFocus
				__experimentalShowHowTo={ false }
			/>

			<SelectControl
				label={ __( 'Point of view', 'content-guidelines' ) }
				help={ __(
					'How should AI refer to your site/company?',
					'content-guidelines'
				) }
				value={ voiceTone.pov || '' }
				options={ POV_OPTIONS }
				onChange={ ( value ) => handleChange( 'pov', value ) }
			/>

			<SelectControl
				label={ __( 'Readability', 'content-guidelines' ) }
				help={ __(
					'Target reading level for content.',
					'content-guidelines'
				) }
				value={ voiceTone.readability || 'general' }
				options={ READABILITY_OPTIONS }
				onChange={ ( value ) => handleChange( 'readability', value ) }
			/>

			<TextareaControl
				label={ __( 'Good example', 'content-guidelines' ) }
				help={ __(
					'A sentence that captures your ideal voice.',
					'content-guidelines'
				) }
				value={ voiceTone.example_good || '' }
				onChange={ ( value ) => handleChange( 'example_good', value ) }
				rows={ 2 }
			/>

			<TextareaControl
				label={ __( 'Example to avoid', 'content-guidelines' ) }
				help={ __(
					'A sentence showing what NOT to sound like.',
					'content-guidelines'
				) }
				value={ voiceTone.example_avoid || '' }
				onChange={ ( value ) => handleChange( 'example_avoid', value ) }
				rows={ 2 }
			/>
		</PanelBody>
	);
}
</file>

<file path="src/components/playground/context-preview.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { PanelBody, Button } from '@wordpress/components';
import { useCopyToClipboard } from '@wordpress/compose';
import { useState } from '@wordpress/element';

/**
 * Context preview component.
 *
 * @param {Object} props        Component props.
 * @param {Object} props.packet Context packet data.
 * @return {JSX.Element} Context preview.
 */
export default function ContextPreview( { packet } ) {
	const [ copied, setCopied ] = useState( false );

	const copyRef = useCopyToClipboard( packet?.packet_text || '', () => {
		setCopied( true );
		setTimeout( () => setCopied( false ), 2000 );
	} );

	if ( ! packet ) {
		return null;
	}

	return (
		<PanelBody
			title={ __( 'Context Preview', 'content-guidelines' ) }
			initialOpen={ false }
		>
			<div className="content-guidelines-context-preview">
				<p className="content-guidelines-context-preview__description">
					{ __(
						'This is what would be sent to AI as context:',
						'content-guidelines'
					) }
				</p>

				<div className="content-guidelines-context-preview__meta">
					{ packet.guidelines_id && (
						<span>
							{ __( 'Guidelines ID:', 'content-guidelines' ) }{ ' ' }
							{ packet.guidelines_id }
						</span>
					) }
					{ packet.revision_id && (
						<span>
							{ __( 'Revision:', 'content-guidelines' ) }{ ' ' }
							{ packet.revision_id }
						</span>
					) }
					{ packet.updated_at && (
						<span>
							{ __( 'Updated:', 'content-guidelines' ) }{ ' ' }
							{ new Date( packet.updated_at ).toLocaleDateString() }
						</span>
					) }
				</div>

				<pre className="content-guidelines-context-preview__text">
					{ packet.packet_text || __( '(Empty)', 'content-guidelines' ) }
				</pre>

				<div className="content-guidelines-context-preview__actions">
					<Button ref={ copyRef } variant="secondary" size="small">
						{ copied
							? __( 'Copied!', 'content-guidelines' )
							: __( 'Copy', 'content-guidelines' ) }
					</Button>
				</div>

				{ packet.packet_structured && (
					<details className="content-guidelines-context-preview__structured">
						<summary>
							{ __( 'Structured data', 'content-guidelines' ) }
						</summary>
						<pre>
							{ JSON.stringify( packet.packet_structured, null, 2 ) }
						</pre>
					</details>
				) }
			</div>
		</PanelBody>
	);
}
</file>

<file path="src/components/playground/index.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import { useState } from '@wordpress/element';
import {
	Button,
	SelectControl,
	TextareaControl,
	ToggleControl,
	Panel,
	PanelBody,
	Spinner,
	Notice,
} from '@wordpress/components';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';
import LintPanel from './lint-panel';
import ContextPreview from './context-preview';
import './style.scss';

/**
 * Task options.
 */
const TASK_OPTIONS = [
	{
		value: 'rewrite_intro',
		label: __( 'Rewrite intro paragraph', 'content-guidelines' ),
	},
	{
		value: 'generate_headlines',
		label: __( 'Generate 5 headline options', 'content-guidelines' ),
	},
	{
		value: 'write_cta',
		label: __( 'Write a CTA paragraph', 'content-guidelines' ),
	},
];

/**
 * Playground component.
 *
 * @param {Object} props               Component props.
 * @param {number} props.fixturePostId Selected fixture post ID.
 * @return {JSX.Element} Playground component.
 */
export default function Playground( { fixturePostId } ) {
	const [ task, setTask ] = useState( 'rewrite_intro' );
	const [ useDraft, setUseDraft ] = useState( true );
	const [ compare, setCompare ] = useState( false );
	const [ extraInstructions, setExtraInstructions ] = useState( '' );

	const { testResults, isRunningTest, hasDraft, error } = useSelect(
		( select ) => {
			return {
				testResults: select( STORE_NAME ).getTestResults(),
				isRunningTest: select( STORE_NAME ).isRunningTest(),
				hasDraft: select( STORE_NAME ).hasDraft(),
				error: select( STORE_NAME ).getError(),
			};
		},
		[]
	);

	const { runPlaygroundTest } = useDispatch( STORE_NAME );

	const handleRun = () => {
		if ( ! fixturePostId ) {
			return;
		}

		runPlaygroundTest( {
			task,
			fixture_post_id: fixturePostId,
			use: useDraft ? 'draft' : 'active',
			compare,
			extra_instructions: extraInstructions,
		} );
	};

	const canRun = fixturePostId && ! isRunningTest;

	return (
		<div className="content-guidelines-playground">
			<div className="content-guidelines-playground__controls">
				{ hasDraft && (
					<ToggleControl
						label={ __( 'Use draft guidelines', 'content-guidelines' ) }
						checked={ useDraft }
						onChange={ setUseDraft }
					/>
				) }

				{ hasDraft && (
					<ToggleControl
						label={ __( 'Compare draft vs active', 'content-guidelines' ) }
						checked={ compare }
						onChange={ setCompare }
						disabled={ ! useDraft }
					/>
				) }

				<SelectControl
					label={ __( 'Task', 'content-guidelines' ) }
					value={ task }
					options={ TASK_OPTIONS }
					onChange={ setTask }
				/>

				<TextareaControl
					label={ __( 'Extra instructions (optional)', 'content-guidelines' ) }
					value={ extraInstructions }
					onChange={ setExtraInstructions }
					rows={ 2 }
					placeholder={ __(
						'Any specific instructions for this test...',
						'content-guidelines'
					) }
				/>

				<Button
					variant="primary"
					onClick={ handleRun }
					disabled={ ! canRun }
					isBusy={ isRunningTest }
				>
					{ isRunningTest
						? __( 'Running...', 'content-guidelines' )
						: __( 'Run', 'content-guidelines' ) }
				</Button>

				{ ! fixturePostId && (
					<p className="content-guidelines-playground__note">
						{ __(
							'Select a post above to test against.',
							'content-guidelines'
						) }
					</p>
				) }
			</div>

			{ error && (
				<Notice status="error" isDismissible={ false }>
					{ error }
				</Notice>
			) }

			{ isRunningTest && (
				<div className="content-guidelines-playground__loading">
					<Spinner />
					<p>{ __( 'Running test...', 'content-guidelines' ) }</p>
				</div>
			) }

			{ testResults && ! isRunningTest && (
				<div className="content-guidelines-playground__results">
					{ /* Lint Results */ }
					<LintPanel results={ testResults.lint_results } />

					{ /* Compare Lint Results */ }
					{ testResults.compare?.lint_results && (
						<div className="content-guidelines-playground__compare">
							<h4>{ __( 'Active Guidelines Lint', 'content-guidelines' ) }</h4>
							<LintPanel results={ testResults.compare.lint_results } />
						</div>
					) }

					{ /* AI Result */ }
					{ testResults.ai_result && (
						<PanelBody
							title={ __( 'AI Result', 'content-guidelines' ) }
							initialOpen={ true }
						>
							<div className="content-guidelines-playground__ai-result">
								{ testResults.ai_result.output }
							</div>
							{ testResults.ai_result.alternatives && (
								<div className="content-guidelines-playground__alternatives">
									<h5>{ __( 'Alternatives', 'content-guidelines' ) }</h5>
									<ul>
										{ testResults.ai_result.alternatives.map(
											( alt, i ) => (
												<li key={ i }>{ alt }</li>
											)
										) }
									</ul>
								</div>
							) }
						</PanelBody>
					) }

					{ /* No AI Provider Message */ }
					{ testResults.ai_available === false && (
						<Notice status="info" isDismissible={ false }>
							{ testResults.ai_message ||
								__(
									'No AI provider connected. Showing lint checks and context preview.',
									'content-guidelines'
								) }
						</Notice>
					) }

					{ /* Context Preview */ }
					<ContextPreview packet={ testResults.context_packet } />

					{ /* Compare Context */ }
					{ testResults.compare?.context_packet && (
						<div className="content-guidelines-playground__compare">
							<h4>
								{ __(
									'Active Guidelines Context',
									'content-guidelines'
								) }
							</h4>
							<ContextPreview
								packet={ testResults.compare.context_packet }
							/>
						</div>
					) }
				</div>
			) }
		</div>
	);
}
</file>

<file path="src/components/playground/lint-panel.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { PanelBody } from '@wordpress/components';
import { warning, info } from '@wordpress/icons';

/**
 * Lint panel component.
 *
 * @param {Object} props         Component props.
 * @param {Object} props.results Lint check results.
 * @return {JSX.Element} Lint panel.
 */
export default function LintPanel( { results } ) {
	if ( ! results ) {
		return null;
	}

	const { issues = [], suggestions = [], stats = {} } = results;
	const hasIssues = issues.length > 0;
	const hasSuggestions = suggestions.length > 0;

	const title = hasIssues
		? __( 'Lint Checks', 'content-guidelines' ) +
		  ` (${ issues.length } ${ issues.length === 1 ? 'issue' : 'issues' })`
		: __( 'Lint Checks', 'content-guidelines' );

	return (
		<PanelBody title={ title } initialOpen={ hasIssues }>
			{ ! hasIssues && ! hasSuggestions && (
				<p className="content-guidelines-lint__success">
					{ __( 'No issues found.', 'content-guidelines' ) }
				</p>
			) }

			{ hasIssues && (
				<div className="content-guidelines-lint__issues">
					<h4 className="content-guidelines-lint__section-title">
						{ __( 'Issues', 'content-guidelines' ) }
					</h4>
					<ul className="content-guidelines-lint__list">
						{ issues.map( ( issue, index ) => (
							<li
								key={ index }
								className="content-guidelines-lint__item content-guidelines-lint__item--issue"
							>
								<span className="content-guidelines-lint__icon">
									
								</span>
								<div className="content-guidelines-lint__content">
									<span className="content-guidelines-lint__message">
										{ issue.message }
									</span>
									{ issue.note && (
										<span className="content-guidelines-lint__note">
											{ issue.note }
										</span>
									) }
								</div>
							</li>
						) ) }
					</ul>
				</div>
			) }

			{ hasSuggestions && (
				<div className="content-guidelines-lint__suggestions">
					<h4 className="content-guidelines-lint__section-title">
						{ __( 'Suggestions', 'content-guidelines' ) }
					</h4>
					<ul className="content-guidelines-lint__list">
						{ suggestions.map( ( suggestion, index ) => (
							<li
								key={ index }
								className="content-guidelines-lint__item content-guidelines-lint__item--suggestion"
							>
								<span className="content-guidelines-lint__icon">
									
								</span>
								<div className="content-guidelines-lint__content">
									<span className="content-guidelines-lint__message">
										{ suggestion.message }
									</span>
									{ suggestion.note && (
										<span className="content-guidelines-lint__note">
											{ suggestion.note }
										</span>
									) }
								</div>
							</li>
						) ) }
					</ul>
				</div>
			) }

			{ stats && Object.keys( stats ).length > 0 && (
				<div className="content-guidelines-lint__stats">
					<h4 className="content-guidelines-lint__section-title">
						{ __( 'Stats', 'content-guidelines' ) }
					</h4>
					<dl className="content-guidelines-lint__stats-list">
						{ stats.word_count !== undefined && (
							<>
								<dt>{ __( 'Words', 'content-guidelines' ) }</dt>
								<dd>{ stats.word_count }</dd>
							</>
						) }
						{ stats.sentence_count !== undefined && (
							<>
								<dt>{ __( 'Sentences', 'content-guidelines' ) }</dt>
								<dd>{ stats.sentence_count }</dd>
							</>
						) }
						{ stats.avg_words_per_sentence !== undefined && (
							<>
								<dt>
									{ __( 'Avg. words/sentence', 'content-guidelines' ) }
								</dt>
								<dd>{ stats.avg_words_per_sentence }</dd>
							</>
						) }
					</dl>
				</div>
			) }
		</PanelBody>
	);
}
</file>

<file path="src/store/actions.js">
/**
 * WordPress dependencies
 */
import apiFetch from '@wordpress/api-fetch';

/**
 * Action types.
 */
export const SET_GUIDELINES = 'SET_GUIDELINES';
export const SET_DRAFT = 'SET_DRAFT';
export const SET_SAVING = 'SET_SAVING';
export const SET_PUBLISHING = 'SET_PUBLISHING';
export const SET_ERROR = 'SET_ERROR';
export const SET_REVISIONS = 'SET_REVISIONS';
export const SET_RESTORING = 'SET_RESTORING';
export const SET_TEST_RESULTS = 'SET_TEST_RESULTS';
export const SET_RUNNING_TEST = 'SET_RUNNING_TEST';

/**
 * Set guidelines data.
 *
 * @param {Object} data Guidelines data.
 * @return {Object} Action object.
 */
export function setGuidelines( data ) {
	return {
		type: SET_GUIDELINES,
		payload: data,
	};
}

/**
 * Set draft guidelines.
 *
 * @param {Object} draft Draft data.
 * @return {Object} Action object.
 */
export function setDraft( draft ) {
	return {
		type: SET_DRAFT,
		payload: draft,
	};
}

/**
 * Set saving state.
 *
 * @param {boolean} isSaving Whether saving.
 * @return {Object} Action object.
 */
export function setSaving( isSaving ) {
	return {
		type: SET_SAVING,
		payload: isSaving,
	};
}

/**
 * Set publishing state.
 *
 * @param {boolean} isPublishing Whether publishing.
 * @return {Object} Action object.
 */
export function setPublishing( isPublishing ) {
	return {
		type: SET_PUBLISHING,
		payload: isPublishing,
	};
}

/**
 * Set error.
 *
 * @param {string|null} error Error message.
 * @return {Object} Action object.
 */
export function setError( error ) {
	return {
		type: SET_ERROR,
		payload: error,
	};
}

/**
 * Set revisions.
 *
 * @param {Array} revisions Revisions list.
 * @return {Object} Action object.
 */
export function setRevisions( revisions ) {
	return {
		type: SET_REVISIONS,
		payload: revisions,
	};
}

/**
 * Set restoring state.
 *
 * @param {boolean} isRestoring Whether restoring.
 * @return {Object} Action object.
 */
export function setRestoring( isRestoring ) {
	return {
		type: SET_RESTORING,
		payload: isRestoring,
	};
}

/**
 * Set test results.
 *
 * @param {Object} results Test results.
 * @return {Object} Action object.
 */
export function setTestResults( results ) {
	return {
		type: SET_TEST_RESULTS,
		payload: results,
	};
}

/**
 * Set running test state.
 *
 * @param {boolean} isRunning Whether running.
 * @return {Object} Action object.
 */
export function setRunningTest( isRunning ) {
	return {
		type: SET_RUNNING_TEST,
		payload: isRunning,
	};
}

/**
 * Update draft and optionally save to server.
 *
 * @param {Object}  updates     Updates to apply.
 * @param {boolean} saveToServer Whether to save to server.
 * @return {Function} Thunk action.
 */
export function updateDraft( updates, saveToServer = false ) {
	return async ( { dispatch, select } ) => {
		const currentDraft = select.getDraft() || select.getActive() || {};
		const newDraft = {
			...currentDraft,
			...updates,
		};

		dispatch.setDraft( newDraft );

		if ( saveToServer ) {
			await dispatch.saveDraft();
		}
	};
}

/**
 * Deep merge for nested objects.
 *
 * @param {Object} updates Section updates.
 * @param {string} section Section name.
 * @return {Function} Thunk action.
 */
export function updateDraftSection( section, updates ) {
	return async ( { dispatch, select } ) => {
		const currentDraft = select.getDraft() || select.getActive() || {};
		const currentSection = currentDraft[ section ] || {};

		const newDraft = {
			...currentDraft,
			[ section ]: {
				...currentSection,
				...updates,
			},
		};

		dispatch.setDraft( newDraft );
	};
}

/**
 * Save draft to server.
 *
 * @return {Function} Thunk action.
 */
export function saveDraft() {
	return async ( { dispatch, select } ) => {
		const draft = select.getDraft();

		if ( ! draft ) {
			return;
		}

		dispatch.setSaving( true );
		dispatch.setError( null );

		try {
			await apiFetch( {
				path: '/wp/v2/content-guidelines/draft',
				method: 'PUT',
				data: { guidelines: draft },
			} );
		} catch ( error ) {
			dispatch.setError( error.message || 'Failed to save draft.' );
		} finally {
			dispatch.setSaving( false );
		}
	};
}

/**
 * Publish draft.
 *
 * @return {Function} Thunk action.
 */
export function publishDraft() {
	return async ( { dispatch, select } ) => {
		const draft = select.getDraft();

		if ( ! draft ) {
			return;
		}

		dispatch.setPublishing( true );
		dispatch.setError( null );

		try {
			// First save the draft.
			await apiFetch( {
				path: '/wp/v2/content-guidelines/draft',
				method: 'PUT',
				data: { guidelines: draft },
			} );

			// Then publish.
			await apiFetch( {
				path: '/wp/v2/content-guidelines/publish',
				method: 'POST',
			} );

			// Refresh guidelines.
			const data = await apiFetch( {
				path: '/wp/v2/content-guidelines',
			} );

			dispatch.setGuidelines( data );
			dispatch.setDraft( null );
		} catch ( error ) {
			dispatch.setError( error.message || 'Failed to publish.' );
		} finally {
			dispatch.setPublishing( false );
		}
	};
}

/**
 * Discard draft.
 *
 * @return {Function} Thunk action.
 */
export function discardDraft() {
	return async ( { dispatch, select } ) => {
		dispatch.setError( null );

		try {
			await apiFetch( {
				path: '/wp/v2/content-guidelines/discard-draft',
				method: 'POST',
			} );

			// Reset draft to active guidelines
			const active = select.getActive();
			if ( active ) {
				dispatch.setDraft( { ...active } );
			} else {
				dispatch.setDraft( null );
			}
		} catch ( error ) {
			dispatch.setError( error.message || 'Failed to discard draft.' );
		}
	};
}

/**
 * Fetch revisions.
 *
 * @return {Function} Thunk action.
 */
export function fetchRevisions() {
	return async ( { dispatch } ) => {
		try {
			const revisions = await apiFetch( {
				path: '/wp/v2/content-guidelines/revisions',
			} );

			dispatch.setRevisions( revisions );
		} catch ( error ) {
			// Silently fail for revisions.
		}
	};
}

/**
 * Restore a revision.
 *
 * @param {number} revisionId Revision ID.
 * @return {Function} Thunk action.
 */
export function restoreRevision( revisionId ) {
	return async ( { dispatch } ) => {
		dispatch.setRestoring( true );
		dispatch.setError( null );

		try {
			await apiFetch( {
				path: `/wp/v2/content-guidelines/restore/${ revisionId }`,
				method: 'POST',
			} );

			// Refresh guidelines.
			const data = await apiFetch( {
				path: '/wp/v2/content-guidelines',
			} );

			dispatch.setGuidelines( data );

			// Refresh revisions.
			await dispatch.fetchRevisions();
		} catch ( error ) {
			dispatch.setError( error.message || 'Failed to restore revision.' );
		} finally {
			dispatch.setRestoring( false );
		}
	};
}

/**
 * Run playground test.
 *
 * @param {Object} options Test options.
 * @return {Function} Thunk action.
 */
export function runPlaygroundTest( options ) {
	return async ( { dispatch } ) => {
		dispatch.setRunningTest( true );
		dispatch.setTestResults( null );
		dispatch.setError( null );

		try {
			const results = await apiFetch( {
				path: '/wp/v2/content-guidelines/test',
				method: 'POST',
				data: options,
			} );

			dispatch.setTestResults( results );
		} catch ( error ) {
			dispatch.setError( error.message || 'Failed to run test.' );
		} finally {
			dispatch.setRunningTest( false );
		}
	};
}

/**
 * Initialize editor with draft from active.
 *
 * @return {Function} Thunk action.
 */
export function initializeEditor() {
	return async ( { dispatch, select } ) => {
		const hasDraft = select.hasDraft();

		if ( ! hasDraft ) {
			const active = select.getActive();
			if ( active ) {
				dispatch.setDraft( { ...active } );
			}
		}
	};
}

/**
 * Update block-specific guidelines.
 *
 * @param {string} blockName  Block name (e.g., 'core/paragraph').
 * @param {Object} guidelines Guidelines for this block.
 * @return {Function} Thunk action.
 */
export function updateBlockGuidelines( blockName, guidelines ) {
	return async ( { dispatch, select } ) => {
		const currentDraft = select.getDraft() || select.getActive() || {};
		const currentBlocks = currentDraft.blocks || {};

		const newDraft = {
			...currentDraft,
			blocks: {
				...currentBlocks,
				[ blockName ]: guidelines,
			},
		};

		dispatch.setDraft( newDraft );
	};
}

/**
 * Alias for publishDraft.
 *
 * @return {Function} Thunk action.
 */
export function publishGuidelines() {
	return publishDraft();
}
</file>

<file path="src/store/reducer.js">
/**
 * Internal dependencies
 */
import {
	SET_GUIDELINES,
	SET_DRAFT,
	SET_SAVING,
	SET_PUBLISHING,
	SET_ERROR,
	SET_REVISIONS,
	SET_RESTORING,
	SET_TEST_RESULTS,
	SET_RUNNING_TEST,
} from './actions';

/**
 * Default state.
 */
const DEFAULT_STATE = {
	active: null,
	draft: null,
	postId: null,
	updatedAt: null,
	revisionCount: 0,
	isSaving: false,
	isPublishing: false,
	error: null,
	revisions: [],
	isRestoring: false,
	testResults: null,
	isRunningTest: false,
};

/**
 * Reducer.
 *
 * @param {Object} state  Current state.
 * @param {Object} action Action object.
 * @return {Object} New state.
 */
export default function reducer( state = DEFAULT_STATE, action ) {
	switch ( action.type ) {
		case SET_GUIDELINES:
			return {
				...state,
				active: action.payload.active,
				draft: action.payload.draft || state.draft,
				postId: action.payload.post_id,
				updatedAt: action.payload.updated_at,
				revisionCount: action.payload.revision_count,
			};

		case SET_DRAFT:
			return {
				...state,
				draft: action.payload,
			};

		case SET_SAVING:
			return {
				...state,
				isSaving: action.payload,
			};

		case SET_PUBLISHING:
			return {
				...state,
				isPublishing: action.payload,
			};

		case SET_ERROR:
			return {
				...state,
				error: action.payload,
			};

		case SET_REVISIONS:
			return {
				...state,
				revisions: action.payload,
			};

		case SET_RESTORING:
			return {
				...state,
				isRestoring: action.payload,
			};

		case SET_TEST_RESULTS:
			return {
				...state,
				testResults: action.payload,
			};

		case SET_RUNNING_TEST:
			return {
				...state,
				isRunningTest: action.payload,
			};

		default:
			return state;
	}
}
</file>

<file path="src/store/resolvers.js">
/**
 * WordPress dependencies
 */
import apiFetch from '@wordpress/api-fetch';

/**
 * Internal dependencies
 */
import { setGuidelines, setRevisions, setError } from './actions';

/**
 * Resolver for getActive.
 * Fetches guidelines from the API.
 *
 * @return {Function} Thunk action.
 */
export function getActive() {
	return async ( { dispatch } ) => {
		try {
			const data = await apiFetch( {
				path: '/wp/v2/content-guidelines',
			} );

			dispatch( setGuidelines( data ) );
		} catch ( error ) {
			dispatch( setError( error.message || 'Failed to fetch guidelines.' ) );
		}
	};
}

/**
 * Resolver for getDraft.
 * Uses the same fetch as getActive.
 *
 * @return {Function} Thunk action.
 */
export function getDraft() {
	return getActive();
}

/**
 * Resolver for getCurrentGuidelines.
 * Uses the same fetch as getActive.
 *
 * @return {Function} Thunk action.
 */
export function getCurrentGuidelines() {
	return getActive();
}

/**
 * Resolver for hasGuidelines.
 * Uses the same fetch as getActive.
 *
 * @return {Function} Thunk action.
 */
export function hasGuidelines() {
	return getActive();
}

/**
 * Resolver for getRevisions.
 * Fetches revision history from the API.
 *
 * @return {Function} Thunk action.
 */
export function getRevisions() {
	return async ( { dispatch } ) => {
		try {
			const revisions = await apiFetch( {
				path: '/wp/v2/content-guidelines/revisions',
			} );

			dispatch( setRevisions( revisions ) );
		} catch ( error ) {
			// Silently fail for revisions - not critical.
		}
	};
}
</file>

<file path="src/store/selectors.js">
/**
 * Get active guidelines.
 *
 * @param {Object} state Store state.
 * @return {Object|null} Active guidelines.
 */
export function getActive( state ) {
	return state.active;
}

/**
 * Get draft guidelines.
 *
 * @param {Object} state Store state.
 * @return {Object|null} Draft guidelines.
 */
export function getDraft( state ) {
	return state.draft;
}

/**
 * Check if draft exists.
 *
 * @param {Object} state Store state.
 * @return {boolean} Whether draft exists.
 */
export function hasDraft( state ) {
	return state.draft !== null;
}

/**
 * Alias for hasDraft - for consistent getter naming.
 *
 * @param {Object} state Store state.
 * @return {boolean} Whether draft exists.
 */
export function getHasDraft( state ) {
	return hasDraft( state );
}

/**
 * Get the current guidelines to edit (draft or active).
 *
 * @param {Object} state Store state.
 * @return {Object|null} Current guidelines.
 */
export function getCurrentGuidelines( state ) {
	return state.draft || state.active;
}

/**
 * Get post ID.
 *
 * @param {Object} state Store state.
 * @return {number|null} Post ID.
 */
export function getPostId( state ) {
	return state.postId;
}

/**
 * Get updated at timestamp.
 *
 * @param {Object} state Store state.
 * @return {string|null} Updated at.
 */
export function getUpdatedAt( state ) {
	return state.updatedAt;
}

/**
 * Get revision count.
 *
 * @param {Object} state Store state.
 * @return {number} Revision count.
 */
export function getRevisionCount( state ) {
	return state.revisionCount;
}

/**
 * Check if saving.
 *
 * @param {Object} state Store state.
 * @return {boolean} Whether saving.
 */
export function isSaving( state ) {
	return state.isSaving;
}

/**
 * Check if publishing.
 *
 * @param {Object} state Store state.
 * @return {boolean} Whether publishing.
 */
export function isPublishing( state ) {
	return state.isPublishing;
}

/**
 * Get error.
 *
 * @param {Object} state Store state.
 * @return {string|null} Error message.
 */
export function getError( state ) {
	return state.error;
}

/**
 * Get revisions list.
 *
 * @param {Object} state Store state.
 * @return {Array} Revisions.
 */
export function getRevisions( state ) {
	return state.revisions;
}

/**
 * Check if restoring.
 *
 * @param {Object} state Store state.
 * @return {boolean} Whether restoring.
 */
export function isRestoring( state ) {
	return state.isRestoring;
}

/**
 * Get test results.
 *
 * @param {Object} state Store state.
 * @return {Object|null} Test results.
 */
export function getTestResults( state ) {
	return state.testResults;
}

/**
 * Check if running test.
 *
 * @param {Object} state Store state.
 * @return {boolean} Whether running test.
 */
export function isRunningTest( state ) {
	return state.isRunningTest;
}

/**
 * Check if guidelines exist (either active or draft).
 *
 * @param {Object} state Store state.
 * @return {boolean} Whether guidelines exist.
 */
export function hasGuidelines( state ) {
	return state.active !== null || state.draft !== null;
}

/**
 * Check if draft has changes from active.
 *
 * @param {Object} state Store state.
 * @return {boolean} Whether draft differs from active.
 */
export function draftHasChanges( state ) {
	if ( ! state.draft ) {
		return false;
	}

	if ( ! state.active ) {
		return true;
	}

	// Simple JSON comparison.
	return JSON.stringify( state.draft ) !== JSON.stringify( state.active );
}

/**
 * Get a specific section from current guidelines.
 *
 * @param {Object} state   Store state.
 * @param {string} section Section name.
 * @return {Object|null} Section data.
 */
export function getSection( state, section ) {
	const current = state.draft || state.active;
	return current ? current[ section ] : null;
}

/**
 * Get brand context section.
 *
 * @param {Object} state Store state.
 * @return {Object|null} Brand context.
 */
export function getBrandContext( state ) {
	return getSection( state, 'brand_context' );
}

/**
 * Get voice & tone section.
 *
 * @param {Object} state Store state.
 * @return {Object|null} Voice & tone.
 */
export function getVoiceTone( state ) {
	return getSection( state, 'voice_tone' );
}

/**
 * Get copy rules section.
 *
 * @param {Object} state Store state.
 * @return {Object|null} Copy rules.
 */
export function getCopyRules( state ) {
	return getSection( state, 'copy_rules' );
}

/**
 * Get vocabulary section.
 *
 * @param {Object} state Store state.
 * @return {Object|null} Vocabulary.
 */
export function getVocabulary( state ) {
	return getSection( state, 'vocabulary' );
}

/**
 * Get image style section.
 *
 * @param {Object} state Store state.
 * @return {Object|null} Image style.
 */
export function getImageStyle( state ) {
	return getSection( state, 'image_style' );
}

/**
 * Get notes.
 *
 * @param {Object} state Store state.
 * @return {string|null} Notes.
 */
export function getNotes( state ) {
	const current = state.draft || state.active;
	return current ? current.notes : null;
}
</file>

<file path="src/commands-loader.js">
/**
 * Global Command Palette commands loader.
 *
 * This entry point is enqueued across the entire WordPress admin
 * to register Content Guidelines commands in the admin-wide Command Palette.
 *
 * @package ContentGuidelines
 * @since 0.2.0
 */

/**
 * WordPress dependencies
 */
import { createRoot } from '@wordpress/element';
import { PluginArea } from '@wordpress/plugins';
import { registerPlugin } from '@wordpress/plugins';

/**
 * Internal dependencies
 */
import './store'; // Ensure store is registered
import ContentGuidelinesCommands from './commands';

/**
 * Register the commands plugin.
 *
 * This uses the WordPress plugin API to register our commands
 * component which will hook into the Command Palette system.
 */
registerPlugin( 'content-guidelines-commands', {
	render: ContentGuidelinesCommands,
} );

/**
 * Initialize the plugin area if not already present.
 *
 * The PluginArea component is needed for plugins registered
 * via registerPlugin to be rendered and activated.
 */
function initCommandsPluginArea() {
	// Check if there's already a plugin area mount point
	let mountPoint = document.getElementById(
		'content-guidelines-commands-mount'
	);

	if ( ! mountPoint ) {
		mountPoint = document.createElement( 'div' );
		mountPoint.id = 'content-guidelines-commands-mount';
		mountPoint.style.display = 'none';
		document.body.appendChild( mountPoint );
	}

	// Only render if we have the commands package available
	if ( typeof wp !== 'undefined' && wp.commands ) {
		const root = createRoot( mountPoint );
		root.render( <PluginArea scope="content-guidelines" /> );
	}
}

// Initialize when DOM is ready
if ( document.readyState === 'loading' ) {
	document.addEventListener( 'DOMContentLoaded', initCommandsPluginArea );
} else {
	initCommandsPluginArea();
}
</file>

<file path="src/index.js">
/**
 * WordPress dependencies
 */
import { createRoot } from '@wordpress/element';
import { __ } from '@wordpress/i18n';

/**
 * Internal dependencies
 */
import './store';
import GuidelinesPage from './components/guidelines-page';
import './style.scss';

/**
 * Initialize the Content Guidelines admin page.
 */
function initContentGuidelines() {
	const config = window.contentGuidelinesConfig;

	if ( ! config || ! config.mountId ) {
		// eslint-disable-next-line no-console
		console.error( 'Content Guidelines: Missing configuration' );
		return;
	}

	const container = document.getElementById( config.mountId );

	if ( ! container ) {
		// eslint-disable-next-line no-console
		console.error(
			`Content Guidelines: Mount element #${ config.mountId } not found`
		);
		return;
	}

	const root = createRoot( container );
	root.render( <GuidelinesPage /> );
}

// Initialize when DOM is ready.
if ( document.readyState === 'loading' ) {
	document.addEventListener( 'DOMContentLoaded', initContentGuidelines );
} else {
	initContentGuidelines();
}

/**
 * Export components for potential external use.
 */
export { default as GuidelinesPage } from './components/guidelines-page';
export { STORE_NAME } from './store';
</file>

<file path="src/style.scss">
/**
 * Content Guidelines Main Styles
 */

// Panels shared styles
.content-guidelines-panel-section {
	margin-bottom: 24px;

	&:last-child {
		margin-bottom: 0;
	}
}

.content-guidelines-panel-section__title {
	margin: 0 0 8px;
	font-size: 12px;
	font-weight: 600;
	text-transform: uppercase;
	color: #757575;
}

.content-guidelines-panel-section__description {
	margin: 0 0 12px;
	font-size: 13px;
	color: #757575;
}

// Repeater shared styles
.content-guidelines-repeater,
.content-guidelines-term-repeater {
	display: flex;
	flex-direction: column;
	gap: 8px;

	.components-flex {
		margin-bottom: 0;
	}

	.components-text-control__input {
		margin-bottom: 0;
	}

	.components-button.is-secondary {
		margin-top: 8px;
	}
}

.content-guidelines-term-repeater__item {
	padding: 12px;
	background: #f6f7f7;
	border-radius: 4px;
	margin-bottom: 8px;

	.components-base-control {
		margin-bottom: 0;
	}
}

// Panel body customization
.content-guidelines-sidebar__panels {
	.components-panel__body {
		border: 1px solid #e0e0e0;
		border-radius: 4px;
		margin-bottom: 8px;
		background: #fff;

		&:last-child {
			margin-bottom: 0;
		}
	}

	.components-panel__body-title {
		border-bottom: none;
	}

	.components-panel__body.is-opened {
		.components-panel__body-title {
			border-bottom: 1px solid #e0e0e0;
		}
	}
}
</file>

<file path=".gitignore">
# Dependencies
node_modules/

# Build output
build/

# Environment
.env
.env.local
.env.*.local

# IDE
.idea/
.vscode/
*.swp
*.swo
.DS_Store

# Logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Package manager locks (keep pnpm-lock.yaml)
package-lock.json
yarn.lock

# WordPress
*.sql
*.sql.gz
</file>

<file path="content-guidelines.php">
<?php
/**
 * Plugin Name: Content Guidelines
 * Plugin URI: https://github.com/WordPress/gutenberg
 * Description: Site-level editorial guidelines for WordPress. Define voice, tone, copy rules, and vocabulary that AI features can consume.
 * Version: 0.2.0
 * Author: WordPress Contributors
 * License: GPL-2.0-or-later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain: content-guidelines
 * Requires at least: 6.7
 * Requires PHP: 7.4
 * Requires Plugins: gutenberg
 *
 * @package ContentGuidelines
 */

namespace ContentGuidelines;

defined( 'ABSPATH' ) || exit;

define( 'CONTENT_GUIDELINES_VERSION', '0.2.0' );
define( 'CONTENT_GUIDELINES_PLUGIN_DIR', plugin_dir_path( __FILE__ ) );
define( 'CONTENT_GUIDELINES_PLUGIN_URL', plugin_dir_url( __FILE__ ) );

/**
 * Autoloader for plugin classes.
 */
spl_autoload_register(
	function ( $class ) {
		$prefix   = 'ContentGuidelines\\';
		$base_dir = CONTENT_GUIDELINES_PLUGIN_DIR . 'includes/';

		$len = strlen( $prefix );
		if ( strncmp( $prefix, $class, $len ) !== 0 ) {
			return;
		}

		$relative_class = substr( $class, $len );
		$file           = $base_dir . 'class-' . strtolower( str_replace( '_', '-', $relative_class ) ) . '.php';

		if ( file_exists( $file ) ) {
			require $file;
		}
	}
);

/**
 * Initialize the plugin.
 */
function init() {
	// Load text domain.
	load_plugin_textdomain( 'content-guidelines', false, dirname( plugin_basename( __FILE__ ) ) . '/languages' );

	// Initialize components.
	Post_Type::init();
	REST_Controller::init();
	Hooks::init();
	Abilities::init();

	// Register admin menu.
	add_action( 'admin_menu', __NAMESPACE__ . '\\register_admin_menu' );

	// Enqueue admin scripts.
	add_action( 'admin_enqueue_scripts', __NAMESPACE__ . '\\enqueue_admin_scripts' );

	// Enqueue global command palette commands.
	add_action( 'admin_enqueue_scripts', __NAMESPACE__ . '\\enqueue_command_palette_scripts' );
}
add_action( 'plugins_loaded', __NAMESPACE__ . '\\init' );

/**
 * Register the Content Guidelines menu item under Appearance.
 */
function register_admin_menu() {
	add_submenu_page(
		'themes.php',
		__( 'Guidelines', 'content-guidelines' ),
		__( 'Guidelines', 'content-guidelines' ),
		'edit_theme_options',
		'content-guidelines-wp-admin',
		__NAMESPACE__ . '\\render_admin_page'
	);
}

/**
 * Preload REST API data for the admin page.
 */
function preload_rest_data() {
	$preload_paths = array(
		'/?_fields=description,gmt_offset,home,name,site_icon,site_icon_url,site_logo,timezone_string,url,page_for_posts,page_on_front,show_on_front',
		'/wp/v2/content-guidelines',
		array( '/wp/v2/settings', 'OPTIONS' ),
	);

	$preload_data = array_reduce(
		$preload_paths,
		'rest_preload_api_request',
		array()
	);

	wp_add_inline_script(
		'wp-api-fetch',
		sprintf(
			'wp.apiFetch.use( wp.apiFetch.createPreloadingMiddleware( %s ) );',
			wp_json_encode( $preload_data )
		),
		'after'
	);
}

/**
 * Enqueue scripts and styles for the admin page.
 *
 * @param string $hook_suffix The current admin page.
 */
function enqueue_admin_scripts( $hook_suffix ) {
	// Check if we're on our admin page.
	$is_our_page = isset( $_GET['page'] ) && 'content-guidelines-wp-admin' === $_GET['page']; // phpcs:ignore WordPress.Security.NonceVerification.Recommended

	if ( ! $is_our_page ) {
		return;
	}

	// Preload REST API data.
	preload_rest_data();

	$asset_file = CONTENT_GUIDELINES_PLUGIN_DIR . 'build/index.asset.php';

	if ( ! file_exists( $asset_file ) ) {
		return;
	}

	$asset = require $asset_file;

	// Define the routes for the boot system.
	$routes = array(
		array(
			'path' => '/',
		),
		array(
			'path' => '/history',
		),
		array(
			'path' => '/playground',
		),
	);

	// Register and enqueue the main script.
	wp_register_script(
		'content-guidelines-admin',
		CONTENT_GUIDELINES_PLUGIN_URL . 'build/index.js',
		$asset['dependencies'],
		$asset['version'],
		true
	);

	// Pass routes config to JS.
	wp_add_inline_script(
		'content-guidelines-admin',
		sprintf(
			'window.contentGuidelinesConfig = { mountId: "content-guidelines-wp-admin-app", routes: %s };',
			wp_json_encode( $routes, JSON_HEX_TAG | JSON_UNESCAPED_SLASHES )
		),
		'before'
	);

	wp_enqueue_script( 'content-guidelines-admin' );

	// Enqueue media library for reference images.
	wp_enqueue_media();

	// Enqueue styles.
	if ( file_exists( CONTENT_GUIDELINES_PLUGIN_DIR . 'build/style-index.css' ) ) {
		wp_enqueue_style(
			'content-guidelines-admin',
			CONTENT_GUIDELINES_PLUGIN_URL . 'build/style-index.css',
			array( 'wp-components' ),
			$asset['version']
		);
	}

	wp_set_script_translations( 'content-guidelines-admin', 'content-guidelines' );
}

/**
 * Enqueue Command Palette scripts globally across the admin.
 *
 * This enables Content Guidelines commands in the WordPress 6.9+ admin-wide
 * Command Palette (Ctrl/Cmd + K) from any admin screen.
 *
 * @param string $hook_suffix The current admin page.
 */
function enqueue_command_palette_scripts( $hook_suffix ) {
	// Only load if WordPress 6.9+ Command Palette is available.
	if ( ! wp_script_is( 'wp-commands', 'registered' ) ) {
		return;
	}

	$asset_file = CONTENT_GUIDELINES_PLUGIN_DIR . 'build/commands-loader.asset.php';

	if ( ! file_exists( $asset_file ) ) {
		return;
	}

	$asset = require $asset_file;

	// Register and enqueue the commands loader script.
	wp_register_script(
		'content-guidelines-commands',
		CONTENT_GUIDELINES_PLUGIN_URL . 'build/commands-loader.js',
		array_merge( $asset['dependencies'], array( 'wp-commands' ) ),
		$asset['version'],
		true
	);

	// Pass configuration to the commands script.
	wp_add_inline_script(
		'content-guidelines-commands',
		sprintf(
			'window.contentGuidelinesCommandsConfig = { adminUrl: %s, restUrl: %s, nonce: %s };',
			wp_json_encode( admin_url() ),
			wp_json_encode( rest_url( 'wp/v2/content-guidelines' ) ),
			wp_json_encode( wp_create_nonce( 'wp_rest' ) )
		),
		'before'
	);

	wp_enqueue_script( 'content-guidelines-commands' );

	wp_set_script_translations( 'content-guidelines-commands', 'content-guidelines' );
}

/**
 * Render the admin page.
 */
function render_admin_page() {
	?>
	<style>
		/* Critical styles - match fonts library exactly */

		/* Reset wp-admin padding */
		#wpcontent {
			padding-left: 0;
		}
		#wpbody-content {
			padding-bottom: 0;
		}

		/* Hide footer */
		#wpfooter {
			display: none;
		}

		/* Boot container - rounded white card */
		.boot-layout-container {
			background: #fff;
			border-radius: 8px;
			margin: 0 8px 8px 8px;
			min-height: calc(100vh - 32px - 8px);
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}

		/* Responsive */
		@media (max-width: 782px) {
			.boot-layout-container {
				margin: 0 8px 8px 8px;
				min-height: calc(100vh - 46px - 8px);
			}
		}

		@media (max-width: 600px) {
			.boot-layout-container {
				margin: 0;
				border-radius: 0;
				min-height: calc(100vh - 46px);
			}
		}
	</style>
	<script>
		// Match background to admin menu color scheme dynamically
		(function() {
			var adminMenu = document.getElementById('adminmenuwrap');
			if (adminMenu) {
				var bgColor = getComputedStyle(adminMenu).backgroundColor;
				document.getElementById('wpwrap').style.backgroundColor = bgColor;
				// Update menu arrow to match
				var style = document.createElement('style');
				style.textContent = 'ul#adminmenu a.wp-has-current-submenu::after, ul#adminmenu > li.current > a.current::after { border-right-color: ' + bgColor + ' !important; }';
				document.head.appendChild(style);
			}
		})();
	</script>
	<div id="content-guidelines-wp-admin-app" class="boot-layout-container"></div>
	<?php
}

/**
 * Get the content guidelines for a site.
 *
 * @param string $use Which version to get: 'active' or 'draft'. Default 'active'.
 * @return array|null The guidelines data or null if not set.
 */
function get_content_guidelines( $use = 'active' ) {
	return Context_Packet_Builder::get_guidelines( $use );
}

/**
 * Get the context packet for AI consumption.
 *
 * @param array $args {
 *     Optional. Arguments for building the context packet.
 *
 *     @type string $task       Task type: 'writing', 'headline', 'cta', 'image', 'coach'. Default 'writing'.
 *     @type int    $post_id    Optional. Context post ID for per-post overrides.
 *     @type string $use        Which guidelines version: 'active' or 'draft'. Default 'active'.
 *     @type int    $max_chars  Maximum characters for the packet text. Default 2000.
 *     @type string $locale     Optional. Locale for multilingual sites.
 *     @type string $block_name Optional. Block name for block-specific guidelines.
 * }
 * @return array {
 *     The context packet.
 *
 *     @type string $packet_text       Formatted text for LLM prompts.
 *     @type array  $packet_structured Structured subset of guidelines relevant to task.
 *     @type int    $guidelines_id     Post ID of the guidelines entity.
 *     @type int    $revision_id       Current revision ID.
 *     @type string $updated_at        ISO 8601 timestamp of last update.
 * }
 */
function get_content_guidelines_packet( $args = array() ) {
	return Context_Packet_Builder::get_packet( $args );
}

/**
 * Get content guidelines for a specific post, with block-specific rules.
 *
 * @param int|\WP_Post $post Post ID or post object.
 * @param array        $args Optional arguments (task, use).
 * @return array Context packet with block-aware guidelines.
 */
function get_content_guidelines_for_post( $post, $args = array() ) {
	$post = get_post( $post );
	if ( ! $post ) {
		return array(
			'error'           => 'invalid_post',
			'packet_text'     => '',
			'blocks_in_post'  => array(),
			'block_guidelines' => array(),
		);
	}

	$defaults = array(
		'task' => 'writing',
		'use'  => 'active',
	);
	$args = wp_parse_args( $args, $defaults );

	// Parse blocks from post content.
	$blocks      = parse_blocks( $post->post_content );
	$block_names = extract_block_names_recursive( $blocks );
	$block_names = array_unique( $block_names );

	// Get guidelines.
	$guidelines = Context_Packet_Builder::get_guidelines( $args['use'] );
	$post_obj   = Post_Type::get_guidelines_post();

	if ( ! $guidelines ) {
		return array(
			'packet_text'       => '',
			'packet_structured' => array(),
			'blocks_in_post'    => $block_names,
			'block_guidelines'  => array(),
			'guidelines_id'     => null,
			'updated_at'        => null,
		);
	}

	// Get base packet.
	$base_packet = Context_Packet_Builder::get_packet(
		array(
			'task' => $args['task'],
			'use'  => $args['use'],
		)
	);

	// Collect block-specific guidelines.
	$block_guidelines = array();
	$all_blocks_data  = isset( $guidelines['blocks'] ) ? $guidelines['blocks'] : array();

	foreach ( $block_names as $block_name ) {
		if ( isset( $all_blocks_data[ $block_name ] ) && ! empty( $all_blocks_data[ $block_name ] ) ) {
			$block_guidelines[ $block_name ] = $all_blocks_data[ $block_name ];
		}
	}

	// Build combined packet text with block rules.
	$packet_text = $base_packet['packet_text'];
	if ( ! empty( $block_guidelines ) ) {
		$packet_text .= "\n### Block-Specific Rules\n";
		foreach ( $block_guidelines as $block_name => $rules ) {
			$packet_text .= "\n**{$block_name}:**\n";
			if ( ! empty( $rules['copy_rules']['dos'] ) ) {
				$packet_text .= "DO:\n";
				foreach ( $rules['copy_rules']['dos'] as $rule ) {
					$packet_text .= "- {$rule}\n";
				}
			}
			if ( ! empty( $rules['copy_rules']['donts'] ) ) {
				$packet_text .= "DON'T:\n";
				foreach ( $rules['copy_rules']['donts'] as $rule ) {
					$packet_text .= "- {$rule}\n";
				}
			}
			if ( ! empty( $rules['notes'] ) ) {
				$packet_text .= "Note: {$rules['notes']}\n";
			}
		}
	}

	return array(
		'packet_text'       => $packet_text,
		'packet_structured' => $base_packet['packet_structured'],
		'blocks_in_post'    => $block_names,
		'block_guidelines'  => $block_guidelines,
		'guidelines_id'     => $post_obj ? $post_obj->ID : null,
		'updated_at'        => $post_obj ? $post_obj->post_modified_gmt : null,
	);
}

/**
 * Recursively extract block names from parsed blocks.
 *
 * @param array $blocks Parsed blocks array.
 * @return array Block names.
 */
function extract_block_names_recursive( $blocks ) {
	$names = array();
	foreach ( $blocks as $block ) {
		if ( ! empty( $block['blockName'] ) ) {
			$names[] = $block['blockName'];
		}
		if ( ! empty( $block['innerBlocks'] ) ) {
			$names = array_merge( $names, extract_block_names_recursive( $block['innerBlocks'] ) );
		}
	}
	return $names;
}

/**
 * Get guidelines for specific block types.
 *
 * @param string|array $block_names Block name(s) to get guidelines for.
 * @param array        $args        Optional arguments (task, use).
 * @return array Block guidelines data.
 */
function get_block_guidelines( $block_names, $args = array() ) {
	$defaults = array(
		'task' => 'writing',
		'use'  => 'active',
	);
	$args = wp_parse_args( $args, $defaults );

	if ( ! is_array( $block_names ) ) {
		$block_names = array( $block_names );
	}

	$guidelines = Context_Packet_Builder::get_guidelines( $args['use'] );
	$post       = Post_Type::get_guidelines_post();

	if ( ! $guidelines ) {
		return array(
			'site_rules'     => array(),
			'blocks'         => array(),
			'packet_text'    => '',
			'guidelines_id'  => null,
		);
	}

	// Get site-level copy rules.
	$site_rules = isset( $guidelines['copy_rules'] ) ? $guidelines['copy_rules'] : array();

	// Get block-specific rules.
	$blocks          = array();
	$all_blocks_data = isset( $guidelines['blocks'] ) ? $guidelines['blocks'] : array();

	foreach ( $block_names as $block_name ) {
		if ( isset( $all_blocks_data[ $block_name ] ) ) {
			$blocks[ $block_name ] = $all_blocks_data[ $block_name ];
		} else {
			$blocks[ $block_name ] = null; // Block exists but has no custom rules.
		}
	}

	// Build combined packet text.
	$packet_lines = array( '## CONTENT GUIDELINES' );

	if ( ! empty( $site_rules['dos'] ) || ! empty( $site_rules['donts'] ) ) {
		$packet_lines[] = '';
		$packet_lines[] = '### Site Rules';
		if ( ! empty( $site_rules['dos'] ) ) {
			$packet_lines[] = 'DO:';
			foreach ( $site_rules['dos'] as $rule ) {
				$packet_lines[] = "- {$rule}";
			}
		}
		if ( ! empty( $site_rules['donts'] ) ) {
			$packet_lines[] = "DON'T:";
			foreach ( $site_rules['donts'] as $rule ) {
				$packet_lines[] = "- {$rule}";
			}
		}
	}

	$has_block_rules = false;
	foreach ( $blocks as $block_name => $rules ) {
		if ( $rules && ( ! empty( $rules['copy_rules'] ) || ! empty( $rules['notes'] ) ) ) {
			if ( ! $has_block_rules ) {
				$packet_lines[]  = '';
				$packet_lines[]  = '### Block-Specific Rules';
				$has_block_rules = true;
			}
			$packet_lines[] = '';
			$packet_lines[] = "**{$block_name}:**";
			if ( ! empty( $rules['copy_rules']['dos'] ) ) {
				$packet_lines[] = 'DO:';
				foreach ( $rules['copy_rules']['dos'] as $rule ) {
					$packet_lines[] = "- {$rule}";
				}
			}
			if ( ! empty( $rules['copy_rules']['donts'] ) ) {
				$packet_lines[] = "DON'T:";
				foreach ( $rules['copy_rules']['donts'] as $rule ) {
					$packet_lines[] = "- {$rule}";
				}
			}
			if ( ! empty( $rules['notes'] ) ) {
				$packet_lines[] = "Note: {$rules['notes']}";
			}
		}
	}

	return array(
		'site_rules'    => $site_rules,
		'blocks'        => $blocks,
		'packet_text'   => implode( "\n", $packet_lines ),
		'guidelines_id' => $post ? $post->ID : null,
	);
}

// Make the main functions available globally.
if ( ! function_exists( 'wp_get_content_guidelines' ) ) {
	/**
	 * Get site content guidelines.
	 *
	 * @param string $use Which version: 'active' or 'draft'.
	 * @return array|null Guidelines data.
	 */
	function wp_get_content_guidelines( $use = 'active' ) {
		return \ContentGuidelines\get_content_guidelines( $use );
	}
}

if ( ! function_exists( 'wp_get_content_guidelines_packet' ) ) {
	/**
	 * Get context packet for AI consumption.
	 *
	 * @param array $args Arguments for packet building.
	 * @return array Context packet.
	 */
	function wp_get_content_guidelines_packet( $args = array() ) {
		return \ContentGuidelines\get_content_guidelines_packet( $args );
	}
}

if ( ! function_exists( 'wp_get_content_guidelines_for_post' ) ) {
	/**
	 * Get content guidelines packet for a specific post, with block-specific rules merged.
	 *
	 * Analyzes the blocks in a post and returns a context packet that includes
	 * both site-level guidelines and any block-specific rules for the blocks
	 * present in the post. This is the primary API for agents working with
	 * post content.
	 *
	 * @param int|WP_Post $post    Post ID or post object.
	 * @param array       $args    {
	 *     Optional. Additional arguments.
	 *
	 *     @type string $task Task type: 'writing', 'headline', 'cta', 'image', 'coach'.
	 *     @type string $use  Which guidelines: 'active' or 'draft'. Default 'active'.
	 * }
	 * @return array {
	 *     Context packet with block-aware guidelines.
	 *
	 *     @type string $packet_text       Formatted text for LLM prompts.
	 *     @type array  $packet_structured Structured guidelines data.
	 *     @type array  $blocks_in_post    List of unique block names found in post.
	 *     @type array  $block_guidelines  Per-block guidelines for blocks with custom rules.
	 *     @type int    $guidelines_id     Post ID of the guidelines entity.
	 *     @type string $updated_at        ISO 8601 timestamp of last update.
	 * }
	 */
	function wp_get_content_guidelines_for_post( $post, $args = array() ) {
		return \ContentGuidelines\get_content_guidelines_for_post( $post, $args );
	}
}

if ( ! function_exists( 'wp_get_block_guidelines' ) ) {
	/**
	 * Get guidelines for specific block types.
	 *
	 * Returns both site-level and block-specific guidelines for the requested
	 * blocks. Useful when an agent needs to work with specific block types.
	 *
	 * @param string|array $block_names Single block name or array of block names.
	 * @param array        $args        {
	 *     Optional. Additional arguments.
	 *
	 *     @type string $task Task type: 'writing', 'headline', 'cta', 'image', 'coach'.
	 *     @type string $use  Which guidelines: 'active' or 'draft'. Default 'active'.
	 * }
	 * @return array {
	 *     Block guidelines data.
	 *
	 *     @type array  $site_rules       Site-level copy rules (dos, donts).
	 *     @type array  $blocks           Per-block guidelines keyed by block name.
	 *     @type string $packet_text      Combined text packet for all requested blocks.
	 *     @type int    $guidelines_id    Post ID of the guidelines entity.
	 * }
	 */
	function wp_get_block_guidelines( $block_names, $args = array() ) {
		return \ContentGuidelines\get_block_guidelines( $block_names, $args );
	}
}
</file>

<file path="package.json">
{
	"name": "@wordpress/content-guidelines",
	"version": "0.2.0",
	"description": "Site-level editorial guidelines for WordPress",
	"author": "WordPress Contributors",
	"license": "GPL-2.0-or-later",
	"main": "build/index.js",
	"repository": {
		"type": "git",
		"url": "https://github.com/WordPress/gutenberg.git",
		"directory": "packages/content-guidelines"
	},
	"bugs": {
		"url": "https://github.com/WordPress/gutenberg/issues"
	},
	"scripts": {
		"build": "wp-scripts build",
		"start": "wp-scripts start",
		"lint:js": "wp-scripts lint-js",
		"lint:css": "wp-scripts lint-style",
		"lint:pkg-json": "wp-scripts lint-pkg-json",
		"format": "wp-scripts format",
		"test:unit": "wp-scripts test-unit-js"
	},
	"devDependencies": {
		"@wordpress/build": "^0.4.0",
		"@wordpress/scripts": "^27.0.0"
	},
	"dependencies": {
		"@wordpress/admin-ui": "^1.4.0",
		"@wordpress/api-fetch": "^6.0.0",
		"@wordpress/block-editor": "^12.0.0",
		"@wordpress/boot": "^0.3.0",
		"@wordpress/commands": "^1.0.0",
		"@wordpress/components": "^25.0.0",
		"@wordpress/compose": "^6.0.0",
		"@wordpress/core-commands": "^1.0.0",
		"@wordpress/core-data": "^6.0.0",
		"@wordpress/data": "^9.0.0",
		"@wordpress/element": "^5.0.0",
		"@wordpress/hooks": "^3.0.0",
		"@wordpress/i18n": "^4.0.0",
		"@wordpress/icons": "^9.0.0",
		"@wordpress/notices": "^4.0.0",
		"@wordpress/plugins": "^6.0.0",
		"@wordpress/url": "^3.0.0"
	},
	"peerDependencies": {
		"react": "^18.0.0",
		"react-dom": "^18.0.0"
	}
}
</file>

<file path="webpack.config.js">
/**
 * WordPress dependencies
 */
const defaultConfig = require( '@wordpress/scripts/config/webpack.config' );

module.exports = {
	...defaultConfig,
	entry: {
		index: './src/index.js',
		'commands-loader': './src/commands-loader.js',
	},
};
</file>

<file path="src/components/library-panel/index.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import { useState, useEffect } from '@wordpress/element';
import {
	Navigator,
	useNavigator,
	Button,
	Spinner,
	__experimentalVStack as VStack,
	__experimentalHStack as HStack,
	__experimentalHeading as Heading,
	__experimentalSpacer as Spacer,
	__experimentalText as Text,
	__experimentalNumberControl as NumberControl,
	Flex,
	FlexItem,
	TextareaControl,
	TextControl,
	SelectControl,
	FormTokenField,
} from '@wordpress/components';
import apiFetch from '@wordpress/api-fetch';
import { chevronRight, chevronLeft } from '@wordpress/icons';
import { isRTL } from '@wordpress/i18n';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';
import RepeaterControl from '../controls/repeater-control';
import './style.scss';

/**
 * Section definitions.
 */
const SECTIONS = [
	{
		id: 'brand_context',
		title: __( 'Brand & site context', 'content-guidelines' ),
		description: __( 'Define what your site is about and who it serves.', 'content-guidelines' ),
	},
	{
		id: 'voice_tone',
		title: __( 'Voice & tone', 'content-guidelines' ),
		description: __( 'Set the personality and emotional feel of your content.', 'content-guidelines' ),
	},
	{
		id: 'copy_rules',
		title: __( 'Copy rules', 'content-guidelines' ),
		description: __( 'Specific dos and don\'ts for writing.', 'content-guidelines' ),
	},
	{
		id: 'vocabulary',
		title: __( 'Vocabulary', 'content-guidelines' ),
		description: __( 'Preferred terms and words to avoid.', 'content-guidelines' ),
	},
	{
		id: 'heuristics',
		title: __( 'Heuristics', 'content-guidelines' ),
		description: __( 'Target metrics for sentence length and structure.', 'content-guidelines' ),
	},
	{
		id: 'references',
		title: __( 'References', 'content-guidelines' ),
		description: __( 'Websites and content you want to emulate.', 'content-guidelines' ),
	},
	{
		id: 'images',
		title: __( 'Images', 'content-guidelines' ),
		description: __( 'Guidelines for image selection and alt text.', 'content-guidelines' ),
	},
	{
		id: 'notes',
		title: __( 'Additional notes', 'content-guidelines' ),
		description: __( 'Any other guidelines or context.', 'content-guidelines' ),
	},
];

/**
 * Goal options.
 */
const GOAL_OPTIONS = [
	{ value: '', label: __( 'Select a goal...', 'content-guidelines' ) },
	{ value: 'subscribe', label: __( 'Get email subscribers', 'content-guidelines' ) },
	{ value: 'sell', label: __( 'Sell products/services', 'content-guidelines' ) },
	{ value: 'inform', label: __( 'Inform and educate', 'content-guidelines' ) },
	{ value: 'community', label: __( 'Build community', 'content-guidelines' ) },
	{ value: 'other', label: __( 'Other', 'content-guidelines' ) },
];

/**
 * Section card component.
 *
 * @param {Object}   props             Component props.
 * @param {Object}   props.section     Section definition.
 * @param {string}   props.statusText  Status text.
 * @param {Function} props.onClick     Click handler.
 * @return {JSX.Element} Section card.
 */
function SectionCard( { section, statusText, onClick } ) {
	const navigator = useNavigator();

	const handleClick = () => {
		if ( onClick ) {
			onClick();
		}
		navigator.goTo( `/${ section.id }` );
	};

	return (
		<Button
			__next40pxDefaultSize
			className="library-panel__section-card"
			onClick={ handleClick }
		>
			<Flex justify="space-between">
				<FlexItem>
					<VStack spacing={ 1 }>
						<Text className="library-panel__section-title">
							{ section.title }
						</Text>
						<Text className="library-panel__section-description" variant="muted">
							{ section.description }
						</Text>
					</VStack>
				</FlexItem>
				<Flex justify="flex-end" gap={ 2 }>
					{ statusText && (
						<FlexItem>
							<Text className="library-panel__section-status" variant="muted">
								{ statusText }
							</Text>
						</FlexItem>
					) }
					<FlexItem>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							viewBox="0 0 24 24"
							width="24"
							height="24"
							aria-hidden="true"
							focusable="false"
						>
							<path d="M10.6 6L9.4 7l4.6 5-4.6 5 1.2 1 5.4-6z" />
						</svg>
					</FlexItem>
				</Flex>
			</Flex>
		</Button>
	);
}

/**
 * Analyze text content and return metrics.
 *
 * @param {string} text Raw text content.
 * @return {Object|null} Analysis results.
 */
function analyzeText( text ) {
	if ( ! text || typeof text !== 'string' ) {
		return null;
	}

	const cleanText = text
		.replace( /<[^>]*>/g, ' ' )
		.replace( /&nbsp;/g, ' ' )
		.replace( /\s+/g, ' ' )
		.trim();

	if ( ! cleanText ) {
		return null;
	}

	const sentences = cleanText
		.split( /[.!?]+(?=\s|$)/g )
		.map( ( s ) => s.trim() )
		.filter( ( s ) => s.length > 0 );

	const paragraphs = text
		.split( /(?:<\/p>|<br\s*\/?>\s*<br\s*\/?>|\n\n+)/i )
		.map( ( p ) => p.replace( /<[^>]*>/g, ' ' ).trim() )
		.filter( ( p ) => p.length > 0 );

	const words = cleanText.split( /\s+/ ).filter( ( w ) => w.length > 0 );

	return {
		wordCount: words.length,
		sentenceCount: sentences.length,
		paragraphCount: paragraphs.length,
		avgWordsPerSentence: sentences.length > 0
			? Math.round( ( words.length / sentences.length ) * 10 ) / 10
			: 0,
		avgSentencesPerParagraph: paragraphs.length > 0
			? Math.round( ( sentences.length / paragraphs.length ) * 10 ) / 10
			: 0,
	};
}

/**
 * Heuristics content component.
 *
 * @param {Object}   props             Component props.
 * @param {Object}   props.sectionData Section data.
 * @param {Function} props.onChange    Change handler.
 * @return {JSX.Element} Heuristics content.
 */
function HeuristicsContent( { sectionData, onChange } ) {
	const [ isAnalyzing, setIsAnalyzing ] = useState( false );
	const [ analysisResult, setAnalysisResult ] = useState( null );

	const runAnalysis = async () => {
		setIsAnalyzing( true );
		setAnalysisResult( null );

		try {
			const posts = await apiFetch( {
				path: '/wp/v2/posts?per_page=20&status=publish&_fields=id,content',
			} );

			if ( posts && posts.length > 0 ) {
				const analyses = posts
					.map( ( post ) => analyzeText( post.content?.rendered || '' ) )
					.filter( Boolean );

				if ( analyses.length > 0 ) {
					const avgWords = Math.round(
						analyses.reduce( ( sum, a ) => sum + a.avgWordsPerSentence, 0 ) / analyses.length
					);
					const avgSentences = Math.round(
						analyses.reduce( ( sum, a ) => sum + a.avgSentencesPerParagraph, 0 ) / analyses.length * 10
					) / 10;

					setAnalysisResult( { avgWords, avgSentences, postCount: analyses.length } );
				}
			}
		} catch ( err ) {
			// Silently fail
		}

		setIsAnalyzing( false );
	};

	const applyAnalysis = () => {
		if ( analysisResult ) {
			onChange( 'words_per_sentence', analysisResult.avgWords );
			onChange( 'sentences_per_paragraph', analysisResult.avgSentences );
			setAnalysisResult( null );
		}
	};

	const isCustomReadingLevel = sectionData.reading_level === 'custom';

	return (
		<VStack spacing={ 4 }>
			<TextControl
				__nextHasNoMarginBottom
				type="number"
				label={ __( 'Target words per sentence', 'content-guidelines' ) }
				value={ sectionData.words_per_sentence || '' }
				onChange={ ( value ) => onChange( 'words_per_sentence', value ? parseInt( value, 10 ) : '' ) }
				min={ 1 }
				max={ 50 }
			/>
			<TextControl
				__nextHasNoMarginBottom
				type="number"
				label={ __( 'Target sentences per paragraph', 'content-guidelines' ) }
				value={ sectionData.sentences_per_paragraph || '' }
				onChange={ ( value ) => onChange( 'sentences_per_paragraph', value ? parseFloat( value ) : '' ) }
				min={ 1 }
				max={ 20 }
				step={ 0.5 }
			/>
			<TextControl
				__nextHasNoMarginBottom
				type="number"
				label={ __( 'Target paragraphs per section', 'content-guidelines' ) }
				value={ sectionData.paragraphs_per_section || '' }
				onChange={ ( value ) => onChange( 'paragraphs_per_section', value ? parseInt( value, 10 ) : '' ) }
				min={ 1 }
				max={ 20 }
			/>

			<div className="library-panel__divider">
				<span className="library-panel__divider-text">
					{ __( 'Reading level', 'content-guidelines' ) }
				</span>
			</div>

			<SelectControl
				__nextHasNoMarginBottom
				label={ __( 'Target reading level', 'content-guidelines' ) }
				value={ sectionData.reading_level || '' }
				options={ [
					{ value: '', label: __( 'Not specified', 'content-guidelines' ) },
					{ value: 'simple', label: __( 'Simple (grade 6-8)', 'content-guidelines' ) },
					{ value: 'standard', label: __( 'Standard (grade 9-12)', 'content-guidelines' ) },
					{ value: 'advanced', label: __( 'Advanced (college+)', 'content-guidelines' ) },
					{ value: 'custom', label: __( 'Custom', 'content-guidelines' ) },
				] }
				onChange={ ( value ) => onChange( 'reading_level', value ) }
			/>
			{ isCustomReadingLevel && (
				<TextControl
					__nextHasNoMarginBottom
					label={ __( 'Custom reading level', 'content-guidelines' ) }
					value={ sectionData.reading_level_custom || '' }
					onChange={ ( value ) => onChange( 'reading_level_custom', value ) }
					placeholder={ __( 'e.g., Technical professionals, Medical audience', 'content-guidelines' ) }
				/>
			) }
			<TextControl
				__nextHasNoMarginBottom
				type="number"
				label={ __( 'Maximum word length (syllables)', 'content-guidelines' ) }
				help={ __( 'Prefer words with fewer syllables for simpler reading.', 'content-guidelines' ) }
				value={ sectionData.max_syllables || '' }
				onChange={ ( value ) => onChange( 'max_syllables', value ? parseInt( value, 10 ) : '' ) }
				min={ 1 }
				max={ 10 }
			/>

			<div className="library-panel__divider">
				<span className="library-panel__divider-text">
					{ __( 'Analyze existing content', 'content-guidelines' ) }
				</span>
			</div>

			<HStack spacing={ 3 }>
				<Button
					variant="secondary"
					onClick={ runAnalysis }
					disabled={ isAnalyzing }
					isBusy={ isAnalyzing }
				>
					{ isAnalyzing ? __( 'Analyzing', 'content-guidelines' ) : __( 'Analyze posts', 'content-guidelines' ) }
				</Button>
				{ analysisResult && (
					<Button variant="primary" onClick={ applyAnalysis }>
						{ __( 'Apply', 'content-guidelines' ) }
					</Button>
				) }
			</HStack>

			{ analysisResult && (
				<Text variant="muted">
					{ __( 'Based on', 'content-guidelines' ) } { analysisResult.postCount } { __( 'posts:', 'content-guidelines' ) }{ ' ' }
					{ analysisResult.avgWords } { __( 'words/sentence,', 'content-guidelines' ) }{ ' ' }
					{ analysisResult.avgSentences } { __( 'sentences/paragraph', 'content-guidelines' ) }
				</Text>
			) }
		</VStack>
	);
}

/**
 * References content component.
 *
 * @param {Object}   props             Component props.
 * @param {Object}   props.sectionData Section data.
 * @param {Function} props.onChange    Change handler.
 * @return {JSX.Element} References content.
 */
function ReferencesContent( { sectionData, onChange } ) {
	const references = sectionData.references || [];

	const addReference = () => {
		onChange( 'references', [ ...references, { type: 'website', title: '', url: '', notes: '' } ] );
	};

	const updateReference = ( index, field, value ) => {
		const updated = [ ...references ];
		updated[ index ] = { ...updated[ index ], [ field ]: value };
		onChange( 'references', updated );
	};

	const removeReference = ( index ) => {
		onChange( 'references', references.filter( ( _, i ) => i !== index ) );
	};

	return (
		<VStack spacing={ 4 }>
			{ references.map( ( ref, index ) => (
				<div key={ index } className="library-panel__reference-item">
					<VStack spacing={ 2 }>
						<HStack spacing={ 2 }>
							<SelectControl
								__nextHasNoMarginBottom
								label={ __( 'Type', 'content-guidelines' ) }
								value={ ref.type || 'website' }
								options={ [
									{ value: 'website', label: __( 'Website', 'content-guidelines' ) },
									{ value: 'article', label: __( 'Article', 'content-guidelines' ) },
									{ value: 'book', label: __( 'Book', 'content-guidelines' ) },
									{ value: 'document', label: __( 'Document', 'content-guidelines' ) },
									{ value: 'competitor', label: __( 'Competitor', 'content-guidelines' ) },
									{ value: 'other', label: __( 'Other', 'content-guidelines' ) },
								] }
								onChange={ ( value ) => updateReference( index, 'type', value ) }
							/>
							<div style={ { flex: 1 } }>
								<TextControl
									__nextHasNoMarginBottom
									label={ __( 'Title', 'content-guidelines' ) }
									value={ ref.title || '' }
									onChange={ ( value ) => updateReference( index, 'title', value ) }
									placeholder={ __( 'Reference name', 'content-guidelines' ) }
								/>
							</div>
						</HStack>
						<TextControl
							__nextHasNoMarginBottom
							label={ __( 'URL / Location', 'content-guidelines' ) }
							value={ ref.url || '' }
							onChange={ ( value ) => updateReference( index, 'url', value ) }
							placeholder={ ref.type === 'book' ? __( 'ISBN or link', 'content-guidelines' ) : 'https://' }
						/>
						<TextareaControl
							__nextHasNoMarginBottom
							label={ __( 'Why you like it', 'content-guidelines' ) }
							value={ ref.notes || '' }
							onChange={ ( value ) => updateReference( index, 'notes', value ) }
							rows={ 2 }
							placeholder={ __( 'What aspects do you want to emulate?', 'content-guidelines' ) }
						/>
						<Button
							variant="tertiary"
							isDestructive
							size="small"
							onClick={ () => removeReference( index ) }
						>
							{ __( 'Remove', 'content-guidelines' ) }
						</Button>
					</VStack>
				</div>
			) ) }

			<Button variant="secondary" onClick={ addReference }>
				{ __( 'Add reference', 'content-guidelines' ) }
			</Button>

			<div className="library-panel__divider">
				<span className="library-panel__divider-text">
					{ __( 'General notes', 'content-guidelines' ) }
				</span>
			</div>

			<TextareaControl
				__nextHasNoMarginBottom
				label={ __( 'Reference notes', 'content-guidelines' ) }
				value={ sectionData.notes || '' }
				onChange={ ( value ) => onChange( 'notes', value ) }
				rows={ 3 }
				placeholder={ __( 'Any other notes about your content inspirations...', 'content-guidelines' ) }
			/>
		</VStack>
	);
}

/**
 * Images content component with media library support.
 *
 * @param {Object}   props             Component props.
 * @param {Object}   props.sectionData Section data.
 * @param {Function} props.onChange    Change handler.
 * @return {JSX.Element} Images content.
 */
function ImagesContent( { sectionData, onChange } ) {
	const referenceImages = sectionData.reference_images || [];

	const openMediaLibrary = () => {
		const frame = window.wp.media( {
			title: __( 'Select Reference Images', 'content-guidelines' ),
			multiple: true,
			library: { type: 'image' },
			button: { text: __( 'Add Images', 'content-guidelines' ) },
		} );

		frame.on( 'select', () => {
			const selection = frame.state().get( 'selection' );
			const newImages = selection.map( ( attachment ) => {
				const data = attachment.toJSON();
				return {
					id: data.id,
					url: data.sizes?.medium?.url || data.url,
					alt: data.alt || '',
					notes: '',
				};
			} );
			onChange( 'reference_images', [ ...referenceImages, ...newImages ] );
		} );

		frame.open();
	};

	const updateImageNotes = ( index, notes ) => {
		const updated = [ ...referenceImages ];
		updated[ index ] = { ...updated[ index ], notes };
		onChange( 'reference_images', updated );
	};

	const removeImage = ( index ) => {
		onChange( 'reference_images', referenceImages.filter( ( _, i ) => i !== index ) );
	};

	return (
		<VStack spacing={ 4 }>
			<TextareaControl
				__nextHasNoMarginBottom
				label={ __( 'Image style', 'content-guidelines' ) }
				help={ __( 'Describe the visual style for images.', 'content-guidelines' ) }
				value={ sectionData.style || '' }
				onChange={ ( value ) => onChange( 'style', value ) }
				rows={ 2 }
			/>
			<TextareaControl
				__nextHasNoMarginBottom
				label={ __( 'Alt text guidelines', 'content-guidelines' ) }
				help={ __( 'How should alt text be written?', 'content-guidelines' ) }
				value={ sectionData.alt_text_guidelines || '' }
				onChange={ ( value ) => onChange( 'alt_text_guidelines', value ) }
				rows={ 2 }
			/>

			<div className="library-panel__divider">
				<span className="library-panel__divider-text">
					{ __( 'Reference images', 'content-guidelines' ) }
				</span>
			</div>

			{ referenceImages.length > 0 && (
				<div className="library-panel__image-grid">
					{ referenceImages.map( ( img, index ) => (
						<div key={ img.id || index } className="library-panel__image-item">
							<img src={ img.url } alt={ img.alt || '' } />
							<TextControl
								__nextHasNoMarginBottom
								placeholder={ __( 'Why this image?', 'content-guidelines' ) }
								value={ img.notes || '' }
								onChange={ ( value ) => updateImageNotes( index, value ) }
							/>
							<Button
								variant="tertiary"
								isDestructive
								size="small"
								onClick={ () => removeImage( index ) }
							>
								{ __( 'Remove', 'content-guidelines' ) }
							</Button>
						</div>
					) ) }
				</div>
			) }

			<Button variant="secondary" onClick={ openMediaLibrary }>
				{ __( 'Add reference images', 'content-guidelines' ) }
			</Button>
		</VStack>
	);
}

/**
 * Section detail screen component.
 *
 * @param {Object}   props           Component props.
 * @param {Object}   props.section   Section definition.
 * @param {Function} props.onBack    Back handler.
 * @return {JSX.Element} Section detail screen.
 */
function SectionDetailScreen( { section, onBack } ) {
	const draft = useSelect( ( select ) => select( STORE_NAME ).getDraft() || {}, [] );
	const { updateDraftSection, updateDraft } = useDispatch( STORE_NAME );

	const sectionData = draft[ section.id ] || {};

	const handleChange = ( field, value ) => {
		updateDraftSection( section.id, { [ field ]: value } );
	};

	const handleTopLevelChange = ( field, value ) => {
		updateDraft( { [ field ]: value } );
	};

	const renderContent = () => {
		switch ( section.id ) {
			case 'brand_context':
				return (
					<VStack spacing={ 4 }>
						<TextareaControl
							__nextHasNoMarginBottom
							label={ __( 'What is this site about?', 'content-guidelines' ) }
							help={ __( 'A brief description of your site, business, or publication.', 'content-guidelines' ) }
							value={ sectionData.site_description || '' }
							onChange={ ( value ) => handleChange( 'site_description', value ) }
							rows={ 3 }
						/>
						<TextControl
							__nextHasNoMarginBottom
							label={ __( 'Target audience', 'content-guidelines' ) }
							help={ __( 'Who are you writing for?', 'content-guidelines' ) }
							value={ sectionData.audience || '' }
							onChange={ ( value ) => handleChange( 'audience', value ) }
						/>
						<SelectControl
							__nextHasNoMarginBottom
							label={ __( 'Primary goal', 'content-guidelines' ) }
							help={ __( 'What do you want visitors to do?', 'content-guidelines' ) }
							value={ sectionData.primary_goal || '' }
							options={ GOAL_OPTIONS }
							onChange={ ( value ) => handleChange( 'primary_goal', value ) }
						/>
						<FormTokenField
							label={ __( 'Topics / coverage areas', 'content-guidelines' ) }
							value={ sectionData.topics || [] }
							onChange={ ( value ) => handleChange( 'topics', value ) }
							__experimentalExpandOnFocus
							__experimentalShowHowTo={ false }
						/>
					</VStack>
				);

			case 'voice_tone':
				return (
					<VStack spacing={ 4 }>
						<TextareaControl
							__nextHasNoMarginBottom
							label={ __( 'Voice description', 'content-guidelines' ) }
							help={ __( 'How should your brand\'s personality come across?', 'content-guidelines' ) }
							value={ sectionData.description || '' }
							onChange={ ( value ) => handleChange( 'description', value ) }
							rows={ 3 }
						/>
						<FormTokenField
							label={ __( 'Voice attributes', 'content-guidelines' ) }
							value={ sectionData.attributes || [] }
							onChange={ ( value ) => handleChange( 'attributes', value ) }
							__experimentalExpandOnFocus
							__experimentalShowHowTo={ false }
						/>
						<TextareaControl
							__nextHasNoMarginBottom
							label={ __( 'Tone notes', 'content-guidelines' ) }
							help={ __( 'Any additional guidance on tone adjustments.', 'content-guidelines' ) }
							value={ sectionData.tone_notes || '' }
							onChange={ ( value ) => handleChange( 'tone_notes', value ) }
							rows={ 2 }
						/>
					</VStack>
				);

			case 'copy_rules':
				return (
					<VStack spacing={ 4 }>
						<RepeaterControl
							label={ __( 'Do', 'content-guidelines' ) }
							items={ sectionData.dos || [] }
							onChange={ ( value ) => handleChange( 'dos', value ) }
							placeholder={ __( 'Add a rule...', 'content-guidelines' ) }
						/>
						<RepeaterControl
							label={ __( "Don't", 'content-guidelines' ) }
							items={ sectionData.donts || [] }
							onChange={ ( value ) => handleChange( 'donts', value ) }
							placeholder={ __( 'Add a rule...', 'content-guidelines' ) }
						/>
					</VStack>
				);

			case 'vocabulary':
				return (
					<VStack spacing={ 4 }>
						<FormTokenField
							label={ __( 'Preferred terms', 'content-guidelines' ) }
							value={ sectionData.preferred || [] }
							onChange={ ( value ) => handleChange( 'preferred', value ) }
							__experimentalExpandOnFocus
							__experimentalShowHowTo={ false }
						/>
						<FormTokenField
							label={ __( 'Terms to avoid', 'content-guidelines' ) }
							value={ sectionData.avoid || [] }
							onChange={ ( value ) => handleChange( 'avoid', value ) }
							__experimentalExpandOnFocus
							__experimentalShowHowTo={ false }
						/>

						<div className="library-panel__divider">
							<span className="library-panel__divider-text">
								{ __( 'Acronyms', 'content-guidelines' ) }
							</span>
						</div>

						<RepeaterControl
							label={ __( 'Definitions', 'content-guidelines' ) }
							items={ sectionData.acronyms || [] }
							onChange={ ( value ) => handleChange( 'acronyms', value ) }
							placeholder={ __( 'API - Application Programming Interface', 'content-guidelines' ) }
						/>
						<SelectControl
							__nextHasNoMarginBottom
							label={ __( 'Usage style', 'content-guidelines' ) }
							value={ sectionData.acronym_usage || 'expand_first' }
							options={ [
								{ value: 'expand_first', label: __( 'Expand on first use', 'content-guidelines' ) },
								{ value: 'always_expand', label: __( 'Always include expansion', 'content-guidelines' ) },
								{ value: 'acronym_only', label: __( 'Acronym only', 'content-guidelines' ) },
							] }
							onChange={ ( value ) => handleChange( 'acronym_usage', value ) }
						/>

						<div className="library-panel__divider">
							<span className="library-panel__divider-text">
								{ __( 'Custom dictionary', 'content-guidelines' ) }
							</span>
						</div>

						<FormTokenField
							label={ __( 'Industry terms & brand names', 'content-guidelines' ) }
							value={ sectionData.custom_dictionary || [] }
							onChange={ ( value ) => handleChange( 'custom_dictionary', value ) }
							__experimentalExpandOnFocus
							__experimentalShowHowTo={ false }
						/>
						<RepeaterControl
							label={ __( 'Corrections', 'content-guidelines' ) }
							items={ sectionData.voice_corrections || [] }
							onChange={ ( value ) => handleChange( 'voice_corrections', value ) }
							placeholder={ __( '"word press"  WordPress', 'content-guidelines' ) }
						/>
					</VStack>
				);

			case 'heuristics':
				return <HeuristicsContent sectionData={ sectionData } onChange={ handleChange } />;

			case 'references':
				return <ReferencesContent sectionData={ sectionData } onChange={ handleChange } />;

			case 'images':
				return <ImagesContent sectionData={ sectionData } onChange={ handleChange } />;

			case 'notes':
				return (
					<VStack spacing={ 4 }>
						<TextareaControl
							__nextHasNoMarginBottom
							label={ __( 'Additional notes', 'content-guidelines' ) }
							help={ __( 'Any other guidelines or context that doesn\'t fit elsewhere.', 'content-guidelines' ) }
							value={ draft.notes || '' }
							onChange={ ( value ) => handleTopLevelChange( 'notes', value ) }
							rows={ 5 }
						/>
					</VStack>
				);

			default:
				return null;
		}
	};

	return (
		<div className="library-panel__detail-container">
			<Flex justify="flex-start">
				<Navigator.BackButton
					icon={ isRTL() ? chevronRight : chevronLeft }
					size="small"
					onClick={ onBack }
					label={ __( 'Back', 'content-guidelines' ) }
				/>
				<Heading
					level={ 2 }
					size={ 13 }
					className="library-panel__detail-title"
				>
					{ section.title }
				</Heading>
			</Flex>

			<Spacer margin={ 4 } />

			{ renderContent() }
		</div>
	);
}

/**
 * Check if a value has meaningful content.
 *
 * @param {*} value Value to check.
 * @return {boolean} Whether value has content.
 */
function hasContent( value ) {
	if ( value === null || value === undefined ) {
		return false;
	}
	if ( Array.isArray( value ) ) {
		return value.length > 0;
	}
	if ( typeof value === 'string' ) {
		return value.trim().length > 0;
	}
	if ( typeof value === 'number' ) {
		return true;
	}
	if ( typeof value === 'object' ) {
		// For nested objects, check if any property has content.
		return Object.values( value ).some( hasContent );
	}
	return Boolean( value );
}

/**
 * Get status text for a section.
 *
 * @param {string} sectionId Section ID.
 * @param {Object} draft     Draft data.
 * @return {string|null} Status text.
 */
function getSectionStatus( sectionId, draft ) {
	const sectionData = draft[ sectionId ];
	if ( ! sectionData || typeof sectionData !== 'object' ) {
		return null;
	}

	// Check if section has any meaningful data.
	const hasData = Object.values( sectionData ).some( hasContent );

	return hasData ? __( 'Configured', 'content-guidelines' ) : null;
}

/**
 * Library panel with Navigator drill-down.
 *
 * @param {Object}   props                 Component props.
 * @param {string}   props.initialSection  Initial section ID from URL.
 * @param {Function} props.onSectionChange Callback when section changes.
 * @return {JSX.Element} Library panel.
 */
export default function LibraryPanel( { initialSection, onSectionChange } ) {
	// Find the initial section object from the ID.
	const initialSectionObj = initialSection
		? SECTIONS.find( ( s ) => s.id === initialSection ) || null
		: null;

	const [ selectedSection, setSelectedSection ] = useState( initialSectionObj );

	const { draft } = useSelect( ( select ) => {
		return {
			draft: select( STORE_NAME ).getDraft() || {},
		};
	}, [] );

	const handleSectionClick = ( section ) => {
		setSelectedSection( section );
		if ( onSectionChange ) {
			onSectionChange( section.id );
		}
	};

	const handleBack = () => {
		setSelectedSection( null );
		if ( onSectionChange ) {
			onSectionChange( null );
		}
	};

	return (
		<div className="library-panel">
			<Navigator initialPath={ selectedSection ? `/${ selectedSection.id }` : '/' }>
				<Navigator.Screen path="/">
					<VStack spacing={ 0 }>
						<ul role="list" className="library-panel__list">
							{ SECTIONS.map( ( section ) => (
								<li key={ section.id } className="library-panel__list-item">
									<SectionCard
										section={ section }
										statusText={ getSectionStatus( section.id, draft ) }
										onClick={ () => handleSectionClick( section ) }
									/>
								</li>
							) ) }
						</ul>
					</VStack>
				</Navigator.Screen>

				{ SECTIONS.map( ( section ) => (
					<Navigator.Screen key={ section.id } path={ `/${ section.id }` }>
						<SectionDetailScreen
							section={ section }
							onBack={ handleBack }
						/>
					</Navigator.Screen>
				) ) }
			</Navigator>
		</div>
	);
}
</file>

<file path="src/store/index.js">
/**
 * WordPress dependencies
 */
import { createReduxStore, register, select } from '@wordpress/data';

/**
 * Internal dependencies
 */
import reducer from './reducer';
import * as actions from './actions';
import * as selectors from './selectors';
import * as resolvers from './resolvers';

/**
 * Store name.
 */
export const STORE_NAME = 'content-guidelines';

/**
 * Store configuration.
 */
const storeConfig = {
	reducer,
	actions,
	selectors,
	resolvers,
};

/**
 * Create and register the store.
 * Guard against double registration when imported from multiple entry points.
 */
const store = createReduxStore( STORE_NAME, storeConfig );

// Only register if not already registered.
try {
	// Check if store exists by attempting to select from it.
	const existingStore = select( STORE_NAME );
	if ( ! existingStore ) {
		register( store );
	}
} catch ( e ) {
	// Store doesn't exist, register it.
	register( store );
}

export default store;
</file>

<file path="blueprint.json">
{
    "$schema": "https://playground.wordpress.net/blueprint-schema.json",
    "landingPage": "/wp-admin/themes.php?page=content-guidelines-wp-admin",
    "login": true,
    "steps": [
        {
            "step": "installPlugin",
            "pluginData": {
                "resource": "git:directory",
                "url": "https://github.com/Jameswlepage/content-guidelines",
                "ref": "HEAD",
                "refType": "refname"
            }
        },
        {
            "step": "installPlugin",
            "pluginZipFile": {
                "resource": "wordpress.org/plugins",
                "slug": "gutenberg"
            }
        }
    ]
}
</file>

<file path="README.md">
# Content Guidelines

Site-level editorial guidelines for WordPress. Define voice, tone, copy rules, and vocabulary that AI features can consume.

**Global Styles = how your site looks. Content Guidelines = how your site sounds.**

## Installation

1. Download the plugin
2. Upload to `/wp-content/plugins/content-guidelines`
3. Activate via Plugins menu
4. Access via **Appearance > Guidelines**

## Quick Start

### Agent Working with a Post (Recommended)

```php
// Get guidelines with automatic block analysis
// This merges site-level AND block-specific rules for all blocks in the post
$result = wp_get_content_guidelines_for_post( $post_id );

// Use in your AI prompt
$prompt = $result['packet_text'] . "\n\nImprove this content:\n" . $post->post_content;

// Also available: list of blocks found and their specific guidelines
$result['blocks_in_post'];    // ['core/paragraph', 'core/heading', 'core/button']
$result['block_guidelines'];  // Per-block rules for blocks with custom guidelines
```

### Get Guidelines for Specific Blocks

```php
// When you know which blocks you're working with
$result = wp_get_block_guidelines( array( 'core/button', 'core/heading' ) );

// Returns site_rules + block-specific rules in a ready-to-use packet
$prompt = $result['packet_text'];
```

### Get Guidelines via REST API

```bash
# Get guidelines for a specific post (with block analysis)
curl -X GET \
  'https://yoursite.com/wp-json/wp/v2/content-guidelines/for-post/123' \
  -H 'Authorization: Basic YOUR_APP_PASSWORD'

# Get guidelines for specific blocks
curl -X GET \
  'https://yoursite.com/wp-json/wp/v2/content-guidelines/blocks?blocks=core/button,core/heading' \
  -H 'Authorization: Basic YOUR_APP_PASSWORD'
```

### Basic Packet (Without Block Context)

```php
$packet = wp_get_content_guidelines_packet( array(
    'task' => 'writing',  // or 'headline', 'cta', 'image', 'coach'
) );
```

## Documentation

| Document | Description |
|----------|-------------|
| [PHP API](./docs/php-api.md) | PHP functions and usage examples |
| [REST API](./docs/rest-api.md) | REST endpoints and authentication |
| [Abilities API](./docs/abilities-api.md) | WordPress 6.9+ Abilities integration |
| [Integration Guide](./docs/integration-guide.md) | How to build AI provider plugins |

## Features

- **Site-level guidelines** - One source of truth for editorial voice
- **Draft/Publish workflow** - Iterate safely without affecting production
- **Version history** - Full revision history with restore capability
- **Playground** - Test changes against real content before publishing
- **Block-specific rules** - Set guidelines per block type
- **AI-agnostic** - Works with any AI provider

## For AI Providers

Content Guidelines provides storage and UI. Your plugin provides AI:

```php
// Register as an AI provider
add_filter( 'wp_content_guidelines_has_ai_provider', '__return_true' );

// Handle playground tests
add_filter( 'wp_content_guidelines_run_playground_test', function( $result, $request ) {
    // $request['context_packet']['packet_text'] contains formatted guidelines
    // $request['fixture_content'] contains the test content
    // Return: array( 'output' => 'AI generated text...' )
    return my_ai_generate( $request );
}, 10, 2 );
```

See [Integration Guide](./docs/integration-guide.md) for complete examples.

## Data Schema

The schema follows the `theme.json` pattern used in WordPress core:

```json
{
  "version": 1,
  "brand_context": {
    "site_description": "About this site",
    "audience": "Target readers",
    "primary_goal": "inform"
  },
  "voice_tone": {
    "tone_traits": ["friendly", "professional"],
    "pov": "we_you",
    "readability": "general"
  },
  "copy_rules": {
    "dos": ["Use active voice"],
    "donts": ["Avoid jargon"],
    "formatting": ["h2s", "bullets"]
  },
  "vocabulary": {
    "prefer": [{"term": "sustainable", "note": "Our core value"}],
    "avoid": [{"term": "green", "note": "Too vague"}]
  },
  "image_style": {
    "dos": ["Natural lighting"],
    "donts": ["Stock photos"],
    "text_policy": "never"
  },
  "notes": "Additional context...",
  "blocks": {
    "core/paragraph": {
      "copy_rules": {
        "dos": ["Limit paragraphs to 3-4 sentences"],
        "donts": ["Don't start with 'In this article'"]
      },
      "notes": "Keep paragraphs scannable"
    },
    "core/button": {
      "copy_rules": {
        "dos": ["Use action verbs", "Keep under 5 words"],
        "donts": ["Don't use 'Click here'", "Avoid 'Submit'"]
      }
    }
  }
}
```

## Requirements

- WordPress 6.7+
- PHP 7.4+
- Gutenberg plugin (for full UI)

For WordPress 6.9+, the plugin also registers with the Abilities API for AI assistant integration.

## Related Docs

- [Full Specification](./SPEC.md) - Complete product and technical spec
- [Summary](./SUMMARY.md) - One-page overview for stakeholders
- [Implementation Notes](./IMPLEMENTATION.md) - Development details

## License

GPL-2.0-or-later
</file>

<file path="src/components/guidelines-page/index.js">
/**
 * WordPress dependencies
 */
import { Page } from '@wordpress/admin-ui';
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import { useEffect, useState } from '@wordpress/element';
import {
	Spinner,
	Notice,
	Button,
} from '@wordpress/components';
import { backup } from '@wordpress/icons';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';
import LibraryPanel from '../library-panel';
import BlocksPanel from '../blocks-panel';
import PlaygroundPanel from '../playground';
import HistoryPanel from '../history';
import ImportExportPanel from '../import-export';
import EmptyState from '../guidelines-screen/empty-state';
import './style.scss';

/**
 * Header actions component with status notice.
 *
 * @param {Object}   props               Component props.
 * @param {boolean}  props.hasDraft      Whether there are draft changes.
 * @param {boolean}  props.isSaving      Whether currently saving.
 * @param {boolean}  props.isPublishing  Whether currently publishing.
 * @param {string}   props.error         Error message if any.
 * @param {Function} props.onClearError  Callback to clear error.
 * @param {Function} props.onShowHistory Callback to show history.
 * @return {JSX.Element} Header actions.
 */
function HeaderActions( { hasDraft, isSaving, isPublishing, error, onClearError, onShowHistory } ) {
	const { saveDraft, publishGuidelines, discardDraft } =
		useDispatch( STORE_NAME );

	return (
		<div className="guidelines-page__header-actions">
			<div className="guidelines-page__header-status">
				{ error && (
					<Notice
						status="error"
						isDismissible
						onDismiss={ onClearError }
						className="guidelines-page__header-notice"
					>
						{ error }
					</Notice>
				) }
				{ hasDraft && ! error && (
					<span className="guidelines-page__draft-indicator">
						{ __( 'Draft changes not published', 'content-guidelines' ) }
					</span>
				) }
			</div>
			<div className="guidelines-page__header-buttons">
				<Button
					icon={ backup }
					label={ __( 'History', 'content-guidelines' ) }
					onClick={ onShowHistory }
				/>
				{ hasDraft && (
					<>
						<Button
							variant="tertiary"
							onClick={ discardDraft }
							disabled={ isSaving || isPublishing }
						>
							{ __( 'Discard', 'content-guidelines' ) }
						</Button>
						<Button
							variant="secondary"
							onClick={ saveDraft }
							isBusy={ isSaving }
							disabled={ isSaving || isPublishing }
						>
							{ __( 'Save draft', 'content-guidelines' ) }
						</Button>
					</>
				) }
				<Button
					variant="primary"
					onClick={ publishGuidelines }
					isBusy={ isPublishing }
					disabled={ isSaving || isPublishing || ! hasDraft }
				>
					{ __( 'Publish', 'content-guidelines' ) }
				</Button>
			</div>
		</div>
	);
}

/**
 * Get URL params for navigation state.
 *
 * @return {Object} URL params.
 */
function getUrlParams() {
	const params = new URLSearchParams( window.location.search );
	return {
		tab: params.get( 'tab' ) || 'library',
		section: params.get( 'section' ) || null,
		block: params.get( 'block' ) || null,
	};
}

/**
 * Update URL with navigation state.
 *
 * @param {Object} updates Params to update.
 */
function updateUrl( updates ) {
	const url = new URL( window.location.href );

	Object.entries( updates ).forEach( ( [ key, value ] ) => {
		if ( value ) {
			url.searchParams.set( key, value );
		} else {
			url.searchParams.delete( key );
		}
	} );

	window.history.replaceState( {}, '', url );
}

/**
 * Main guidelines page component using @wordpress/admin-ui Page wrapper.
 *
 * @return {JSX.Element} The guidelines page.
 */
export default function GuidelinesPage() {
	const [ showHistory, setShowHistory ] = useState( false );

	// Initialize from URL params.
	const initialParams = getUrlParams();
	const [ activeTab, setActiveTab ] = useState( initialParams.tab );
	const [ urlSection, setUrlSection ] = useState( initialParams.section );
	const [ urlBlock, setUrlBlock ] = useState( initialParams.block );

	const {
		active,
		draft,
		hasDraftChanges,
		hasGuidelines,
		isSaving,
		isPublishing,
		error,
	} = useSelect( ( select ) => {
		const store = select( STORE_NAME );
		return {
			active: store.getActive(),
			draft: store.getDraft(),
			hasDraftChanges: store.draftHasChanges(),
			hasGuidelines: store.hasGuidelines(),
			isSaving: store.isSaving(),
			isPublishing: store.isPublishing(),
			error: store.getError(),
		};
	}, [] );

	const { initializeEditor, setError: clearError, saveDraft } = useDispatch( STORE_NAME );

	// Handle tab changes with URL sync.
	const handleTabChange = ( tab ) => {
		setActiveTab( tab );
		// Clear section/block when changing tabs.
		setUrlSection( null );
		setUrlBlock( null );
		updateUrl( { tab, section: null, block: null } );
	};

	// Handle section changes from LibraryPanel.
	const handleSectionChange = ( section ) => {
		setUrlSection( section );
		updateUrl( { section } );
	};

	// Handle block changes from BlocksPanel.
	const handleBlockChange = ( block ) => {
		setUrlBlock( block );
		updateUrl( { block } );
	};

	// Keyboard shortcut: Ctrl+S / Cmd+S to save draft.
	useEffect( () => {
		const handleKeyDown = ( event ) => {
			if ( ( event.ctrlKey || event.metaKey ) && event.key === 's' ) {
				event.preventDefault();
				if ( hasDraftChanges && ! isSaving && ! isPublishing ) {
					saveDraft();
				}
			}
		};

		document.addEventListener( 'keydown', handleKeyDown );
		return () => {
			document.removeEventListener( 'keydown', handleKeyDown );
		};
	}, [ hasDraftChanges, isSaving, isPublishing, saveDraft ] );

	// Initialize editor when guidelines load.
	useEffect( () => {
		if ( active && ! draft ) {
			initializeEditor();
		}
	}, [ active, draft, initializeEditor ] );

	// Loading state.
	const isLoading = active === undefined;

	if ( isLoading ) {
		return (
			<Page title={ __( 'Guidelines', 'content-guidelines' ) }>
				<div className="guidelines-page__loading">
					<Spinner />
					<p>{ __( 'Loading guidelines...', 'content-guidelines' ) }</p>
				</div>
			</Page>
		);
	}

	// Empty state - no guidelines yet.
	if ( ! hasGuidelines ) {
		return (
			<Page title={ __( 'Guidelines', 'content-guidelines' ) }>
				<EmptyState />
			</Page>
		);
	}

	const leftTabs = [
		{ name: 'library', title: __( 'Library', 'content-guidelines' ) },
		{ name: 'blocks', title: __( 'Blocks', 'content-guidelines' ) },
		{ name: 'playground', title: __( 'Playground', 'content-guidelines' ) },
	];

	const rightTabs = [
		{ name: 'import-export', title: __( 'Import / Export', 'content-guidelines' ) },
	];

	return (
		<Page
			title={ __( 'Guidelines', 'content-guidelines' ) }
			actions={
				<HeaderActions
					hasDraft={ hasDraftChanges }
					isSaving={ isSaving }
					isPublishing={ isPublishing }
					error={ error }
					onClearError={ () => clearError( null ) }
					onShowHistory={ () => setShowHistory( true ) }
				/>
			}
		>
			<div className="guidelines-page__tabs">
				<div className="guidelines-page__tab-list" role="tablist">
					<div className="guidelines-page__tab-list-left">
						{ leftTabs.map( ( tab ) => (
							<button
								key={ tab.name }
								role="tab"
								aria-selected={ activeTab === tab.name }
								className={ `guidelines-page__tab ${ activeTab === tab.name ? 'is-active' : '' }` }
								onClick={ () => handleTabChange( tab.name ) }
							>
								{ tab.title }
							</button>
						) ) }
					</div>
					<div className="guidelines-page__tab-list-right">
						{ rightTabs.map( ( tab ) => (
							<button
								key={ tab.name }
								role="tab"
								aria-selected={ activeTab === tab.name }
								className={ `guidelines-page__tab ${ activeTab === tab.name ? 'is-active' : '' }` }
								onClick={ () => handleTabChange( tab.name ) }
							>
								{ tab.title }
							</button>
						) ) }
					</div>
				</div>

				<div className="guidelines-page__tab-panel" role="tabpanel">
					{ activeTab === 'library' && (
						<LibraryPanel
							initialSection={ urlSection }
							onSectionChange={ handleSectionChange }
						/>
					) }
					{ activeTab === 'blocks' && (
						<BlocksPanel
							initialBlock={ urlBlock }
							onBlockChange={ handleBlockChange }
						/>
					) }
					{ activeTab === 'playground' && <PlaygroundPanel /> }
					{ activeTab === 'import-export' && <ImportExportPanel /> }
				</div>
			</div>

			{ showHistory && (
				<HistoryPanel onClose={ () => setShowHistory( false ) } />
			) }
		</Page>
	);
}
</file>

<file path="src/components/guidelines-page/style.scss">
// Guidelines page styles - matching fonts library pattern exactly

// Header actions container - fills available space
.guidelines-page__header-actions {
	display: flex;
	align-items: center;
	gap: 16px;
	flex-grow: 1;
	min-width: 0; // Allow shrinking
}

// Status area in header - fills middle space
.guidelines-page__header-status {
	flex-grow: 1;
	display: flex;
	align-items: center;
	justify-content: flex-end;
	min-width: 0;
	overflow: hidden;
}

// Draft indicator text
.guidelines-page__draft-indicator {
	font-size: 13px;
	color: #d63638;
	white-space: nowrap;
}

// Notice in header - compact style
.guidelines-page__header-notice {
	margin: 0;
	padding: 8px 12px;
	font-size: 13px;

	.components-notice__content {
		margin: 0;
	}

	.components-notice__dismiss {
		align-self: center;
	}
}

// Action buttons group
.guidelines-page__header-buttons {
	display: flex;
	align-items: center;
	gap: 8px;
	flex-shrink: 0;
}

// Loading state
.guidelines-page__loading {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	padding: 48px;
	gap: 16px;
	color: #757575;
}

// Override admin-ui-page header to match fonts
.admin-ui-page .admin-ui-page__header {
	padding: 16px 24px;
}

// Main tabs container
.guidelines-page__tabs {
	display: flex;
	flex-direction: column;
	flex-grow: 1;
	overflow: hidden;
}

// Custom tab list with split layout
.guidelines-page__tab-list {
	display: flex;
	justify-content: space-between;
	align-items: center;
	border-bottom: 1px solid #e0e0e0;
	padding: 0 24px;
	margin: 0;
	flex-shrink: 0;
	background: transparent;
}

.guidelines-page__tab-list-left,
.guidelines-page__tab-list-right {
	display: flex;
	gap: 0;
}

// Individual tab button
.guidelines-page__tab {
	padding: 12px 16px;
	font-size: 13px;
	font-weight: 500;
	color: #1e1e1e;
	background: transparent;
	border: none;
	border-radius: 0;
	border-bottom: 3px solid transparent;
	margin-bottom: -1px;
	cursor: pointer;
	height: auto;
	line-height: 1.4;

	&:hover {
		color: var(--wp-admin-theme-color, #3858e9);
		background: transparent;
	}

	&.is-active {
		border-bottom-color: var(--wp-admin-theme-color, #3858e9);
		color: var(--wp-admin-theme-color, #3858e9);
	}

	&:focus:not(:disabled) {
		box-shadow: none;
		outline: none;
	}

	&:focus-visible:not(:disabled) {
		box-shadow: inset 0 0 0 1.5px var(--wp-admin-theme-color, #3858e9);
		outline: none;
	}
}

// Tab panel content area
.guidelines-page__tab-panel {
	flex-grow: 1;
	overflow: auto;
	display: flex;
	flex-direction: column;
	border: none;
	padding: 0;
}

// Guidelines panels - full width like fonts library
.guidelines-page__panels {
	display: flex;
	flex-direction: column;

	// Draft notice at top
	> .components-notice {
		margin: 16px 24px;
		border-radius: 2px;
	}

	// Panel styling - full width sections
	.components-panel {
		border: none;
		border-radius: 0;
		background: transparent;
		margin: 0;

		.components-panel__body {
			border: none;
			border-top: 1px solid #e0e0e0;
			margin: 0;

			&:last-child {
				border-bottom: none;
			}
		}

		// First panel - no top border (tabs already have bottom border)
		&:first-child .components-panel__body {
			border-top: none;
		}

		.components-panel__body-title {
			margin: 0;

			button {
				padding: 16px 24px;
				font-size: 14px;
				font-weight: 500;
				border-radius: 0;
				width: 100%;
				justify-content: space-between;

				&:hover {
					background: #f8f8f8;
				}

				.components-panel__arrow {
					margin-left: auto;
				}
			}
		}

		.components-panel__body.is-opened > .components-panel__body-title {
			border-bottom: none;
		}

		// Panel content
		.components-panel__body > .components-panel__body-title + div {
			padding: 0 24px 24px;
		}
	}
}

// Section headings inside panels
.guidelines-page__section-title {
	font-size: 11px;
	font-weight: 500;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	color: #757575;
	margin: 24px 24px 8px;
	padding: 0;
}

// Empty state
.content-guidelines-empty-state {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	padding: 80px 24px;
	text-align: center;
	max-width: 400px;
	margin: 0 auto;

	&__icon {
		font-size: 48px;
		margin-bottom: 24px;
	}

	&__title {
		font-size: 20px;
		font-weight: 500;
		margin: 0 0 12px;
		color: #1e1e1e;
	}

	&__description {
		font-size: 13px;
		color: #757575;
		margin: 0 0 24px;
		line-height: 1.6;
	}

	&__actions {
		display: flex;
		gap: 12px;
	}

	&__note {
		font-size: 12px;
		color: #949494;
		margin-top: 24px;
	}
}

// Playground panel
.content-guidelines-playground {
	padding: 24px;

	&__controls {
		display: flex;
		flex-direction: column;
		gap: 16px;
		max-width: 480px;
	}

	&__note {
		font-size: 12px;
		color: #757575;
		margin: 0;
	}

	&__loading {
		display: flex;
		align-items: center;
		gap: 12px;
		padding: 24px;
		color: #757575;
	}

	&__results {
		margin-top: 24px;
	}
}
</file>

<file path="src/components/blocks-panel/index.js">
/**
 * WordPress dependencies
 */
import { __ } from '@wordpress/i18n';
import { useSelect, useDispatch } from '@wordpress/data';
import { useState, useMemo, useEffect } from '@wordpress/element';
import {
	Button,
	SearchControl,
	Navigator,
	useNavigator,
	__experimentalVStack as VStack,
	__experimentalHStack as HStack,
	__experimentalText as Text,
	__experimentalHeading as Heading,
	__experimentalSpacer as Spacer,
	Flex,
	FlexItem,
	TextareaControl,
	Spinner,
} from '@wordpress/components';
import { store as blocksStore } from '@wordpress/blocks';
import { store as coreStore } from '@wordpress/core-data';
import { chevronRight, chevronLeft } from '@wordpress/icons';
import { isRTL } from '@wordpress/i18n';
import apiFetch from '@wordpress/api-fetch';

/**
 * Internal dependencies
 */
import { STORE_NAME } from '../../store';
import RepeaterControl from '../controls/repeater-control';
import './style.scss';

/**
 * Common block types that benefit from guidelines.
 */
const PRIORITY_BLOCKS = [
	'core/paragraph',
	'core/heading',
	'core/button',
	'core/image',
	'core/list',
	'core/quote',
];

/**
 * Number of blocks to show per page.
 */
const BLOCKS_PER_PAGE = 20;

/**
 * Block card component.
 *
 * @param {Object}   props              Component props.
 * @param {Object}   props.block        Block type object.
 * @param {string}   props.variantsText Status text.
 * @param {Function} props.onClick      Click handler.
 * @param {string}   props.navigatorPath Navigator path.
 * @return {JSX.Element} Block card.
 */
function BlockCard( { block, variantsText, onClick, navigatorPath } ) {
	const navigator = useNavigator();
	const { title, icon } = block;

	const handleClick = () => {
		if ( onClick ) {
			onClick();
		}
		if ( navigatorPath ) {
			navigator.goTo( navigatorPath );
		}
	};

	return (
		<Button
			__next40pxDefaultSize
			className="blocks-panel__block-card"
			onClick={ handleClick }
		>
			<Flex justify="space-between">
				<FlexItem>
					<Text className="blocks-panel__block-title">
						{ title }
					</Text>
				</FlexItem>
				<Flex justify="flex-end" gap={ 2 }>
					{ variantsText && (
						<FlexItem>
							<Text className="blocks-panel__block-status" variant="muted">
								{ variantsText }
							</Text>
						</FlexItem>
					) }
					<FlexItem>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							viewBox="0 0 24 24"
							width="24"
							height="24"
							aria-hidden="true"
							focusable="false"
						>
							<path d="M10.6 6L9.4 7l4.6 5-4.6 5 1.2 1 5.4-6z" />
						</svg>
					</FlexItem>
				</Flex>
			</Flex>
		</Button>
	);
}

/**
 * Block detail screen component.
 *
 * @param {Object} props           Component props.
 * @param {Object} props.block     Selected block.
 * @param {Function} props.onBack  Back handler.
 * @return {JSX.Element} Block detail screen.
 */
function BlockDetailScreen( { block, onBack } ) {
	const { blockGuidelines } = useSelect( ( select ) => {
		const draft = select( STORE_NAME ).getDraft();
		return {
			blockGuidelines: draft?.blocks?.[ block?.name ] || {},
		};
	}, [ block?.name ] );

	const { updateBlockGuidelines } = useDispatch( STORE_NAME );

	const updateNestedField = ( parent, field, value ) => {
		updateBlockGuidelines( block.name, {
			...blockGuidelines,
			[ parent ]: {
				...( blockGuidelines[ parent ] || {} ),
				[ field ]: value,
			},
		} );
	};

	const updateField = ( field, value ) => {
		updateBlockGuidelines( block.name, {
			...blockGuidelines,
			[ field ]: value,
		} );
	};

	if ( ! block ) {
		return null;
	}

	// Render block icon from REST API data
	const renderBlockIcon = () => {
		if ( ! block.icon ) {
			return null;
		}

		// Icon can be a string (dashicon), an object with src (SVG), or an SVG string
		if ( typeof block.icon === 'string' ) {
			if ( block.icon.startsWith( '<svg' ) ) {
				return (
					<span
						className="blocks-panel__block-icon"
						dangerouslySetInnerHTML={ { __html: block.icon } }
					/>
				);
			}
			// Dashicon
			return <span className={ `dashicons dashicons-${ block.icon } blocks-panel__block-icon` } />;
		}

		if ( block.icon?.src ) {
			if ( typeof block.icon.src === 'string' && block.icon.src.startsWith( '<svg' ) ) {
				return (
					<span
						className="blocks-panel__block-icon"
						dangerouslySetInnerHTML={ { __html: block.icon.src } }
					/>
				);
			}
		}

		return null;
	};

	return (
		<div className="blocks-panel__detail-container">
			<Flex justify="flex-start">
				<Navigator.BackButton
					icon={ isRTL() ? chevronRight : chevronLeft }
					size="small"
					onClick={ onBack }
					label={ __( 'Back', 'content-guidelines' ) }
				/>
				<Heading
					level={ 2 }
					size={ 13 }
					className="blocks-panel__detail-title"
				>
					{ block.title }
				</Heading>
			</Flex>

			<Spacer margin={ 4 } />

			<div className="blocks-panel__block-preview">
				{ renderBlockIcon() }
				<div className="blocks-panel__block-info">
					<Text className="blocks-panel__block-name">{ block.name }</Text>
					{ block.description && (
						<Text variant="muted" className="blocks-panel__block-description">
							{ block.description }
						</Text>
					) }
				</div>
			</div>

			<Spacer margin={ 4 } />

			<VStack spacing={ 4 }>
				<div className="blocks-panel__divider">
					<span className="blocks-panel__divider-text">
						{ __( 'Copy Rules', 'content-guidelines' ) }
					</span>
				</div>

				<RepeaterControl
					label={ __( 'Do', 'content-guidelines' ) }
					items={ blockGuidelines.copy_rules?.dos || [] }
					onChange={ ( value ) => updateNestedField( 'copy_rules', 'dos', value ) }
					placeholder={ __( 'Add a rule', 'content-guidelines' ) }
				/>
				<RepeaterControl
					label={ __( "Don't", 'content-guidelines' ) }
					items={ blockGuidelines.copy_rules?.donts || [] }
					onChange={ ( value ) => updateNestedField( 'copy_rules', 'donts', value ) }
					placeholder={ __( 'Add a rule', 'content-guidelines' ) }
				/>

				<div className="blocks-panel__divider">
					<span className="blocks-panel__divider-text">
						{ __( 'Notes', 'content-guidelines' ) }
					</span>
				</div>

				<TextareaControl
					__nextHasNoMarginBottom
					value={ blockGuidelines.notes || '' }
					onChange={ ( value ) => updateField( 'notes', value ) }
					placeholder={ __( 'Any other guidelines for this block', 'content-guidelines' ) }
					rows={ 3 }
				/>
			</VStack>
		</div>
	);
}

/**
 * Blocks panel component with Navigator drill-down.
 *
 * @param {Object}   props               Component props.
 * @param {string}   props.initialBlock  Initial block name from URL.
 * @param {Function} props.onBlockChange Callback when block changes.
 * @return {JSX.Element} Blocks panel.
 */
export default function BlocksPanel( { initialBlock, onBlockChange } ) {
	const [ searchTerm, setSearchTerm ] = useState( '' );
	const [ selectedBlock, setSelectedBlock ] = useState( null );
	const [ pendingBlockName, setPendingBlockName ] = useState( initialBlock );
	const [ blockTypes, setBlockTypes ] = useState( [] );
	const [ isLoading, setIsLoading ] = useState( true );
	const [ error, setError ] = useState( null );
	const [ currentPage, setCurrentPage ] = useState( 1 );

	// Fetch block types from REST API on mount.
	// This works on any admin page, unlike the blocks store which
	// only has blocks when the block editor is loaded.
	useEffect( () => {
		let isMounted = true;

		async function fetchBlockTypes() {
			try {
				setIsLoading( true );
				setError( null );

				// Fetch all block types from the REST API.
				const response = await apiFetch( {
					path: '/wp/v2/block-types?per_page=100',
				} );

				if ( isMounted ) {
					// Transform REST API response to match blocks store format.
					const blocks = response.map( ( block ) => ( {
						name: block.name,
						title: block.title || block.name,
						description: block.description || '',
						category: block.category || 'common',
						icon: block.icon || null,
						keywords: block.keywords || [],
					} ) );

					setBlockTypes( blocks );
					setIsLoading( false );
				}
			} catch ( err ) {
				if ( isMounted ) {
					setError( err.message || __( 'Failed to load blocks.', 'content-guidelines' ) );
					setIsLoading( false );
				}
			}
		}

		fetchBlockTypes();

		return () => {
			isMounted = false;
		};
	}, [] );

	// Set selected block from URL after blocks are loaded.
	useEffect( () => {
		if ( pendingBlockName && blockTypes.length > 0 && ! selectedBlock ) {
			const found = blockTypes.find( ( b ) => b.name === pendingBlockName );
			if ( found ) {
				setSelectedBlock( found );
			}
			setPendingBlockName( null );
		}
	}, [ pendingBlockName, blockTypes, selectedBlock ] );

	// Handle block selection with URL callback.
	const handleBlockSelect = ( block ) => {
		setSelectedBlock( block );
		if ( onBlockChange ) {
			onBlockChange( block.name );
		}
	};

	// Handle back navigation with URL callback.
	const handleBack = () => {
		setSelectedBlock( null );
		if ( onBlockChange ) {
			onBlockChange( null );
		}
	};

	const { blockGuidelines } = useSelect( ( select ) => {
		const draft = select( STORE_NAME ).getDraft();
		return {
			blockGuidelines: draft?.blocks || {},
		};
	}, [] );

	// Filter and sort blocks
	const filteredBlocks = useMemo( () => {
		let blocks = blockTypes.filter( ( block ) => {
			if ( block.name.startsWith( 'core/legacy-' ) ) {
				return false;
			}
			if ( searchTerm ) {
				const search = searchTerm.toLowerCase();
				return (
					block.title.toLowerCase().includes( search ) ||
					block.name.toLowerCase().includes( search )
				);
			}
			return true;
		} );

		blocks.sort( ( a, b ) => {
			const aPriority = PRIORITY_BLOCKS.indexOf( a.name );
			const bPriority = PRIORITY_BLOCKS.indexOf( b.name );
			if ( aPriority !== -1 && bPriority !== -1 ) return aPriority - bPriority;
			if ( aPriority !== -1 ) return -1;
			if ( bPriority !== -1 ) return 1;
			return a.title.localeCompare( b.title );
		} );

		return blocks;
	}, [ blockTypes, searchTerm ] );

	// Reset page when search changes
	useEffect( () => {
		setCurrentPage( 1 );
	}, [ searchTerm ] );

	const { priorityBlocks, otherBlocks, paginatedOtherBlocks, totalPages } = useMemo( () => {
		const priority = [];
		const other = [];
		filteredBlocks.forEach( ( block ) => {
			if ( PRIORITY_BLOCKS.includes( block.name ) ) {
				priority.push( block );
			} else {
				other.push( block );
			}
		} );

		// Paginate "other" blocks only (priority blocks always show)
		const startIndex = ( currentPage - 1 ) * BLOCKS_PER_PAGE;
		const endIndex = startIndex + BLOCKS_PER_PAGE;
		const paginated = other.slice( startIndex, endIndex );
		const pages = Math.ceil( other.length / BLOCKS_PER_PAGE );

		return {
			priorityBlocks: priority,
			otherBlocks: other,
			paginatedOtherBlocks: paginated,
			totalPages: pages,
		};
	}, [ filteredBlocks, currentPage ] );

	/**
	 * Check if a block has meaningful guidelines configured.
	 *
	 * @param {string} blockName Block name.
	 * @return {string|null} Status text or null.
	 */
	const getBlockStatus = ( blockName ) => {
		const guidelines = blockGuidelines[ blockName ];
		if ( ! guidelines ) {
			return null;
		}

		// Check if there's any actual content
		const hasCopyRules =
			( guidelines.copy_rules?.dos?.length > 0 ) ||
			( guidelines.copy_rules?.donts?.length > 0 );
		const hasNotes = guidelines.notes && guidelines.notes.trim().length > 0;

		if ( hasCopyRules || hasNotes ) {
			return __( 'Configured', 'content-guidelines' );
		}

		return null;
	};

	// Show loading state.
	if ( isLoading ) {
		return (
			<div className="blocks-panel">
				<div className="blocks-panel__loading">
					<Spinner />
					<Text variant="muted">
						{ __( 'Loading blocks', 'content-guidelines' ) }
					</Text>
				</div>
			</div>
		);
	}

	// Show error state.
	if ( error ) {
		return (
			<div className="blocks-panel">
				<div className="blocks-panel__loading">
					<Text className="blocks-panel__error">
						{ error }
					</Text>
					<Button
						variant="secondary"
						onClick={ () => window.location.reload() }
					>
						{ __( 'Retry', 'content-guidelines' ) }
					</Button>
				</div>
			</div>
		);
	}

	return (
		<div className="blocks-panel">
			<Navigator initialPath={ selectedBlock ? '/block' : '/' }>
				<Navigator.Screen path="/">
					<div className="blocks-panel__content">
						<div className="blocks-panel__search">
							<SearchControl
								__nextHasNoMarginBottom
								value={ searchTerm }
								onChange={ setSearchTerm }
								placeholder={ __( 'Search blocks', 'content-guidelines' ) }
							/>
						</div>

						{ priorityBlocks.length > 0 && (
							<div className="blocks-panel__section">
								<h2 className="blocks-panel__list-title">
									{ __( 'Common', 'content-guidelines' ) }
								</h2>
								<ul role="list" className="blocks-panel__list">
									{ priorityBlocks.map( ( block ) => (
										<li key={ block.name } className="blocks-panel__list-item">
											<BlockCard
												block={ block }
												variantsText={ getBlockStatus( block.name ) }
												navigatorPath="/block"
												onClick={ () => handleBlockSelect( block ) }
											/>
										</li>
									) ) }
								</ul>
							</div>
						) }

						{ otherBlocks.length > 0 && (
							<div className="blocks-panel__section">
								<h2 className="blocks-panel__list-title">
									{ __( 'All Blocks', 'content-guidelines' ) }
									<span className="blocks-panel__list-count">
										{ otherBlocks.length }
									</span>
								</h2>
								<ul role="list" className="blocks-panel__list">
									{ paginatedOtherBlocks.map( ( block ) => (
										<li key={ block.name } className="blocks-panel__list-item">
											<BlockCard
												block={ block }
												variantsText={ getBlockStatus( block.name ) }
												navigatorPath="/block"
												onClick={ () => handleBlockSelect( block ) }
											/>
										</li>
									) ) }
								</ul>
								{ totalPages > 1 && (
									<div className="blocks-panel__pagination">
										<Button
											variant="secondary"
											size="small"
											disabled={ currentPage === 1 }
											onClick={ () => setCurrentPage( currentPage - 1 ) }
										>
											{ __( 'Previous', 'content-guidelines' ) }
										</Button>
										<span className="blocks-panel__pagination-info">
											{ currentPage } / { totalPages }
										</span>
										<Button
											variant="secondary"
											size="small"
											disabled={ currentPage === totalPages }
											onClick={ () => setCurrentPage( currentPage + 1 ) }
										>
											{ __( 'Next', 'content-guidelines' ) }
										</Button>
									</div>
								) }
							</div>
						) }

						{ filteredBlocks.length === 0 && (
							<Text variant="muted" className="blocks-panel__empty">
								{ __( 'No blocks found.', 'content-guidelines' ) }
							</Text>
						) }
					</div>
				</Navigator.Screen>

				<Navigator.Screen path="/block">
					<BlockDetailScreen
						block={ selectedBlock }
						onBack={ handleBack }
					/>
				</Navigator.Screen>
			</Navigator>
		</div>
	);
}
</file>

<file path="src/components/library-panel/style.scss">
// Library panel styles - matching fonts library pattern

.library-panel {
	display: flex;
	flex-direction: column;
	height: 100%;
}

// Draft notice
.library-panel__notice {
	max-width: 640px;
	margin: 24px auto 0;
	border-radius: 2px;
}

// Section list container
.library-panel__list {
	list-style: none;
	margin: 0 auto;
	padding: 0;
	min-width: 400px;
	max-width: 640px;
	width: 100%;
	border: 1px solid #e0e0e0;
}

.library-panel__list-item {
	border-bottom: 1px solid #e0e0e0;

	&:last-child {
		border-bottom: none;
	}
}

// Section card button - table style
.library-panel__section-card {
	box-sizing: border-box;
	width: 100%;
	height: auto !important;
	padding: 16px;
	background: #fff;
	border: none;
	border-radius: 0;
	cursor: pointer;
	text-align: left;

	&:hover {
		background: #f8f8f8;
	}

	&:focus {
		position: relative;
		box-shadow: inset 0 0 0 1.5px var(--wp-admin-theme-color, #3858e9);
		outline: none;
	}

	.components-flex {
		width: 100%;
	}
}

.library-panel__section-title {
	font-size: 14px;
	font-weight: 600;
	color: #1e1e1e;
}

.library-panel__section-description {
	font-size: 12px;
	color: #757575;
}

.library-panel__section-status {
	font-size: 12px;
	color: #757575;
}

// Chevron icon
.library-panel__section-card svg {
	fill: #757575;
	flex-shrink: 0;
}

// Navigator screens
.library-panel .components-navigator-provider {
	display: flex;
	flex-direction: column;
	flex-grow: 1;
}

.library-panel .components-navigator-screen {
	padding: 24px;
	width: 100%;
	box-sizing: border-box;
}

// Detail screen content container
.library-panel__detail-container {
	max-width: 640px;
	margin: 0 auto;
}

// Detail screen header
.library-panel__detail-title {
	font-size: 13px;
	font-weight: 500;
	margin: 0;
}

// Back button area
.library-panel .components-navigator__back-button {
	margin-right: 8px;
}

// Form controls in detail view
.library-panel .components-textarea-control,
.library-panel .components-text-control,
.library-panel .components-select-control {
	.components-base-control__label {
		font-size: 12px;
		font-weight: 500;
		color: #1e1e1e;
	}

	.components-base-control__help {
		font-size: 12px;
		color: #757575;
		margin-top: 4px;
	}

	input,
	textarea,
	select {
		font-size: 13px;
	}
}

.library-panel .components-form-token-field__label {
	font-size: 12px;
	font-weight: 500;
	color: #1e1e1e;
}

// Override WP admin default margins
.library-panel dd,
.library-panel li {
	margin-bottom: 0;
}

// Divider with centered text
.library-panel__divider {
	display: flex;
	align-items: center;
	gap: 12px;
	margin: 8px 0;

	&::before,
	&::after {
		content: "";
		flex: 1;
		height: 1px;
		background: #dcdcde;
	}
}

.library-panel__divider-text {
	font-size: 11px;
	font-weight: 500;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	color: #949494;
	white-space: nowrap;
}

// Reference items
.library-panel__reference-item {
	padding: 12px;
	background: #f6f7f7;
	border: 1px solid #e0e0e0;
	border-radius: 2px;
}

// Image grid
.library-panel__image-grid {
	display: grid;
	grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
	gap: 12px;
}

.library-panel__image-item {
	display: flex;
	flex-direction: column;
	gap: 8px;
	padding: 8px;
	background: #f6f7f7;
	border: 1px solid #e0e0e0;
	border-radius: 2px;

	img {
		width: 100%;
		height: 100px;
		object-fit: cover;
		border-radius: 2px;
	}

	.components-text-control__input {
		font-size: 12px;
	}
}
</file>

<file path="src/components/playground/style.scss">
/**
 * Playground Styles
 */

.content-guidelines-playground {
	padding: 24px;
	min-width: 400px;
	max-width: 640px;
	width: 100%;
	margin: 24px auto;
	box-sizing: border-box;
	border: 1px solid #e0e0e0;
	border-radius: 2px;
}

.content-guidelines-playground__controls {
	display: flex;
	flex-direction: column;
	gap: 12px;
	margin-bottom: 24px;

	.components-toggle-control {
		margin-bottom: 0;
	}

	.components-button.is-primary {
		align-self: flex-start;
	}
}

.content-guidelines-playground__note {
	font-size: 13px;
	color: #757575;
	margin: 0;
}

.content-guidelines-playground__loading {
	display: flex;
	flex-direction: column;
	align-items: center;
	padding: 32px;
	color: #757575;

	.components-spinner {
		margin-bottom: 12px;
	}
}

.content-guidelines-playground__results {
	.components-panel__body {
		border: 1px solid #e0e0e0;
		margin-bottom: 12px;
	}
}

.content-guidelines-playground__compare {
	margin-top: 16px;
	padding-top: 16px;
	border-top: 1px dashed #e0e0e0;

	h4 {
		margin: 0 0 12px;
		font-size: 13px;
		color: #757575;
		text-transform: uppercase;
	}
}

.content-guidelines-playground__ai-result {
	padding: 12px;
	background: #f6f7f7;
	border-radius: 4px;
	font-size: 14px;
	line-height: 1.6;
	white-space: pre-wrap;
}

.content-guidelines-playground__alternatives {
	margin-top: 16px;

	h5 {
		margin: 0 0 8px;
		font-size: 12px;
		color: #757575;
	}

	ul {
		margin: 0;
		padding-left: 20px;
	}

	li {
		margin-bottom: 4px;
	}
}

// Lint Panel
.content-guidelines-lint__success {
	color: #1e4620;
	margin: 0;
}

.content-guidelines-lint__section-title {
	margin: 0 0 8px;
	font-size: 12px;
	font-weight: 600;
	text-transform: uppercase;
	color: #757575;
}

.content-guidelines-lint__list {
	list-style: none;
	margin: 0 0 16px;
	padding: 0;
}

.content-guidelines-lint__item {
	display: flex;
	gap: 8px;
	padding: 8px 0;
	border-bottom: 1px solid #f0f0f0;

	&:last-child {
		border-bottom: none;
	}
}

.content-guidelines-lint__icon {
	flex-shrink: 0;
}

.content-guidelines-lint__content {
	display: flex;
	flex-direction: column;
	gap: 2px;
}

.content-guidelines-lint__message {
	font-size: 14px;
}

.content-guidelines-lint__note {
	font-size: 12px;
	color: #757575;
}

.content-guidelines-lint__stats {
	margin-top: 16px;
	padding-top: 16px;
	border-top: 1px solid #f0f0f0;
}

.content-guidelines-lint__stats-list {
	display: grid;
	grid-template-columns: auto 1fr;
	gap: 4px 16px;
	margin: 0;
	font-size: 13px;

	dt {
		color: #757575;
	}

	dd {
		margin: 0;
		font-weight: 500;
	}
}

// Context Preview
.content-guidelines-context-preview__description {
	margin: 0 0 12px;
	font-size: 13px;
	color: #757575;
}

.content-guidelines-context-preview__meta {
	display: flex;
	gap: 16px;
	margin-bottom: 12px;
	font-size: 11px;
	color: #757575;
}

.content-guidelines-context-preview__text {
	padding: 12px;
	background: #f6f7f7;
	border: 1px solid #e0e0e0;
	border-radius: 4px;
	font-size: 12px;
	line-height: 1.5;
	overflow-x: auto;
	max-height: 300px;
	overflow-y: auto;
	white-space: pre-wrap;
	word-break: break-word;
}

.content-guidelines-context-preview__actions {
	margin-top: 8px;
}

.content-guidelines-context-preview__structured {
	margin-top: 16px;

	summary {
		cursor: pointer;
		font-size: 12px;
		color: #0073aa;

		&:hover {
			text-decoration: underline;
		}
	}

	pre {
		margin-top: 8px;
		padding: 8px;
		background: #f0f0f0;
		font-size: 11px;
		overflow-x: auto;
	}
}
</file>

<file path="src/components/blocks-panel/style.scss">
// Blocks panel styles - matching fonts library pattern

.blocks-panel {
	display: flex;
	flex-direction: column;
	height: 100%;
}

// Content container - centered with max-width
.blocks-panel__content {
	max-width: 640px;
	margin: 0 auto;
	padding: 24px;
	width: 100%;
	box-sizing: border-box;
}

// Search container
.blocks-panel__search {
	margin-bottom: 24px;

	.components-search-control {
		width: 100%;
	}
}

// Section container (Common, All Blocks)
.blocks-panel__section {
	margin-bottom: 24px;

	&:last-child {
		margin-bottom: 0;
	}
}

// List title (Common, All Blocks)
.blocks-panel__list-title {
	font-size: 11px;
	font-weight: 600;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	color: #1e1e1e;
	margin: 0 0 8px;
	padding: 0;
}

// Block list
.blocks-panel__list {
	list-style: none;
	margin: 0;
	padding: 0;
	min-width: 400px;
	max-width: 640px;
	width: 100%;
	border: 1px solid #e0e0e0;
}

.blocks-panel__list-item {
	border-bottom: 1px solid #e0e0e0;
	margin: 0;
	padding: 0;

	&:last-child {
		border-bottom: none;
	}
}

// Block card button - table style
.blocks-panel__block-card {
	box-sizing: border-box;
	display: block;
	width: 100%;
	height: auto !important;
	padding: 12px 16px;
	margin: 0;
	background: transparent;
	border: none;
	border-radius: 0;
	cursor: pointer;
	text-align: left;

	&:hover {
		background: #f6f7f7;
	}

	&:focus {
		position: relative;
		box-shadow: inset 0 0 0 1.5px var(--wp-admin-theme-color, #3858e9);
		outline: none;
	}

	.components-flex {
		width: 100%;
	}
}

.blocks-panel__block-title {
	font-size: 13px;
	font-weight: 600;
	color: #1e1e1e;
}

.blocks-panel__block-status {
	font-size: 12px;
	color: var(--wp-admin-theme-color, #3858e9);
}

// Chevron icon
.blocks-panel__block-card svg {
	fill: #757575;
	flex-shrink: 0;
}

// Navigator screens
.blocks-panel .components-navigator-provider {
	display: flex;
	flex-direction: column;
	flex-grow: 1;
}

.blocks-panel .components-navigator-screen {
	padding: 0;
	width: 100%;
	box-sizing: border-box;
}

// Detail screen container
.blocks-panel__detail-container {
	max-width: 640px;
	margin: 0 auto;
	padding: 24px;
}

// Detail screen header
.blocks-panel__detail-title {
	font-size: 13px;
	font-weight: 500;
	margin: 0;
}

// Block preview card
.blocks-panel__block-preview {
	display: flex;
	gap: 12px;
	padding: 16px;
	background: #f6f7f7;
	border: 1px solid #e0e0e0;
	border-radius: 2px;
}

.blocks-panel__block-icon {
	flex-shrink: 0;
	width: 48px;
	height: 48px;
	display: flex;
	align-items: center;
	justify-content: center;
	background: #fff;
	border: 1px solid #e0e0e0;
	border-radius: 2px;

	svg {
		width: 24px;
		height: 24px;
		fill: #1e1e1e;
	}

	&.dashicons {
		font-size: 24px;
		color: #1e1e1e;
	}
}

.blocks-panel__block-info {
	display: flex;
	flex-direction: column;
	gap: 4px;
	min-width: 0;
}

.blocks-panel__block-name {
	font-size: 11px;
	font-family: monospace;
	color: #757575;
}

.blocks-panel__block-description {
	font-size: 13px;
	line-height: 1.4;
}

// Divider with centered text
.blocks-panel__divider {
	display: flex;
	align-items: center;
	gap: 12px;
	margin: 8px 0;

	&::before,
	&::after {
		content: "";
		flex: 1;
		height: 1px;
		background: #dcdcde;
	}
}

.blocks-panel__divider-text {
	font-size: 11px;
	font-weight: 500;
	text-transform: uppercase;
	letter-spacing: 0.5px;
	color: #949494;
	white-space: nowrap;
}

// Back button area
.blocks-panel .components-navigator__back-button {
	margin-right: 8px;
}

// Form controls in detail view
.blocks-panel .components-textarea-control {
	.components-base-control__label {
		font-size: 11px;
		font-weight: 500;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		color: #757575;
	}

	textarea {
		font-size: 13px;
	}
}

// Loading state - centered in container
.blocks-panel__loading {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: center;
	padding: 48px 24px;
	gap: 16px;
	flex-grow: 1;
	min-height: 300px;
}

// Error state
.blocks-panel__error {
	color: #cc1818;
}

// Override WP admin default margins
.blocks-panel dd,
.blocks-panel li {
	margin-bottom: 0;
}

// Empty state
.blocks-panel__empty {
	text-align: center;
	padding: 24px;
	color: #757575;
}

// Block count badge
.blocks-panel__list-count {
	font-size: 11px;
	font-weight: 400;
	color: #757575;
	margin-left: 8px;
}

// Pagination
.blocks-panel__pagination {
	display: flex;
	align-items: center;
	justify-content: center;
	gap: 12px;
	padding: 16px;
	border-top: 1px solid #e0e0e0;
}

.blocks-panel__pagination-info {
	font-size: 13px;
	color: #757575;
	min-width: 50px;
	text-align: center;
}
</file>

</files>
